<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Provisioning Amazon Client VPN with Terraform | Tomas Balza</title>
<meta name=keywords content="terraform,aws,vpn,vpc,acm"><meta name=description content="In this article we&rsquo;ll provision an AWS Client VPN, mimicking a typical scenario used when accessing corporate networks securely. All done in a single step."><meta name=author content><link rel=canonical href=https://tbalza.net/provisioning-amazon-client-vpn-with-terraform/><link crossorigin=anonymous href=/assets/css/stylesheet.befb480beb9ffd243cbfb441ccad97d0a74979a7331cdc9d7df0be5b7059d9c2.css integrity="sha256-vvtIC+uf/SQ8v7RBzK2X0KdJeaczHNydffC+W3BZ2cI=" rel="preload stylesheet" as=style><link rel=icon href=https://tbalza.net/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://tbalza.net/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://tbalza.net/favicon-32x32.png><link rel=apple-touch-icon href=https://tbalza.net/apple-touch-icon.png><link rel=mask-icon href=https://tbalza.net/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://tbalza.net/provisioning-amazon-client-vpn-with-terraform/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Provisioning Amazon Client VPN with Terraform"><meta property="og:description" content="In this article we&rsquo;ll provision an AWS Client VPN, mimicking a typical scenario used when accessing corporate networks securely. All done in a single step."><meta property="og:type" content="article"><meta property="og:url" content="https://tbalza.net/provisioning-amazon-client-vpn-with-terraform/"><meta property="og:image" content="https://tbalza.net/posts/aws_vpn/cover.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-11-20T00:00:00+00:00"><meta property="article:modified_time" content="2024-11-20T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://tbalza.net/posts/aws_vpn/cover.jpg"><meta name=twitter:title content="Provisioning Amazon Client VPN with Terraform"><meta name=twitter:description content="In this article we&rsquo;ll provision an AWS Client VPN, mimicking a typical scenario used when accessing corporate networks securely. All done in a single step."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://tbalza.net/posts/"},{"@type":"ListItem","position":2,"name":"Provisioning Amazon Client VPN with Terraform","item":"https://tbalza.net/provisioning-amazon-client-vpn-with-terraform/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Provisioning Amazon Client VPN with Terraform","name":"Provisioning Amazon Client VPN with Terraform","description":"In this article we\u0026rsquo;ll provision an AWS Client VPN, mimicking a typical scenario used when accessing corporate networks securely. All done in a single step.","keywords":["terraform","aws","vpn","vpc","acm"],"articleBody":" In this article we’ll provision an AWS Client VPN, mimicking a typical scenario used when accessing corporate networks securely. All done in a single step without having to access the AWS Console, or manually generating/copying certificates.\nYou can find the code in the GitHub repository.\nGetting started We can first clone the repo:\ngit clone git@github.com:tbalza/aws-vpn.git \u0026\u0026 \\ cd aws-vpn And with AWS CLI and Terraform installed run:\nterraform init \u0026\u0026 \\ terraform apply After around 10 minutes the VPN Endpoint will be configured and operational:\nTerraform will generate a client-configuration.ovpn file in the project directory, which contains the complete authentication config.\nWith AWS VPN Client installed we can then go to File \u003e Manage Properties, create a profile, and select that file to connect to our newly created VPN endpoint.\nDone! Once connected we’ll be able to access our private subnets securely. Since the VPN Endpoint is configured with a split-tunnel, only traffic related to AWS will be forwarded, improving performance and avoiding unnecessary costs.\nResources without a public IP are now reachable from our local machine.\nNow that we’ve successfully connected, let’s take a look under the hood to see how Terraform is configured.\nVPC module \"vpc\" { source = \"terraform-aws-modules/vpc/aws\" version = \"5.16.0\" name = \"VPC\" cidr = \"10.1.0.0/16\" azs = [\"us-east-1a\", \"us-east-1b\"] private_subnets = [\"10.1.1.0/24\", \"10.1.3.0/24\"] } Leveraging the terraform-aws-vpc module we can quickly configure our VPC with private subnets and corresponding route tables.\nVPN VPN Endpoint locals { client_cidr = \"192.168.68.0/22\" } resource \"aws_ec2_client_vpn_endpoint\" \"cvpn\" { description = \"Client VPN Endpoint\" server_certificate_arn = aws_acm_certificate.server_cert.arn client_cidr_block = local.client_cidr # check split_tunnel = \"true\" security_group_ids = [module.cvpn_access_security_group.security_group_id] vpc_id = module.vpc.vpc_id self_service_portal = \"disabled\" authentication_options { type = \"certificate-authentication\" root_certificate_chain_arn = aws_acm_certificate.server_cert.arn } connection_log_options { enabled = false } } Here we create the VPN Endpoint with split-tunnel and “Mutual Authentication” which uses certificates for access control. Making the use of ACM we can streamline the setup for this scenario. The client cidr argument refers to the IP range connected remote workers will have, which is separate from the subnet range.\nVPN/VPC Association resource \"aws_ec2_client_vpn_authorization_rule\" \"authorize_cvpn_vpc\" { client_vpn_endpoint_id = aws_ec2_client_vpn_endpoint.cvpn.id target_network_cidr = module.vpc.vpc_cidr_block # check authorize_all_groups = true } After the endpoint gets created, it needs to be associated with the VPC. This can take around 10 minutes to complete.\nSubnet Association resource \"aws_ec2_client_vpn_network_association\" \"associate_subnet\" { for_each = {for idx, subnet in module.vpc.private_subnets : idx =\u003e subnet} # converts list to map client_vpn_endpoint_id = aws_ec2_client_vpn_endpoint.cvpn.id subnet_id = each.value } Additionally, subnets also have to be associated. Here, we go through the VPC module’s list recursively and convert them to a map to uniquely identify entries.\nSecurity Group module \"cvpn_access_security_group\" { source = \"terraform-aws-modules/security-group/aws\" version = \"5.2.0\" name = \"cvpn_access_security_group\" description = \"Security group for CVPN Access\" vpc_id = module.vpc.vpc_id computed_ingress_with_cidr_blocks = [ { description = \"VPN TLS\" from_port = 443 to_port = 443 protocol = \"udp\" cidr_blocks = \"0.0.0.0/0\" } ] number_of_computed_ingress_with_cidr_blocks = 1 egress_with_cidr_blocks = [ { description = \"All\" from_port = -1 to_port = -1 protocol = -1 cidr_blocks = \"0.0.0.0/0\" } ] } As with most resources in AWS, the VPN will not be accessible by default. This security group allows clients/users secure access from the internet.\nCertificates CA # Creates CA private key resource \"tls_private_key\" \"ca_key\" { algorithm = \"RSA\" rsa_bits = 2048 } # Creates a self-signed CA TLS certificate in PEM format resource \"tls_self_signed_cert\" \"ca_cert\" { private_key_pem = tls_private_key.ca_key.private_key_pem subject { common_name = \"ca.${var.domain_name}\" } is_ca_certificate = true # can be used to sign other certificates and control certificate revocation lists validity_period_hours = 87600 allowed_uses = [ \"cert_signing\", \"crl_signing\", ] } Leveraging ACM and using the tls provider we can use self-signed certificates, simplifying the process as we’ll assume we don’t need a custom Certificate Authority in this example. This provider replaces the use of easyrsa and makes our configuration self-contained and dynamic.\nServer # Creates server private key resource \"tls_private_key\" \"server_key\" { algorithm = \"RSA\" rsa_bits = 2048 } # Generates server CSR used to request cert from CA resource \"tls_cert_request\" \"server_req\" { private_key_pem = tls_private_key.server_key.private_key_pem subject { common_name = \"vpn.${var.domain_name}\" } } # Creates server certificate signed by a CA resource \"tls_locally_signed_cert\" \"server_cert\" { cert_request_pem = tls_cert_request.server_req.cert_request_pem ca_private_key_pem = tls_private_key.ca_key.private_key_pem ca_cert_pem = tls_self_signed_cert.ca_cert.cert_pem validity_period_hours = 87600 allowed_uses = [ \"key_encipherment\", \"digital_signature\", \"server_auth\", ] } # Uploads server certificate to ACM (used by AWS Client VPN) resource \"aws_acm_certificate\" \"server_cert\" { private_key = tls_private_key.server_key.private_key_pem certificate_body = tls_locally_signed_cert.server_cert.cert_pem certificate_chain = tls_self_signed_cert.ca_cert.cert_pem } Here we create the self-signed server certificate and upload it to ACM.\nClient # Creates client private key resource \"tls_private_key\" \"client_key\" { algorithm = \"RSA\" rsa_bits = 2048 } # Generates client CSR used to request cert from CA resource \"tls_cert_request\" \"client_req\" { private_key_pem = tls_private_key.client_key.private_key_pem subject { common_name = \"client.${var.domain_name}\" } } # Creates client certificate signed by a CA resource \"tls_locally_signed_cert\" \"client_cert\" { cert_request_pem = tls_cert_request.client_req.cert_request_pem ca_private_key_pem = tls_private_key.ca_key.private_key_pem ca_cert_pem = tls_self_signed_cert.ca_cert.cert_pem validity_period_hours = 87600 allowed_uses = [ \"client_auth\" ] } Finally, we create the client certificate, which is needed to complete the Client VPN endpoint configuration file used for authentication.\nClient Configuration resource \"null_resource\" \"download_cvpn_config\" { depends_on = [aws_ec2_client_vpn_endpoint.cvpn] provisioner \"local-exec\" { command = \u003c\u003cEOF #!/bin/bash set -e # Exit on error # Export the VPN configuration aws ec2 export-client-vpn-client-configuration --client-vpn-endpoint-id ${aws_ec2_client_vpn_endpoint.cvpn.id} --output text \u003e ./client-config.ovpn # Embed the client certificate echo '\u003ccert\u003e' \u003e\u003e ./client-config.ovpn echo \"${tls_locally_signed_cert.client_cert.cert_pem}\" \u003e\u003e ./client-config.ovpn echo '\u003c/cert\u003e' \u003e\u003e ./client-config.ovpn # Embed the private key echo '\u003ckey\u003e' \u003e\u003e ./client-config.ovpn echo \"${tls_private_key.client_key.private_key_pem}\" \u003e\u003e ./client-config.ovpn echo '\u003c/key\u003e' \u003e\u003e ./client-config.ovpn EOF interpreter = [\"/bin/bash\", \"-c\"] } triggers = { always_run = \"${timestamp()}\" } } This last code block uses the local-exec provisioner to automatically prepare the Client VPN endpoint configuration file without having to manually download it via the AWS Console and adding the client certification data.\nConclusions We’ve reviewed a Terraform configuration that simplifies the AWS Client VPN deployment. This setup demonstrates a workflow in the spirit of best practices, reducing overhead and human error by declaratively defining our infrastructure.\n","wordCount":"993","inLanguage":"en","image":"https://tbalza.net/posts/aws_vpn/cover.jpg","datePublished":"2024-11-20T00:00:00Z","dateModified":"2024-11-20T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://tbalza.net/provisioning-amazon-client-vpn-with-terraform/"},"publisher":{"@type":"Organization","name":"Tomas Balza","logo":{"@type":"ImageObject","url":"https://tbalza.net/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://tbalza.net/ accesskey=h title="Tomas Balza (Alt + H)"><img src=https://tbalza.net/profile-photo-2.jpg alt aria-label=logo height=35>Tomas Balza<p id=subtitle>DevOps / Tech Articles</p></a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://github.com/tbalza title=GitHub><span>GitHub</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://www.linkedin.com/in/tomas-balza title=LinkedIn><span>LinkedIn</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://www.youtube.com/@tbalza-tech/videos title=YouTube><span>YouTube</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Provisioning Amazon Client VPN with Terraform</h1><div class=post-meta><span title='2024-11-20 00:00:00 +0000 UTC'>November, 2024</span>&nbsp;&nbsp;&nbsp;<a href=/tags/terraform> terraform</a> <a href=/tags/aws>aws</a> <a href=/tags/vpn>vpn</a> <a href=/tags/vpc>vpc</a> <a href=/tags/acm>acm</a></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#getting-started aria-label="Getting started">Getting started</a></li><li><a href=#vpc aria-label=VPC>VPC</a></li><li><a href=#vpn aria-label=VPN>VPN</a><ul><li><a href=#vpn-endpoint aria-label="VPN Endpoint">VPN Endpoint</a></li><li><a href=#vpnvpc-association aria-label="VPN/VPC Association">VPN/VPC Association</a></li><li><a href=#subnet-association aria-label="Subnet Association">Subnet Association</a></li></ul></li><li><a href=#security-group aria-label="Security Group">Security Group</a></li><li><a href=#certificates aria-label=Certificates>Certificates</a><ul><li><a href=#ca aria-label=CA>CA</a></li><li><a href=#server aria-label=Server>Server</a></li><li><a href=#client aria-label=Client>Client</a></li></ul></li><li><a href=#client-configuration aria-label="Client Configuration">Client Configuration</a></li><li><a href=#conclusions aria-label=Conclusions>Conclusions</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"),document.querySelectorAll(".inner ul li a").forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();const t=this.getAttribute("href").slice(1),n=document.getElementById(t);window.scrollTo({top:getOffsetTop(n)-75,behavior:"smooth"})})})},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset-60>0&&getOffsetTop(e)-window.pageYOffset-60<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.scrollY}</script><div class=post-content><p><img loading=lazy src=/posts/aws_vpn/diagram.jpg alt=diagram></p><p>In this article we&rsquo;ll provision an AWS Client VPN, mimicking a typical scenario used when accessing corporate networks securely. All done in a single step without having to access the AWS Console, or manually generating/copying certificates.</p><p>You can find the code in the <a href=https://github.com/tbalza/aws-vpn>GitHub repository</a>.</p><h3 id=getting-started>Getting started<a hidden class=anchor aria-hidden=true href=#getting-started>#</a></h3><p>We can first clone the repo:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git clone git@github.com:tbalza/aws-vpn.git <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=nb>cd</span> aws-vpn
</span></span></code></pre></div><p>And with AWS CLI and Terraform installed run:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>terraform init <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>terraform apply
</span></span></code></pre></div><p>After around 10 minutes the VPN Endpoint will be configured and operational:</p><p><img loading=lazy src=/posts/aws_vpn/apply.png alt=apply></p><p>Terraform will generate a <code>client-configuration.ovpn</code> file in the project directory, which contains the complete authentication config.</p><p>With <a href=https://aws.amazon.com/vpn/client-vpn-download/>AWS VPN Client</a> installed we can then go to <code>File > Manage Properties</code>, create a profile, and select that file to connect to our newly created VPN endpoint.</p><p><img loading=lazy src=/posts/aws_vpn/aws-vpn-client.png alt=client></p><p>Done! Once connected we&rsquo;ll be able to access our private subnets securely. Since the VPN Endpoint is configured with a <code>split-tunnel</code>, only traffic related to AWS will be forwarded, improving performance and avoiding unnecessary costs.</p><p><img loading=lazy src=/posts/aws_vpn/ec2.png alt=ec2></p><p>Resources without a public IP are now reachable from our local machine.</p><p><img loading=lazy src=/posts/aws_vpn/ping.png alt=ping></p><p>Now that we&rsquo;ve successfully connected, let&rsquo;s take a look under the hood to see how Terraform is configured.</p><h3 id=vpc>VPC<a hidden class=anchor aria-hidden=true href=#vpc>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>module</span> <span class=s2>&#34;vpc&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  source</span>  <span class=o>=</span> <span class=s2>&#34;terraform-aws-modules/vpc/aws&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  version</span> <span class=o>=</span> <span class=s2>&#34;5.16.0&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  name</span> <span class=o>=</span> <span class=s2>&#34;VPC&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  cidr</span> <span class=o>=</span> <span class=s2>&#34;10.1.0.0/16&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  azs</span>             <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;us-east-1a&#34;, &#34;us-east-1b&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>  private_subnets</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;10.1.1.0/24&#34;, &#34;10.1.3.0/24&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>Leveraging the <code>terraform-aws-vpc</code> module we can quickly configure our VPC with private subnets and corresponding route tables.</p><h3 id=vpn>VPN<a hidden class=anchor aria-hidden=true href=#vpn>#</a></h3><h4 id=vpn-endpoint>VPN Endpoint<a hidden class=anchor aria-hidden=true href=#vpn-endpoint>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>locals</span> {
</span></span><span class=line><span class=cl><span class=n>  client_cidr</span> <span class=o>=</span> <span class=s2>&#34;192.168.68.0/22&#34;</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;aws_ec2_client_vpn_endpoint&#34; &#34;cvpn&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  description</span>            <span class=o>=</span> <span class=s2>&#34;Client VPN Endpoint&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  server_certificate_arn</span> <span class=o>=</span> <span class=k>aws_acm_certificate</span><span class=p>.</span><span class=k>server_cert</span><span class=p>.</span><span class=k>arn</span>
</span></span><span class=line><span class=cl><span class=n>  client_cidr_block</span>      <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>client_cidr</span><span class=c1> # check
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  split_tunnel</span>           <span class=o>=</span> <span class=s2>&#34;true&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  security_group_ids</span>     <span class=o>=</span> <span class=p>[</span><span class=k>module</span><span class=p>.</span><span class=k>cvpn_access_security_group</span><span class=p>.</span><span class=k>security_group_id</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>  vpc_id</span>                 <span class=o>=</span> <span class=k>module</span><span class=p>.</span><span class=k>vpc</span><span class=p>.</span><span class=k>vpc_id</span>
</span></span><span class=line><span class=cl><span class=n>  self_service_portal</span>    <span class=o>=</span> <span class=s2>&#34;disabled&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>authentication_options</span> {
</span></span><span class=line><span class=cl><span class=n>    type</span>                       <span class=o>=</span> <span class=s2>&#34;certificate-authentication&#34;</span>
</span></span><span class=line><span class=cl><span class=n>    root_certificate_chain_arn</span> <span class=o>=</span> <span class=k>aws_acm_certificate</span><span class=p>.</span><span class=k>server_cert</span><span class=p>.</span><span class=k>arn</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>connection_log_options</span> {
</span></span><span class=line><span class=cl><span class=n>    enabled</span> <span class=o>=</span> <span class=kt>false</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>Here we create the VPN Endpoint with split-tunnel and &ldquo;Mutual Authentication&rdquo; which uses certificates for access control. Making the use of ACM we can streamline the setup for this scenario. The client cidr argument refers to the IP range connected remote workers will have, which is separate from the subnet range.</p><h4 id=vpnvpc-association>VPN/VPC Association<a hidden class=anchor aria-hidden=true href=#vpnvpc-association>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;aws_ec2_client_vpn_authorization_rule&#34; &#34;authorize_cvpn_vpc&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  client_vpn_endpoint_id</span> <span class=o>=</span> <span class=k>aws_ec2_client_vpn_endpoint</span><span class=p>.</span><span class=k>cvpn</span><span class=p>.</span><span class=k>id</span>
</span></span><span class=line><span class=cl><span class=n>  target_network_cidr</span>    <span class=o>=</span> <span class=k>module</span><span class=p>.</span><span class=k>vpc</span><span class=p>.</span><span class=k>vpc_cidr_block</span><span class=c1> # check
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  authorize_all_groups</span>   <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>After the endpoint gets created, it needs to be associated with the VPC. This can take around 10 minutes to complete.</p><h4 id=subnet-association>Subnet Association<a hidden class=anchor aria-hidden=true href=#subnet-association>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;aws_ec2_client_vpn_network_association&#34; &#34;associate_subnet&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  for_each</span>               <span class=o>=</span><span class=n> {for idx, subnet in module.vpc.private_subnets : idx</span> <span class=o>=</span><span class=err>&gt;</span> <span class=k>subnet</span>}<span class=c1> # converts list to map
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  client_vpn_endpoint_id</span> <span class=o>=</span> <span class=k>aws_ec2_client_vpn_endpoint</span><span class=p>.</span><span class=k>cvpn</span><span class=p>.</span><span class=k>id</span>
</span></span><span class=line><span class=cl><span class=n>  subnet_id</span>              <span class=o>=</span> <span class=k>each</span><span class=p>.</span><span class=k>value</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>Additionally, subnets also have to be associated. Here, we go through the VPC module&rsquo;s list recursively and convert them to a map to uniquely identify entries.</p><h3 id=security-group>Security Group<a hidden class=anchor aria-hidden=true href=#security-group>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>module</span> <span class=s2>&#34;cvpn_access_security_group&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  source</span>  <span class=o>=</span> <span class=s2>&#34;terraform-aws-modules/security-group/aws&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  version</span> <span class=o>=</span> <span class=s2>&#34;5.2.0&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  name</span>        <span class=o>=</span> <span class=s2>&#34;cvpn_access_security_group&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  description</span> <span class=o>=</span> <span class=s2>&#34;Security group for CVPN Access&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  vpc_id</span> <span class=o>=</span> <span class=k>module</span><span class=p>.</span><span class=k>vpc</span><span class=p>.</span><span class=k>vpc_id</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  computed_ingress_with_cidr_blocks</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    {
</span></span><span class=line><span class=cl><span class=n>      description</span> <span class=o>=</span> <span class=s2>&#34;VPN TLS&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      from_port</span>   <span class=o>=</span> <span class=m>443</span>
</span></span><span class=line><span class=cl><span class=n>      to_port</span>     <span class=o>=</span> <span class=m>443</span>
</span></span><span class=line><span class=cl><span class=n>      protocol</span>    <span class=o>=</span> <span class=s2>&#34;udp&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      cidr_blocks</span> <span class=o>=</span> <span class=s2>&#34;0.0.0.0/0&#34;</span>
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>  number_of_computed_ingress_with_cidr_blocks</span> <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  egress_with_cidr_blocks</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    {
</span></span><span class=line><span class=cl><span class=n>      description</span> <span class=o>=</span> <span class=s2>&#34;All&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      from_port</span>   <span class=o>=</span> <span class=err>-</span><span class=m>1</span>
</span></span><span class=line><span class=cl><span class=n>      to_port</span>     <span class=o>=</span> <span class=err>-</span><span class=m>1</span>
</span></span><span class=line><span class=cl><span class=n>      protocol</span>    <span class=o>=</span> <span class=err>-</span><span class=m>1</span>
</span></span><span class=line><span class=cl><span class=n>      cidr_blocks</span> <span class=o>=</span> <span class=s2>&#34;0.0.0.0/0&#34;</span>
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>As with most resources in AWS, the VPN will not be accessible by default. This security group allows clients/users secure access from the internet.</p><h3 id=certificates>Certificates<a hidden class=anchor aria-hidden=true href=#certificates>#</a></h3><h4 id=ca>CA<a hidden class=anchor aria-hidden=true href=#ca>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=c1># Creates CA private key
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>resource</span> <span class=s2>&#34;tls_private_key&#34; &#34;ca_key&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  algorithm</span> <span class=o>=</span> <span class=s2>&#34;RSA&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  rsa_bits</span>  <span class=o>=</span> <span class=m>2048</span>
</span></span><span class=line><span class=cl>}<span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># Creates a self-signed CA TLS certificate in PEM format
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>resource</span> <span class=s2>&#34;tls_self_signed_cert&#34; &#34;ca_cert&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  private_key_pem</span> <span class=o>=</span> <span class=k>tls_private_key</span><span class=p>.</span><span class=k>ca_key</span><span class=p>.</span><span class=k>private_key_pem</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>subject</span> {
</span></span><span class=line><span class=cl><span class=n>    common_name</span> <span class=o>=</span> <span class=s2>&#34;ca.${var.domain_name}&#34;</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  is_ca_certificate</span>     <span class=o>=</span> <span class=kt>true</span><span class=c1> # can be used to sign other certificates and control certificate revocation lists
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  validity_period_hours</span> <span class=o>=</span> <span class=m>87600</span>
</span></span><span class=line><span class=cl><span class=n>  allowed_uses</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;cert_signing&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;crl_signing&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>Leveraging ACM and using the <code>tls</code> provider we can use self-signed certificates, simplifying the process as we&rsquo;ll assume we don&rsquo;t need a custom Certificate Authority in this example. This provider replaces the use of <code>easyrsa</code> and makes our configuration self-contained and dynamic.</p><h4 id=server>Server<a hidden class=anchor aria-hidden=true href=#server>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=c1># Creates server private key
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>resource</span> <span class=s2>&#34;tls_private_key&#34; &#34;server_key&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  algorithm</span> <span class=o>=</span> <span class=s2>&#34;RSA&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  rsa_bits</span>  <span class=o>=</span> <span class=m>2048</span>
</span></span><span class=line><span class=cl>}<span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># Generates server CSR used to request cert from CA
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>resource</span> <span class=s2>&#34;tls_cert_request&#34; &#34;server_req&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  private_key_pem</span> <span class=o>=</span> <span class=k>tls_private_key</span><span class=p>.</span><span class=k>server_key</span><span class=p>.</span><span class=k>private_key_pem</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>subject</span> {
</span></span><span class=line><span class=cl><span class=n>    common_name</span> <span class=o>=</span> <span class=s2>&#34;vpn.${var.domain_name}&#34;</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>}<span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># Creates server certificate signed by a CA
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>resource</span> <span class=s2>&#34;tls_locally_signed_cert&#34; &#34;server_cert&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  cert_request_pem</span>   <span class=o>=</span> <span class=k>tls_cert_request</span><span class=p>.</span><span class=k>server_req</span><span class=p>.</span><span class=k>cert_request_pem</span>
</span></span><span class=line><span class=cl><span class=n>  ca_private_key_pem</span> <span class=o>=</span> <span class=k>tls_private_key</span><span class=p>.</span><span class=k>ca_key</span><span class=p>.</span><span class=k>private_key_pem</span>
</span></span><span class=line><span class=cl><span class=n>  ca_cert_pem</span>        <span class=o>=</span> <span class=k>tls_self_signed_cert</span><span class=p>.</span><span class=k>ca_cert</span><span class=p>.</span><span class=k>cert_pem</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  validity_period_hours</span> <span class=o>=</span> <span class=m>87600</span>
</span></span><span class=line><span class=cl><span class=n>  allowed_uses</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;key_encipherment&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;digital_signature&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;server_auth&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl>}<span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># Uploads server certificate to ACM (used by AWS Client VPN)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>resource</span> <span class=s2>&#34;aws_acm_certificate&#34; &#34;server_cert&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  private_key</span>       <span class=o>=</span> <span class=k>tls_private_key</span><span class=p>.</span><span class=k>server_key</span><span class=p>.</span><span class=k>private_key_pem</span>
</span></span><span class=line><span class=cl><span class=n>  certificate_body</span>  <span class=o>=</span> <span class=k>tls_locally_signed_cert</span><span class=p>.</span><span class=k>server_cert</span><span class=p>.</span><span class=k>cert_pem</span>
</span></span><span class=line><span class=cl><span class=n>  certificate_chain</span> <span class=o>=</span> <span class=k>tls_self_signed_cert</span><span class=p>.</span><span class=k>ca_cert</span><span class=p>.</span><span class=k>cert_pem</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>Here we create the self-signed server certificate and upload it to ACM.</p><h4 id=client>Client<a hidden class=anchor aria-hidden=true href=#client>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=c1># Creates client private key
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>resource</span> <span class=s2>&#34;tls_private_key&#34; &#34;client_key&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  algorithm</span> <span class=o>=</span> <span class=s2>&#34;RSA&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  rsa_bits</span>  <span class=o>=</span> <span class=m>2048</span>
</span></span><span class=line><span class=cl>}<span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># Generates client CSR used to request cert from CA
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>resource</span> <span class=s2>&#34;tls_cert_request&#34; &#34;client_req&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  private_key_pem</span> <span class=o>=</span> <span class=k>tls_private_key</span><span class=p>.</span><span class=k>client_key</span><span class=p>.</span><span class=k>private_key_pem</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>subject</span> {
</span></span><span class=line><span class=cl><span class=n>    common_name</span> <span class=o>=</span> <span class=s2>&#34;client.${var.domain_name}&#34;</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>}<span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># Creates client certificate signed by a CA
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>resource</span> <span class=s2>&#34;tls_locally_signed_cert&#34; &#34;client_cert&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  cert_request_pem</span>   <span class=o>=</span> <span class=k>tls_cert_request</span><span class=p>.</span><span class=k>client_req</span><span class=p>.</span><span class=k>cert_request_pem</span>
</span></span><span class=line><span class=cl><span class=n>  ca_private_key_pem</span> <span class=o>=</span> <span class=k>tls_private_key</span><span class=p>.</span><span class=k>ca_key</span><span class=p>.</span><span class=k>private_key_pem</span>
</span></span><span class=line><span class=cl><span class=n>  ca_cert_pem</span>        <span class=o>=</span> <span class=k>tls_self_signed_cert</span><span class=p>.</span><span class=k>ca_cert</span><span class=p>.</span><span class=k>cert_pem</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  validity_period_hours</span> <span class=o>=</span> <span class=m>87600</span>
</span></span><span class=line><span class=cl><span class=n>  allowed_uses</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;client_auth&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>Finally, we create the client certificate, which is needed to complete the Client VPN endpoint configuration file used for authentication.</p><h3 id=client-configuration>Client Configuration<a hidden class=anchor aria-hidden=true href=#client-configuration>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;null_resource&#34; &#34;download_cvpn_config&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  depends_on</span> <span class=o>=</span> <span class=p>[</span><span class=k>aws_ec2_client_vpn_endpoint</span><span class=p>.</span><span class=k>cvpn</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>provisioner</span> <span class=s2>&#34;local-exec&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>    command</span>     <span class=o>=</span> <span class=err>&lt;&lt;</span><span class=k>EOF</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>      #!/bin/bash
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>set</span> <span class=err>-</span><span class=k>e</span><span class=c1>  # Exit on error
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>      # Export the VPN configuration
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>aws</span> <span class=k>ec2</span> <span class=k>export</span><span class=err>-</span><span class=k>client</span><span class=err>-</span><span class=k>vpn</span><span class=err>-</span><span class=k>client</span><span class=err>-</span><span class=k>configuration</span> <span class=err>--</span><span class=k>client</span><span class=err>-</span><span class=k>vpn</span><span class=err>-</span><span class=k>endpoint</span><span class=err>-</span><span class=k>id</span> <span class=si>${</span><span class=err>aws_ec2_client_vpn_endpoint</span><span class=p>.</span><span class=err>cvpn</span><span class=p>.</span><span class=err>id</span><span class=si>}</span> <span class=err>--</span><span class=k>output</span> <span class=k>text</span> <span class=err>&gt;</span> <span class=p>.</span><span class=err>/</span><span class=k>client</span><span class=err>-</span><span class=k>config</span><span class=p>.</span><span class=k>ovpn</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>      # Embed the client certificate
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>echo</span> <span class=err>&#39;&lt;</span><span class=k>cert</span><span class=err>&gt;&#39;</span> <span class=err>&gt;&gt;</span> <span class=p>.</span><span class=err>/</span><span class=k>client</span><span class=err>-</span><span class=k>config</span><span class=p>.</span><span class=k>ovpn</span>
</span></span><span class=line><span class=cl>      <span class=k>echo</span> <span class=s2>&#34;${tls_locally_signed_cert.client_cert.cert_pem}&#34;</span> <span class=err>&gt;&gt;</span> <span class=p>.</span><span class=err>/</span><span class=k>client</span><span class=err>-</span><span class=k>config</span><span class=p>.</span><span class=k>ovpn</span>
</span></span><span class=line><span class=cl>      <span class=k>echo</span> <span class=err>&#39;&lt;/</span><span class=k>cert</span><span class=err>&gt;&#39;</span> <span class=err>&gt;&gt;</span> <span class=p>.</span><span class=err>/</span><span class=k>client</span><span class=err>-</span><span class=k>config</span><span class=p>.</span><span class=k>ovpn</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>      # Embed the private key
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>echo</span> <span class=err>&#39;&lt;</span><span class=k>key</span><span class=err>&gt;&#39;</span> <span class=err>&gt;&gt;</span> <span class=p>.</span><span class=err>/</span><span class=k>client</span><span class=err>-</span><span class=k>config</span><span class=p>.</span><span class=k>ovpn</span>
</span></span><span class=line><span class=cl>      <span class=k>echo</span> <span class=s2>&#34;${tls_private_key.client_key.private_key_pem}&#34;</span> <span class=err>&gt;&gt;</span> <span class=p>.</span><span class=err>/</span><span class=k>client</span><span class=err>-</span><span class=k>config</span><span class=p>.</span><span class=k>ovpn</span>
</span></span><span class=line><span class=cl>      <span class=k>echo</span> <span class=err>&#39;&lt;/</span><span class=k>key</span><span class=err>&gt;&#39;</span> <span class=err>&gt;&gt;</span> <span class=p>.</span><span class=err>/</span><span class=k>client</span><span class=err>-</span><span class=k>config</span><span class=p>.</span><span class=k>ovpn</span>
</span></span><span class=line><span class=cl>    <span class=k>EOF</span>
</span></span><span class=line><span class=cl><span class=n>    interpreter</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;/bin/bash&#34;, &#34;-c&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  triggers</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>    always_run</span> <span class=o>=</span> <span class=s2>&#34;${timestamp()}&#34;</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>This last code block uses the local-exec provisioner to automatically prepare the Client VPN endpoint configuration file without having to manually download it via the AWS Console and adding the client certification data.</p><h3 id=conclusions>Conclusions<a hidden class=anchor aria-hidden=true href=#conclusions>#</a></h3><p>We&rsquo;ve reviewed a Terraform configuration that simplifies the AWS Client VPN deployment. This setup demonstrates a workflow in the spirit of best practices, reducing overhead and human error by declaratively defining our infrastructure.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://tbalza.net/tags/terraform/>Terraform</a></li><li><a href=https://tbalza.net/tags/aws/>Aws</a></li><li><a href=https://tbalza.net/tags/vpn/>Vpn</a></li><li><a href=https://tbalza.net/tags/vpc/>Vpc</a></li><li><a href=https://tbalza.net/tags/acm/>Acm</a></li></ul><nav class=paginav><a class=next href=https://tbalza.net/zero-touch-provisioning-deployment-of-kubernetes-ci/cd-pipeline/><span class=title>Next »</span><br><span>Zero-Touch Provisioning & Deployment of Kubernetes CI/CD Pipeline</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://tbalza.net/>Tomas Balza</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>