<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Using Terraform for Amazon API Gateway Deployment | Tomas Balza</title>
<meta name=keywords content="terraform,lambda,aws,api,dynamodb"><meta name=description content="This article offers a comprehensive tutorial on creating and deploying an Amazon API Gateway resource using Terraform, and demonstrates how to invoke a Lambda function through an HTTPS endpoint."><meta name=author content><link rel=canonical href=https://tbalza.net/using-terraform-for-amazon-api-gateway-deployment/><link crossorigin=anonymous href=/assets/css/stylesheet.aa6c24b0041051640ef80d50f7101a25cd1f003ec200b586894bcb729d3a35b4.css integrity="sha256-qmwksAQQUWQO+A1Q9xAaJc0fAD7CALWGiUvLcp06NbQ=" rel="preload stylesheet" as=style><link rel=icon href=https://tbalza.net/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://tbalza.net/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://tbalza.net/favicon-32x32.png><link rel=apple-touch-icon href=https://tbalza.net/apple-touch-icon.png><link rel=mask-icon href=https://tbalza.net/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://tbalza.net/using-terraform-for-amazon-api-gateway-deployment/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Using Terraform for Amazon API Gateway Deployment"><meta property="og:description" content="This article offers a comprehensive tutorial on creating and deploying an Amazon API Gateway resource using Terraform, and demonstrates how to invoke a Lambda function through an HTTPS endpoint."><meta property="og:type" content="article"><meta property="og:url" content="https://tbalza.net/using-terraform-for-amazon-api-gateway-deployment/"><meta property="og:image" content="https://tbalza.net/posts/serverless_api/cover.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-03-11T00:00:00+00:00"><meta property="article:modified_time" content="2024-03-11T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://tbalza.net/posts/serverless_api/cover.jpg"><meta name=twitter:title content="Using Terraform for Amazon API Gateway Deployment"><meta name=twitter:description content="This article offers a comprehensive tutorial on creating and deploying an Amazon API Gateway resource using Terraform, and demonstrates how to invoke a Lambda function through an HTTPS endpoint."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://tbalza.net/posts/"},{"@type":"ListItem","position":2,"name":"Using Terraform for Amazon API Gateway Deployment","item":"https://tbalza.net/using-terraform-for-amazon-api-gateway-deployment/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Using Terraform for Amazon API Gateway Deployment","name":"Using Terraform for Amazon API Gateway Deployment","description":"This article offers a comprehensive tutorial on creating and deploying an Amazon API Gateway resource using Terraform, and demonstrates how to invoke a Lambda function through an HTTPS endpoint.","keywords":["terraform","lambda","aws","api","dynamodb"],"articleBody":"This guide offers a comprehensive step-by-step process on how to build and deploy an Amazon API Gateway resource using Terraform. It also demonstrates how to invoke a Lambda function through an HTTPS endpoint, which will directly interact with DynamoDB.\nOne of the primary benefits of using Terraform is the capability to launch the entire project with a single click. The principle of infrastructure as code is crucial for projects as it facilitates tracking of configuration changes and encourages efficient collaboration within large teams.\nGetting Started For Mac users, you can install Homebrew and set up AWS CLI, Terraform, and Bruno.\nbrew install awscli brew install terraform brew install bruno # An Opensource API client, we'll use for testing aws configure # Follow the steps to provide your AWS account credentials (We recommend using a testing account)\ngit clone https://github.com/tbalza/lambda-dynamodb-api.git cd lambda-dynamodb-api terraform init This will initialize terraform, and download all the necessary libraries and modules, enabling our HCL code in main.tf to interact with AWS using the credentials we set up earlier with the CLI. All the necessary files will be stored in the .terraform folder for future use. terraform plan -out tfplan This command outlines all the changes that will occur, assessing the current state of resources and what is specified as a final result in our code. terraform apply -auto-approve tfplan After running the apply command, it will proceed to create and configure our infrastructure as described in our code. Once you’re finished, you can tidy up by\nterraform destroy Ideally, you should use terraform plan -destroy -out tfplan and then terraform apply tfplan as this allows you to double-check all changes before committing them to AWS.\nOverview of all the sections Using the commands provided above, you can quickly set up and test the infrastructure. Moreover, you can effortlessly clean it up to prevent any unexpected charges in the future. In the following sections, we’ll provide a brief explanation of the function of each block.\nSetup IAM Permissions Create custom IAM policy\nmodule \"iam_policy\" { source = \"terraform-aws-modules/iam/aws//modules/iam-policy\" version = \"~\u003e 5.37.1\" name = \"lambda-apigateway-role-policy\" description = \"Custom policy with permission to DynamoDB and CloudWatch Logs\" policy = jsonencode({ Version = \"2012-10-17\" Statement = [ { Sid = \"Stmt1428341300017\" Action = [ \"dynamodb:DeleteItem\", \"dynamodb:GetItem\", \"dynamodb:PutItem\", \"dynamodb:Query\", \"dynamodb:Scan\", \"dynamodb:UpdateItem\" ] Effect = \"Allow\" Resource = \"*\" }, { Sid = \"\" Resource = \"*\" Action = [ \"logs:CreateLogGroup\", \"logs:CreateLogStream\", \"logs:PutLogEvents\" ] Effect = \"Allow\" } ] }) } This is a standalone custom policy that allows the principal who assumes it to edit DynamoDB and CW Logs.\nCreate role for lambda function, attach custom IAM policy and trusted entity\nmodule \"iam_assumable_role_lambda\" { source = \"terraform-aws-modules/iam/aws//modules/iam-assumable-role\" version = \"~\u003e 5.37.1\" create_role = true role_name = \"lambda-apigateway-role\" create_custom_role_trust_policy = true custom_role_trust_policy = data.aws_iam_policy_document.custom_trust_policy.json custom_role_policy_arns = [module.iam_policy.arn] # Get the ARN from the iam_policy module } # Create trusted entity data \"aws_iam_policy_document\" \"custom_trust_policy\" { statement { effect = \"Allow\" actions = [\"sts:AssumeRole\"] principals { type = \"Service\" identifiers = [\"lambda.amazonaws.com\"] } } } This creates a role and attaches the previous policy to that role. It also assigns the role the trusted entity required for the lambda role to assume it.\nCreate trigger equivalent to explicitly grant permissions to the API Gateway to invoke your Lambda function\nresource \"aws_lambda_permission\" \"apigw\" { statement_id = \"AllowExecutionFromAPIGateway\" action = \"lambda:InvokeFunction\" function_name = aws_lambda_function.example.arn principal = \"apigateway.amazonaws.com\" source_arn = \"${aws_api_gateway_deployment.dev.execution_arn}/*\" } When creating resources via ClickOps, the trigger is automatically assigned to the lambda function when it is associated with the API, however via CLI we need to explicitly set this in order to have the correct permissions.\nCreate Lambda Function lambda_function.py\nfrom __future__ import print_function import boto3 import json print('Loading function') def lambda_handler(event, context): '''Provide an event that contains the following keys: - operation: one of the operations in the operations dict below - tableName: required for operations that interact with DynamoDB - payload: a parameter to pass to the operation being performed ''' #print(\"Received event: \" + json.dumps(event, indent=2)) operation = event['operation'] if 'tableName' in event: dynamo = boto3.resource('dynamodb').Table(event['tableName']) operations = { 'create': lambda x: dynamo.put_item(**x), 'read': lambda x: dynamo.get_item(**x), 'update': lambda x: dynamo.update_item(**x), 'delete': lambda x: dynamo.delete_item(**x), 'list': lambda x: dynamo.scan(**x), 'echo': lambda x: x, 'ping': lambda x: 'pong' } if operation in operations: return operations[operation](event.get('payload')) else: raise ValueError('Unrecognized operation \"{}\"'.format(operation)) This lambda function is written in Python, and works with any table name we specify via the POST method. Actions such as, create, read, update, delete, list, echo and ping, are supported.\nZip the lambda_function.py to enable uploading to AWS\ndata \"archive_file\" \"lambda_zip\" { type = \"zip\" source_file = \"${path.module}/lambda_function.py\" output_path = \"${path.module}/lambda_function.zip\" } We use built in TF tools to zip the Python script, which is needed in order to upload it to AWS via this method.\nCreate lambda function from lambda_function.py\nresource \"aws_lambda_function\" \"example\" { function_name = \"LambdaFunctionsOverHttps\" handler = \"lambda_function.lambda_handler\" runtime = \"python3.12\" filename = data.archive_file.lambda_zip.output_path # Associate function to previously created role role = module.iam_assumable_role_lambda.iam_role_arn # Get the ARN from the iam_assumable_role_lambda module } Finally, we upload the lambda function and attach the role we created earlier.\nDynamoDB Create a simple dynamodb table\nmodule \"dynamodb_table\" { source = \"terraform-aws-modules/dynamodb-table/aws\" version = \"~\u003e 4.0.1\" name = \"lambda-apigateway\" hash_key = \"id\" # primary key attributes = [ { name = \"id\" type = \"S\" } ] } This creates a table with an “id” primary column that will expect strings.\nAPI Create API\nresource \"aws_api_gateway_rest_api\" \"DynamoDBOperations\" { name = \"DynamoDBOperations\" description = \"API for DynamoDB Operations\" api_key_source = \"HEADER\" endpoint_configuration { types = [\"REGIONAL\"] } } This creates the API by itself, and defines the end point configuration type.\nCreate resource\nresource \"aws_api_gateway_resource\" \"DynamoDBManager\" { rest_api_id = aws_api_gateway_rest_api.DynamoDBOperations.id parent_id = aws_api_gateway_rest_api.DynamoDBOperations.root_resource_id path_part = \"dynamodbmanager\" } These are the various parts of your API that clients can access. They are represented as a hierarchical structure similar to a file path. For example, in the API endpoint https://api.example.com/users/profile, ‘users’ and ‘profile’ are resources. Resources can have child resources, creating a tree-like structure.\nCreate POST method\nresource \"aws_api_gateway_method\" \"post\" { rest_api_id = aws_api_gateway_rest_api.DynamoDBOperations.id resource_id = aws_api_gateway_resource.DynamoDBManager.id http_method = \"POST\" authorization = \"NONE\" api_key_required = false } These are the HTTP methods (also known as verbs) that clients can use to interact with the resources. Common methods include GET, POST, PUT, DELETE, and PATCH. Each method represents a different type of operation that can be performed on a resource. For example, a GET method on a ‘users’ resource might retrieve a list of users, while a POST method on the same resource might create a new user.\nLink API to Lambda function\nresource \"aws_api_gateway_integration\" \"lambda\" { rest_api_id = aws_api_gateway_rest_api.DynamoDBOperations.id resource_id = aws_api_gateway_resource.DynamoDBManager.id http_method = aws_api_gateway_method.post.http_method integration_http_method = \"POST\" type = \"AWS\" uri = aws_lambda_function.example.invoke_arn passthrough_behavior = \"WHEN_NO_MATCH\" } uri = aws_lambda_function.example.invoke_arn: This line sets the URI of the integrated backend. In this case, it’s a Lambda function, and the ARN (Amazon Resource Name) used to invoke the function is retrieved from another resource named example of type aws_lambda_function.\nCreate response code\nresource \"aws_api_gateway_method_response\" \"response\" { rest_api_id = aws_api_gateway_rest_api.DynamoDBOperations.id resource_id = aws_api_gateway_resource.DynamoDBManager.id http_method = aws_api_gateway_method.post.http_method status_code = \"200\" } http_method = aws_api_gateway_method.post.http_method: This line sets the HTTP method for the method response. The method is retrieved from another resource of type aws_api_gateway_method with the name post.\nstatus_code = “200”: This line sets the HTTP status code for the method response. In this case, it’s “200”, which typically represents a successful HTTP request.\nIntegrate response code\nresource \"aws_api_gateway_integration_response\" \"lambda\" { depends_on = [aws_api_gateway_integration.lambda, aws_api_gateway_method_response.response] rest_api_id = aws_api_gateway_rest_api.DynamoDBOperations.id resource_id = aws_api_gateway_resource.DynamoDBManager.id http_method = aws_api_gateway_method.post.http_method status_code = aws_api_gateway_method_response.response.status_code } depends_on = [aws_api_gateway_integration.lambda, aws_api_gateway_method_response.response]: This line specifies that the creation of this resource depends on the successful creation of other resources in order the execute correctly.\nThis creates an integration response that depends on the successful creation of the API Gateway integration and method response.\nBoth blocks are part of configuring an API Gateway to handle responses from a backend service, in this case, a Lambda function.\nDeploy in “Dev”\nresource \"aws_api_gateway_deployment\" \"dev\" { depends_on = [aws_api_gateway_integration.lambda] rest_api_id = aws_api_gateway_rest_api.DynamoDBOperations.id stage_name = \"dev\" } This deploys our API to the “dev” stage, generating our invoke URL that we will use to interact with the API\nOutput API Invoke URL output \"api_invoke_url\" { description = \"api_invoke_url\" value = \"${aws_api_gateway_deployment.dev.invoke_url}/${aws_api_gateway_resource.DynamoDBManager.path_part}\" } This line from outputs.tf prints out our Invoke URL generated earlier, and displays it after terraform apply.\nTest with API Client Open Bruno. Create Collection \u003e New Request \u003e Paste the invoke URL generated inside URL: POST\nThen in the BODY section, select Raw \u003e JSON, past the code below, and press cmd+enter to execute\n{ \"operation\": \"create\", \"tableName\": \"lambda-apigateway\", \"payload\": { \"Item\": { \"id\": \"1234ABCD\", \"number\": 88 } } } Verify Results in DynamoDB Go to DynamoDB \u003e Tables \u003e lambda-apigateway \u003e Explore Table Items Here you’ll see that our POST payload, sent to the API Invoke URL, interacts with Lambda, which in turn modifies our DynamoDB table.\nClean up Run this command to delete all our previously created resources and configurations.\nKey Takeaways We’ve created an API that is publicly accessible via our Invoke URL, which allows us to interact with the DynamoDB table directly via a Lambda function.\nIn future articles, we’ll delve deeper into GitOps, and CI/CD pipelines building on this knowledge, and implement authentication, DNS and certificate configurations.\n","wordCount":"1554","inLanguage":"en","image":"https://tbalza.net/posts/serverless_api/cover.jpg","datePublished":"2024-03-11T00:00:00Z","dateModified":"2024-03-11T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://tbalza.net/using-terraform-for-amazon-api-gateway-deployment/"},"publisher":{"@type":"Organization","name":"Tomas Balza","logo":{"@type":"ImageObject","url":"https://tbalza.net/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://tbalza.net/ accesskey=h title="Tomas Balza (Alt + H)"><img src=https://tbalza.net/profile-photo-2.jpg alt aria-label=logo height=35>Tomas Balza<p id=subtitle>DevOps / Tech Articles</p></a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://github.com/tbalza title=GitHub><span>GitHub</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://www.linkedin.com/in/tomas-balza-b075141b3 title=LinkedIn><span>LinkedIn</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://www.youtube.com/@tbalza-tech title=YouTube><span>YouTube</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Using Terraform for Amazon API Gateway Deployment</h1><div class=post-meta><span title='2024-03-11 00:00:00 +0000 UTC'>March, 2024</span>&nbsp;&nbsp;&nbsp;<a href=/tags/terraform> terraform</a> <a href=/tags/lambda>lambda</a> <a href=/tags/aws>aws</a> <a href=/tags/api>api</a> <a href=/tags/dynamodb>dynamodb</a></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#getting-started aria-label="Getting Started">Getting Started</a></li><li><a href=#overview-of-all-the-sections aria-label="Overview of all the sections">Overview of all the sections</a><ul><li><a href=#setup-iam-permissions aria-label="Setup IAM Permissions">Setup IAM Permissions</a></li><li><a href=#create-lambda-function aria-label="Create Lambda Function">Create Lambda Function</a></li><li><a href=#dynamodb aria-label=DynamoDB>DynamoDB</a></li><li><a href=#api aria-label=API>API</a></li><li><a href=#output-api-invoke-url aria-label="Output API Invoke URL">Output API Invoke URL</a></li></ul></li><li><a href=#test-with-api-client aria-label="Test with API Client">Test with API Client</a></li><li><a href=#verify-results-in-dynamodb aria-label="Verify Results in DynamoDB">Verify Results in DynamoDB</a></li><li><a href=#clean-up aria-label="Clean up">Clean up</a></li><li><a href=#key-takeaways aria-label="Key Takeaways">Key Takeaways</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"),document.querySelectorAll(".inner ul li a").forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();const t=this.getAttribute("href").slice(1),n=document.getElementById(t);window.scrollTo({top:getOffsetTop(n)-75,behavior:"smooth"})})})},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset-60>0&&getOffsetTop(e)-window.pageYOffset-60<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.scrollY}</script><div class=post-content><p>This guide offers a comprehensive step-by-step process on how to build and deploy an Amazon API Gateway resource using Terraform. It also demonstrates how to invoke a Lambda function through an HTTPS endpoint, which will directly interact with DynamoDB.</p><p>One of the primary benefits of using Terraform is the capability to launch the entire project with a single click. The principle of infrastructure as code is crucial for projects as it facilitates tracking of configuration changes and encourages efficient collaboration within large teams.</p><h2 id=getting-started>Getting Started<a hidden class=anchor aria-hidden=true href=#getting-started>#</a></h2><p>For Mac users, you can install <a href=https://docs.brew.sh/Installation>Homebrew</a> and set up AWS CLI, Terraform, and Bruno.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>brew install awscli
</span></span><span class=line><span class=cl>brew install terraform
</span></span><span class=line><span class=cl>brew install bruno <span class=c1># An Opensource API client, we&#39;ll use for testing</span>
</span></span><span class=line><span class=cl>aws configure <span class=c1># Follow the steps to provide your AWS account credentials</span>
</span></span></code></pre></div><p><strong>(We recommend using a testing account)</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git clone https://github.com/tbalza/lambda-dynamodb-api.git
</span></span><span class=line><span class=cl><span class=nb>cd</span> lambda-dynamodb-api
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>terraform init
</span></span></code></pre></div><p>This will initialize terraform, and download all the necessary libraries and modules, enabling our HCL code in main.tf to interact with AWS using the credentials we set up earlier with the CLI. All the necessary files will be stored in the .terraform folder for future use.
<img loading=lazy src=/posts/serverless_api/init.png alt=init></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>terraform plan -out tfplan
</span></span></code></pre></div><p>This command outlines all the changes that will occur, assessing the current state of resources and what is specified as a final result in our code.
<img loading=lazy src=/posts/serverless_api/plan.png alt=plan></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>terraform apply -auto-approve tfplan
</span></span></code></pre></div><p>After running the apply command, it will proceed to create and configure our infrastructure as described in our code.
<img loading=lazy src=/posts/serverless_api/apply.png alt=apply></p><p>Once you&rsquo;re finished, you can tidy up by</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>terraform destroy
</span></span></code></pre></div><p>Ideally, you should use <code>terraform plan -destroy -out tfplan</code> and then <code>terraform apply tfplan</code> as this allows you to double-check all changes before committing them to AWS.</p><h2 id=overview-of-all-the-sections>Overview of all the sections<a hidden class=anchor aria-hidden=true href=#overview-of-all-the-sections>#</a></h2><p>Using the commands provided above, you can quickly set up and test the infrastructure. Moreover, you can effortlessly clean it up to prevent any unexpected charges in the future. In the following sections, we&rsquo;ll provide a brief explanation of the function of each block.</p><h3 id=setup-iam-permissions>Setup IAM Permissions<a hidden class=anchor aria-hidden=true href=#setup-iam-permissions>#</a></h3><p><strong>Create custom IAM policy</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>module</span> <span class=s2>&#34;iam_policy&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  source</span>  <span class=o>=</span> <span class=s2>&#34;terraform-aws-modules/iam/aws//modules/iam-policy&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  version</span> <span class=o>=</span> <span class=s2>&#34;~&gt; 5.37.1&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  name</span>        <span class=o>=</span> <span class=s2>&#34;lambda-apigateway-role-policy&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  description</span> <span class=o>=</span> <span class=s2>&#34;Custom policy with permission to DynamoDB and CloudWatch Logs&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  policy</span> <span class=o>=</span> <span class=k>jsonencode</span><span class=p>(</span>{
</span></span><span class=line><span class=cl><span class=n>    Version</span> <span class=o>=</span> <span class=s2>&#34;2012-10-17&#34;</span>
</span></span><span class=line><span class=cl><span class=n>    Statement</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      {
</span></span><span class=line><span class=cl><span class=n>        Sid</span> <span class=o>=</span> <span class=s2>&#34;Stmt1428341300017&#34;</span>
</span></span><span class=line><span class=cl><span class=n>        Action</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;dynamodb:DeleteItem&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;dynamodb:GetItem&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;dynamodb:PutItem&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;dynamodb:Query&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;dynamodb:Scan&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;dynamodb:UpdateItem&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>        Effect</span>   <span class=o>=</span> <span class=s2>&#34;Allow&#34;</span>
</span></span><span class=line><span class=cl><span class=n>        Resource</span> <span class=o>=</span> <span class=s2>&#34;*&#34;</span>
</span></span><span class=line><span class=cl>      }<span class=p>,</span>
</span></span><span class=line><span class=cl>      {
</span></span><span class=line><span class=cl><span class=n>        Sid</span>      <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=n>        Resource</span> <span class=o>=</span> <span class=s2>&#34;*&#34;</span>
</span></span><span class=line><span class=cl><span class=n>        Action</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;logs:CreateLogGroup&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;logs:CreateLogStream&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;logs:PutLogEvents&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>        Effect</span> <span class=o>=</span> <span class=s2>&#34;Allow&#34;</span>
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>  }<span class=p>)</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>This is a standalone custom policy that allows the principal who assumes it to edit DynamoDB and CW Logs.</p><p><strong>Create role for lambda function, attach custom IAM policy and trusted entity</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>module</span> <span class=s2>&#34;iam_assumable_role_lambda&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  source</span>  <span class=o>=</span> <span class=s2>&#34;terraform-aws-modules/iam/aws//modules/iam-assumable-role&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  version</span> <span class=o>=</span> <span class=s2>&#34;~&gt; 5.37.1&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  create_role</span> <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl><span class=n>  role_name</span>   <span class=o>=</span> <span class=s2>&#34;lambda-apigateway-role&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  create_custom_role_trust_policy</span> <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl><span class=n>  custom_role_trust_policy</span>        <span class=o>=</span> <span class=k>data</span><span class=p>.</span><span class=k>aws_iam_policy_document</span><span class=p>.</span><span class=k>custom_trust_policy</span><span class=p>.</span><span class=k>json</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  custom_role_policy_arns</span> <span class=o>=</span> <span class=p>[</span><span class=k>module</span><span class=p>.</span><span class=k>iam_policy</span><span class=p>.</span><span class=k>arn</span><span class=p>]</span><span class=c1> # Get the ARN from the iam_policy module
</span></span></span><span class=line><span class=cl><span class=c1></span>}<span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># Create trusted entity
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>data</span> <span class=s2>&#34;aws_iam_policy_document&#34; &#34;custom_trust_policy&#34;</span> {
</span></span><span class=line><span class=cl>  <span class=k>statement</span> {
</span></span><span class=line><span class=cl><span class=n>    effect</span>  <span class=o>=</span> <span class=s2>&#34;Allow&#34;</span>
</span></span><span class=line><span class=cl><span class=n>    actions</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;sts:AssumeRole&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>principals</span> {
</span></span><span class=line><span class=cl><span class=n>      type</span>        <span class=o>=</span> <span class=s2>&#34;Service&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      identifiers</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;lambda.amazonaws.com&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>This creates a role and attaches the previous policy to that role. It also assigns the role the trusted entity required for the lambda role to assume it.</p><p><strong>Create trigger equivalent to explicitly grant permissions to the API Gateway to invoke your Lambda function</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;aws_lambda_permission&#34; &#34;apigw&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  statement_id</span>  <span class=o>=</span> <span class=s2>&#34;AllowExecutionFromAPIGateway&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  action</span>        <span class=o>=</span> <span class=s2>&#34;lambda:InvokeFunction&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  function_name</span> <span class=o>=</span> <span class=k>aws_lambda_function</span><span class=p>.</span><span class=k>example</span><span class=p>.</span><span class=k>arn</span>
</span></span><span class=line><span class=cl><span class=n>  principal</span>     <span class=o>=</span> <span class=s2>&#34;apigateway.amazonaws.com&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  source_arn</span> <span class=o>=</span> <span class=s2>&#34;${aws_api_gateway_deployment.dev.execution_arn}/*&#34;</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>When creating resources via ClickOps, the trigger is automatically assigned to the lambda function when it is associated with the API, however via CLI we need to explicitly set this in order to have the correct permissions.</p><p><img loading=lazy src=/posts/serverless_api/trigger.png alt=trigger></p><h3 id=create-lambda-function>Create Lambda Function<a hidden class=anchor aria-hidden=true href=#create-lambda-function>#</a></h3><p><strong>lambda_function.py</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>__future__</span> <span class=kn>import</span> <span class=n>print_function</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>boto3</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Loading function&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>lambda_handler</span><span class=p>(</span><span class=n>event</span><span class=p>,</span> <span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;&#39;&#39;Provide an event that contains the following keys:
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>      - operation: one of the operations in the operations dict below
</span></span></span><span class=line><span class=cl><span class=s1>      - tableName: required for operations that interact with DynamoDB
</span></span></span><span class=line><span class=cl><span class=s1>      - payload: a parameter to pass to the operation being performed
</span></span></span><span class=line><span class=cl><span class=s1>    &#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=c1>#print(&#34;Received event: &#34; + json.dumps(event, indent=2))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>operation</span> <span class=o>=</span> <span class=n>event</span><span class=p>[</span><span class=s1>&#39;operation&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=s1>&#39;tableName&#39;</span> <span class=ow>in</span> <span class=n>event</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>dynamo</span> <span class=o>=</span> <span class=n>boto3</span><span class=o>.</span><span class=n>resource</span><span class=p>(</span><span class=s1>&#39;dynamodb&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>Table</span><span class=p>(</span><span class=n>event</span><span class=p>[</span><span class=s1>&#39;tableName&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>operations</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;create&#39;</span><span class=p>:</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>dynamo</span><span class=o>.</span><span class=n>put_item</span><span class=p>(</span><span class=o>**</span><span class=n>x</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;read&#39;</span><span class=p>:</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>dynamo</span><span class=o>.</span><span class=n>get_item</span><span class=p>(</span><span class=o>**</span><span class=n>x</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;update&#39;</span><span class=p>:</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>dynamo</span><span class=o>.</span><span class=n>update_item</span><span class=p>(</span><span class=o>**</span><span class=n>x</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;delete&#39;</span><span class=p>:</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>dynamo</span><span class=o>.</span><span class=n>delete_item</span><span class=p>(</span><span class=o>**</span><span class=n>x</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;list&#39;</span><span class=p>:</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>dynamo</span><span class=o>.</span><span class=n>scan</span><span class=p>(</span><span class=o>**</span><span class=n>x</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;echo&#39;</span><span class=p>:</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;ping&#39;</span><span class=p>:</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=s1>&#39;pong&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>operation</span> <span class=ow>in</span> <span class=n>operations</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>operations</span><span class=p>[</span><span class=n>operation</span><span class=p>](</span><span class=n>event</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;payload&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;Unrecognized operation &#34;</span><span class=si>{}</span><span class=s1>&#34;&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>operation</span><span class=p>))</span>
</span></span></code></pre></div><p>This lambda function is written in Python, and works with any table name we specify via the POST method. Actions such as, create, read, update, delete, list, echo and ping, are supported.</p><p><strong>Zip the lambda_function.py to enable uploading to AWS</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>data</span> <span class=s2>&#34;archive_file&#34; &#34;lambda_zip&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  type</span>        <span class=o>=</span> <span class=s2>&#34;zip&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  source_file</span> <span class=o>=</span> <span class=s2>&#34;${path.module}/lambda_function.py&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  output_path</span> <span class=o>=</span> <span class=s2>&#34;${path.module}/lambda_function.zip&#34;</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>We use built in TF tools to zip the Python script, which is needed in order to upload it to AWS via this method.</p><p><strong>Create lambda function from lambda_function.py</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;aws_lambda_function&#34; &#34;example&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  function_name</span> <span class=o>=</span> <span class=s2>&#34;LambdaFunctionsOverHttps&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  handler</span>       <span class=o>=</span> <span class=s2>&#34;lambda_function.lambda_handler&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  runtime</span>       <span class=o>=</span> <span class=s2>&#34;python3.12&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  filename</span> <span class=o>=</span> <span class=k>data</span><span class=p>.</span><span class=k>archive_file</span><span class=p>.</span><span class=k>lambda_zip</span><span class=p>.</span><span class=k>output_path</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>  # Associate function to previously created role
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  role</span> <span class=o>=</span> <span class=k>module</span><span class=p>.</span><span class=k>iam_assumable_role_lambda</span><span class=p>.</span><span class=k>iam_role_arn</span><span class=c1> # Get the ARN from the iam_assumable_role_lambda module
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>Finally, we upload the lambda function and attach the role we created earlier.</p><h3 id=dynamodb>DynamoDB<a hidden class=anchor aria-hidden=true href=#dynamodb>#</a></h3><p><strong>Create a simple dynamodb table</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>module</span> <span class=s2>&#34;dynamodb_table&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  source</span>  <span class=o>=</span> <span class=s2>&#34;terraform-aws-modules/dynamodb-table/aws&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  version</span> <span class=o>=</span> <span class=s2>&#34;~&gt; 4.0.1&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  name</span>     <span class=o>=</span> <span class=s2>&#34;lambda-apigateway&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  hash_key</span> <span class=o>=</span> <span class=s2>&#34;id&#34;</span><span class=c1> # primary key
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=n>  attributes</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    {
</span></span><span class=line><span class=cl><span class=n>      name</span> <span class=o>=</span> <span class=s2>&#34;id&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      type</span> <span class=o>=</span> <span class=s2>&#34;S&#34;</span>
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>This creates a table with an &ldquo;id&rdquo; primary column that will expect strings.</p><h3 id=api>API<a hidden class=anchor aria-hidden=true href=#api>#</a></h3><p><strong>Create API</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;aws_api_gateway_rest_api&#34; &#34;DynamoDBOperations&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  name</span>           <span class=o>=</span> <span class=s2>&#34;DynamoDBOperations&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  description</span>    <span class=o>=</span> <span class=s2>&#34;API for DynamoDB Operations&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  api_key_source</span> <span class=o>=</span> <span class=s2>&#34;HEADER&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>endpoint_configuration</span> {
</span></span><span class=line><span class=cl><span class=n>    types</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;REGIONAL&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>This creates the API by itself, and defines the end point configuration type.</p><p><strong>Create resource</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;aws_api_gateway_resource&#34; &#34;DynamoDBManager&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  rest_api_id</span> <span class=o>=</span> <span class=k>aws_api_gateway_rest_api</span><span class=p>.</span><span class=k>DynamoDBOperations</span><span class=p>.</span><span class=k>id</span>
</span></span><span class=line><span class=cl><span class=n>  parent_id</span>   <span class=o>=</span> <span class=k>aws_api_gateway_rest_api</span><span class=p>.</span><span class=k>DynamoDBOperations</span><span class=p>.</span><span class=k>root_resource_id</span>
</span></span><span class=line><span class=cl><span class=n>  path_part</span>   <span class=o>=</span> <span class=s2>&#34;dynamodbmanager&#34;</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>These are the various parts of your API that clients can access. They are represented as a hierarchical structure similar to a file path. For example, in the API endpoint <a href=https://api.example.com/users/profile>https://api.example.com/users/profile</a>, &lsquo;users&rsquo; and &lsquo;profile&rsquo; are resources. Resources can have child resources, creating a tree-like structure.</p><p><strong>Create POST method</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;aws_api_gateway_method&#34; &#34;post&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  rest_api_id</span>      <span class=o>=</span> <span class=k>aws_api_gateway_rest_api</span><span class=p>.</span><span class=k>DynamoDBOperations</span><span class=p>.</span><span class=k>id</span>
</span></span><span class=line><span class=cl><span class=n>  resource_id</span>      <span class=o>=</span> <span class=k>aws_api_gateway_resource</span><span class=p>.</span><span class=k>DynamoDBManager</span><span class=p>.</span><span class=k>id</span>
</span></span><span class=line><span class=cl><span class=n>  http_method</span>      <span class=o>=</span> <span class=s2>&#34;POST&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  authorization</span>    <span class=o>=</span> <span class=s2>&#34;NONE&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  api_key_required</span> <span class=o>=</span> <span class=kt>false</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>These are the HTTP methods (also known as verbs) that clients can use to interact with the resources. Common methods include GET, POST, PUT, DELETE, and PATCH. Each method represents a different type of operation that can be performed on a resource. For example, a GET method on a &lsquo;users&rsquo; resource might retrieve a list of users, while a POST method on the same resource might create a new user.</p><p><strong>Link API to Lambda function</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;aws_api_gateway_integration&#34; &#34;lambda&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  rest_api_id</span> <span class=o>=</span> <span class=k>aws_api_gateway_rest_api</span><span class=p>.</span><span class=k>DynamoDBOperations</span><span class=p>.</span><span class=k>id</span>
</span></span><span class=line><span class=cl><span class=n>  resource_id</span> <span class=o>=</span> <span class=k>aws_api_gateway_resource</span><span class=p>.</span><span class=k>DynamoDBManager</span><span class=p>.</span><span class=k>id</span>
</span></span><span class=line><span class=cl><span class=n>  http_method</span> <span class=o>=</span> <span class=k>aws_api_gateway_method</span><span class=p>.</span><span class=k>post</span><span class=p>.</span><span class=k>http_method</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  integration_http_method</span> <span class=o>=</span> <span class=s2>&#34;POST&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  type</span>                    <span class=o>=</span> <span class=s2>&#34;AWS&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  uri</span>                     <span class=o>=</span> <span class=k>aws_lambda_function</span><span class=p>.</span><span class=k>example</span><span class=p>.</span><span class=k>invoke_arn</span>
</span></span><span class=line><span class=cl><span class=n>  passthrough_behavior</span>    <span class=o>=</span> <span class=s2>&#34;WHEN_NO_MATCH&#34;</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p><code>uri = aws_lambda_function.example.invoke_arn</code>: This line sets the URI of the integrated backend. In this case, it&rsquo;s a Lambda function, and the ARN (Amazon Resource Name) used to invoke the function is retrieved from another resource named <code>example</code> of type <code>aws_lambda_function</code>.</p><p><strong>Create response code</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;aws_api_gateway_method_response&#34; &#34;response&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  rest_api_id</span> <span class=o>=</span> <span class=k>aws_api_gateway_rest_api</span><span class=p>.</span><span class=k>DynamoDBOperations</span><span class=p>.</span><span class=k>id</span>
</span></span><span class=line><span class=cl><span class=n>  resource_id</span> <span class=o>=</span> <span class=k>aws_api_gateway_resource</span><span class=p>.</span><span class=k>DynamoDBManager</span><span class=p>.</span><span class=k>id</span>
</span></span><span class=line><span class=cl><span class=n>  http_method</span> <span class=o>=</span> <span class=k>aws_api_gateway_method</span><span class=p>.</span><span class=k>post</span><span class=p>.</span><span class=k>http_method</span>
</span></span><span class=line><span class=cl><span class=n>  status_code</span> <span class=o>=</span> <span class=s2>&#34;200&#34;</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p><code>http_method = aws_api_gateway_method.post.http_method</code>: This line sets the HTTP method for the method response. The method is retrieved from another resource of type <code>aws_api_gateway_method</code> with the name <code>post</code>.</p><p>status_code = &ldquo;200&rdquo;: This line sets the HTTP status code for the method response. In this case, it&rsquo;s &ldquo;200&rdquo;, which typically represents a successful HTTP request.</p><p><strong>Integrate response code</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;aws_api_gateway_integration_response&#34; &#34;lambda&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  depends_on</span>  <span class=o>=</span> <span class=p>[</span><span class=k>aws_api_gateway_integration</span><span class=p>.</span><span class=k>lambda</span><span class=p>,</span> <span class=k>aws_api_gateway_method_response</span><span class=p>.</span><span class=k>response</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>  rest_api_id</span> <span class=o>=</span> <span class=k>aws_api_gateway_rest_api</span><span class=p>.</span><span class=k>DynamoDBOperations</span><span class=p>.</span><span class=k>id</span>
</span></span><span class=line><span class=cl><span class=n>  resource_id</span> <span class=o>=</span> <span class=k>aws_api_gateway_resource</span><span class=p>.</span><span class=k>DynamoDBManager</span><span class=p>.</span><span class=k>id</span>
</span></span><span class=line><span class=cl><span class=n>  http_method</span> <span class=o>=</span> <span class=k>aws_api_gateway_method</span><span class=p>.</span><span class=k>post</span><span class=p>.</span><span class=k>http_method</span>
</span></span><span class=line><span class=cl><span class=n>  status_code</span> <span class=o>=</span> <span class=k>aws_api_gateway_method_response</span><span class=p>.</span><span class=k>response</span><span class=p>.</span><span class=k>status_code</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p><code>depends_on = [aws_api_gateway_integration.lambda, aws_api_gateway_method_response.response]</code>: This line specifies that the creation of this resource depends on the successful creation of other resources in order the execute correctly.</p><p>This creates an integration response that depends on the successful creation of the API Gateway integration and method response.</p><p>Both blocks are part of configuring an API Gateway to handle responses from a backend service, in this case, a Lambda function.</p><p><strong>Deploy in &ldquo;Dev&rdquo;</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;aws_api_gateway_deployment&#34; &#34;dev&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  depends_on</span>  <span class=o>=</span> <span class=p>[</span><span class=k>aws_api_gateway_integration</span><span class=p>.</span><span class=k>lambda</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>  rest_api_id</span> <span class=o>=</span> <span class=k>aws_api_gateway_rest_api</span><span class=p>.</span><span class=k>DynamoDBOperations</span><span class=p>.</span><span class=k>id</span>
</span></span><span class=line><span class=cl><span class=n>  stage_name</span>  <span class=o>=</span> <span class=s2>&#34;dev&#34;</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>This deploys our API to the &ldquo;dev&rdquo; stage, generating our invoke URL that we will use to interact with the API</p><p><img loading=lazy src=/posts/serverless_api/api.png alt=api></p><h3 id=output-api-invoke-url>Output API Invoke URL<a hidden class=anchor aria-hidden=true href=#output-api-invoke-url>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>output</span> <span class=s2>&#34;api_invoke_url&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  description</span> <span class=o>=</span> <span class=s2>&#34;api_invoke_url&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  value</span>       <span class=o>=</span> <span class=s2>&#34;${aws_api_gateway_deployment.dev.invoke_url}/${aws_api_gateway_resource.DynamoDBManager.path_part}&#34;</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>This line from <code>outputs.tf</code> prints out our Invoke URL generated earlier, and displays it after <code>terraform apply</code>.</p><p><img loading=lazy src=/posts/serverless_api/output.png alt=output></p><h2 id=test-with-api-client>Test with API Client<a hidden class=anchor aria-hidden=true href=#test-with-api-client>#</a></h2><p>Open Bruno. Create Collection > New Request > Paste the invoke URL generated inside URL: POST</p><p><img loading=lazy src=/posts/serverless_api/api-client.png alt=api-client></p><p>Then in the BODY section, select Raw > JSON, past the code below, and press cmd+enter to execute</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;operation&#34;</span><span class=p>:</span> <span class=s2>&#34;create&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;tableName&#34;</span><span class=p>:</span> <span class=s2>&#34;lambda-apigateway&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;payload&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;Item&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;1234ABCD&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;number&#34;</span><span class=p>:</span> <span class=mi>88</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=verify-results-in-dynamodb>Verify Results in DynamoDB<a hidden class=anchor aria-hidden=true href=#verify-results-in-dynamodb>#</a></h2><p>Go to DynamoDB > Tables > lambda-apigateway > Explore Table Items
<img loading=lazy src=/posts/serverless_api/dynamodb.png alt=dynamodb></p><p>Here you&rsquo;ll see that our POST payload, sent to the API Invoke URL, interacts with Lambda, which in turn modifies our DynamoDB table.</p><h2 id=clean-up>Clean up<a hidden class=anchor aria-hidden=true href=#clean-up>#</a></h2><p><img loading=lazy src=/posts/serverless_api/destroy.png alt=destroy></p><p>Run this command to delete all our previously created resources and configurations.</p><h2 id=key-takeaways>Key Takeaways<a hidden class=anchor aria-hidden=true href=#key-takeaways>#</a></h2><p>We&rsquo;ve created an API that is publicly accessible via our Invoke URL, which allows us to interact with the DynamoDB table directly via a Lambda function.</p><p>In future articles, we&rsquo;ll delve deeper into GitOps, and CI/CD pipelines building on this knowledge, and implement authentication, DNS and certificate configurations.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://tbalza.net/tags/terraform/>Terraform</a></li><li><a href=https://tbalza.net/tags/lambda/>Lambda</a></li><li><a href=https://tbalza.net/tags/aws/>Aws</a></li><li><a href=https://tbalza.net/tags/api/>Api</a></li><li><a href=https://tbalza.net/tags/dynamodb/>Dynamodb</a></li></ul><nav class=paginav><a class=next href=https://tbalza.net/deploy-a-hugo-powered-blog-on-github-pages-using-github-actions/><span class=title>Next »</span><br><span>Deploy a Hugo-powered Blog on Github Pages using Github Actions</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://tbalza.net/>Tomas Balza</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>