<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Container Orchestration of HA Application with ECS | Tomas Balza</title>
<meta name=keywords content="docker,terraform,ecs,ssl,bash,dns"><meta name=description content="This guide outlines the steps to launch a highly available WordPress application, structured as a four-tier architecture, using ECS for container orchestration."><meta name=author content><link rel=canonical href=https://tbalza.net/container-orchestration-of-ha-application-with-ecs/><link crossorigin=anonymous href=/assets/css/stylesheet.72f49d8e688f8b26198abd212dc2ce9fe1d22eddc415e9c17e8ac38ab047d5ab.css integrity="sha256-cvSdjmiPiyYZir0hLcLOn+HSLt3EFenBforDirBH1as=" rel="preload stylesheet" as=style><link rel=icon href=https://tbalza.net/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://tbalza.net/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://tbalza.net/favicon-32x32.png><link rel=apple-touch-icon href=https://tbalza.net/apple-touch-icon.png><link rel=mask-icon href=https://tbalza.net/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://tbalza.net/container-orchestration-of-ha-application-with-ecs/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Container Orchestration of HA Application with ECS"><meta property="og:description" content="This guide outlines the steps to launch a highly available WordPress application, structured as a four-tier architecture, using ECS for container orchestration."><meta property="og:type" content="article"><meta property="og:url" content="https://tbalza.net/container-orchestration-of-ha-application-with-ecs/"><meta property="og:image" content="https://tbalza.net/posts/docker_wordpress/cover.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-03-20T00:00:00+00:00"><meta property="article:modified_time" content="2024-03-20T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://tbalza.net/posts/docker_wordpress/cover.png"><meta name=twitter:title content="Container Orchestration of HA Application with ECS"><meta name=twitter:description content="This guide outlines the steps to launch a highly available WordPress application, structured as a four-tier architecture, using ECS for container orchestration."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://tbalza.net/posts/"},{"@type":"ListItem","position":2,"name":"Container Orchestration of HA Application with ECS","item":"https://tbalza.net/container-orchestration-of-ha-application-with-ecs/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Container Orchestration of HA Application with ECS","name":"Container Orchestration of HA Application with ECS","description":"This guide outlines the steps to launch a highly available WordPress application, structured as a four-tier architecture, using ECS for container orchestration.","keywords":["docker","terraform","ecs","ssl","bash","dns"],"articleBody":"This guide outlines the steps to launch a highly available WordPress application, structured as a four-tier architecture, using ECS for container orchestration.\nOur final infrastructure will look like this,\nFind the complete setup on instructions in the GitHub repository.\nWordPress WordPress is a widely used CMS powering a significant portion of the internet’s websites.\nWordPress rose to popularity quickly because of its up-to-date development framework, extensive feature set, flexibility, rapid and multilingual publishing ability, multi-author support, and thriving community. Thousands of free and commercial themes and plugins are available to extend and personalize WordPress for just about every situation. (From bitnami.com)\nTraditionally, WordPress operates as a monolithic application. However, by leveraging Docker, AWS RDS, and EFS, we can transform it into a stateless architecture. This decouples the computing layer from the rest of the infrastructure, enhancing flexibility. Specifically, it allows us to run multiple servers behind load balancers, thereby achieving high availability.\nIn this setup, Docker containers play a crucial role by encapsulating the WordPress application, making it portable and consistent across different computing environments. This ties into the broader architectural tiers by ensuring the application layer is both scalable and resilient.\nFurthermore, the separation of storage (via EFS) and database services (using RDS) enables more robust and isolated backups, as well as seamless rolling updates. This approach ensures that ongoing user sessions remain unaffected, eliminating downtime during updates.\nAdopting Modern Development Practices In our projects, we prioritize technologies that embrace modern development methodologies, including Continuous Integration/Continuous Deployment (CI/CD) and Infrastructure as Code (IaC). We advocate for the following practices:\nAutomated deployment and provisioning of all infrastructure components. Seamless rolling updates for services, ensuring zero downtime. Version-controlled infrastructure changes, treat your infrastructure setup as you would with application code. Unified codebase catering to multiple environments like development and production. Comprehensive monitoring capabilities for crucial components and resources, utilizing metrics for performance insights. Automation Focus\nThis guide primarily covers automation techniques for deployments, project structuring, while deferring in-depth development principles to another discussion.\nPlease note, while AWS resources may lead to costs, our Terraform-guided process simplifies the removal of all resources with the terraform destroy command to prevent unnecessary expenses.\nContainer Orchestration with ECS on EC2\nECS on EC2 provides a versatile environment for running Docker containerized services, supporting applications of any scale or type. Our setup involves managing EC2 instances, ensuring service internet accessibility and high availability by deploying across multiple Availability Zones with dynamic scaling through an Autoscaling Policy.\nECS EC2 versus Fargate\nWhile Fargate offers a serverless alternative, eliminating infrastructure management, it may lead to higher costs with extensive memory usage. ECS on EC2, conversely, grants more flexibility in instance types and running specific tasks like daemon agents. The choice between ECS on EC2 and Fargate hinges on your team’s expertise, infrastructure management capabilities, and specific needs such as running specialized software.\nKey Components of Our Setup WordPress: This is the CMS platform we’ll be deploying in our environment. Elastic Container Service (ECS): Utilizes clusters, services, and tasks for service operation. Elastic File System (EFS): Ensures persistent application data. Relational Database Service (RDS): Manages database operations. Secrets Manager: Secures sensitive information like passwords. Certificate Manager: Manages SSL certificates, with domain DNS handled externally by CloudFlare. Application Load Balancer (ALB): Directs requests to various container instances. Autoscaling Group (ASG): Provides EC2 instance scaling and high availability. Security Groups: Implements firewall rules for EC2 instances and ALBs. Virtual Private Cloud (VPC): Encapsulates subnets and internet gateways, distinguishing between public subnets for the ALB and private subnets for ECS services. Permissions Requirements In cloud environments like AWS, permissions and roles serve as foundational elements in securing and defining what resources and actions various entities (like services, users, or applications) are allowed or denied. Here’s a high-level explanation in relation to the setup:\nSecurity Groups: Act as virtual firewalls that control the traffic allowed to and from ECS containers, ensuring only authorized network requests (like those from an ALB) are permitted. ECS Task Role: Assigns specific permissions to ECS tasks, enabling them to interact with other AWS services like S3 for storage, CloudWatch for logging, or EFS for file systems without embedding sensitive credentials within the containers. Trust Relationship Policy: Establishes a trust where ECS tasks are permitted to assume a role, enabling actions like pulling images or managing resources based on the defined permissions (like AmazonECSTaskExecutionRolePolicy). EC2 Role: Similar to the ECS Task Role, it assigns permissions to the EC2 instances within the cluster to interact with AWS services necessary for their operation, like EFS or the EC2 Container Service itself. Listeners and Target Group: Direct traffic from the ALB to the appropriate backend services based on the request, enabling secure and efficient traffic management. A heads-up: Grasping the following details requires a thorough understanding of each AWS service and the complex ways in which different permission levels interweave. Below is a service-by-service breakdown, detailing the necessary configurations to facilitate communication between individual services.\n1. Amazon Elastic Container Service (ECS):\nECS Security Group (Inbound): Allow traffic from the Application Load Balancer (ALB). ECS Security Group (Outbound): Allow traffic to Amazon RDS, ECS, and the internet. ECS Task Role: Allows ECS tasks to interact with specific AWS services. AmazonECSTaskExecutionRolePolicy: Allows ECS tasks to make API requests to ECS. AmazonS3FullAccess: Required if the setup needs S3 access for backups or media storage. CloudWatchLogsFullAccess: Allows tasks to send logs to Amazon CloudWatch. AmazonElasticFileSystemClientFullAccess: Grants access to EFS. Trust Relationship Policy: Principal: ecs-tasks.amazonaws.com Action: sts:AssumeRole ECS Task Execution Role: Used by: ECS agent and Docker daemon to pull images and manage resources. AmazonECSTaskExecutionRolePolicy Trust Relationship Policy: Principal: ecs-tasks.amazonaws.com Action: sts:AssumeRole 2. Amazon EC2 Instance (from EC2 cluster):\nEC2 Role (defined in ASG module): AmazonEC2ContainerServiceforEC2Role AmazonSSMManagedInstanceCore AmazonElasticFileSystemClientFullAccess EC2 Security Group (defined in ASG module): Inbound: Allow traffic on ports 80, 3306, and 2049 from VPC private subnets. 3. Amazon RDS:\nSecurity Group: Inbound: Allow traffic from the ECS Security Group on MySQL port 3306. 4. Application Load Balancer (ALB):\nSecurity Group: Inbound: Allow traffic on ports 80 (HTTP) and 443 (HTTPS). Outbound: Allow rules to communicate with VPC CIDR block. Listeners: HTTP 80: Redirect to HTTPS 443. HTTPS 443: Forward to the ECS target group. Target Group: Backend protocol: HTTP. Backend port: 8080 5. Auto Scaling Group (ASG):\nSecurity Group: Use the EC2 security group. Policies Required for Associated Roles: AmazonEC2AutoScalingFullAccess 6. Amazon Elastic File System (EFS):\nSecurity Groups: Inbound: Allow traffic on port 2049 from VPC private subnets. Mount Targets: Create in each Availability Zone used by ECS instances or tasks. Overall, permissions and roles are essential in this setup for ensuring that each component operates securely, interacts properly with other services, and has access to only the resources necessary for its function, following the principle of least privilege.\nTerraform Registry Modules This configuration utilizes modules to enhance the efficiency and organization of infrastructure provisioning.\nA module, a superior construct within Terraform, consolidates multiple resources into a single, reusable package. Available from sources such as the Terraform Registry, these modules embody best practices and facilitate consistent application across various projects. They are crafted from resources—the elemental components of Terraform like compute instances or databases—which are the foundational elements for sculpting the anticipated state of infrastructure.\nAdvantages of Utilizing Modules:\nSimplification: Consolidates various resources and methodologies into a unified entity. Standardization: Ensures uniform creation of resources. Versioning: Facilitates seamless updates and straightforward rollbacks. Community-Tested: Guarantees dependability through extensive community review. Maintenance: Streamlines the update and maintenance processes. Documentation: Offers comprehensive instructions and examples. While modules cater to a broad range of needs, direct use of provider resources is warranted for highly customized scenarios or specific requirements not addressed by existing modules. Nonetheless, a hybrid approach, combining modules with direct resource utilization, can often provide the most comprehensive solution, filling in any gaps to achieve the desired infrastructure configuration.\nIn essence, modules render Terraform configurations more streamlined and standardized, striking an optimal balance between ease of use and the ability to tailor to specific needs.\nVPC module \"vpc\" { source = \"terraform-aws-modules/vpc/aws\" version = \"~\u003e 5.0\" name = local.name cidr = local.vpc_cidr azs = local.azs public_subnets = [for k, v in local.azs : cidrsubnet(local.vpc_cidr, 8, k)] private_subnets = [for k, v in local.azs : cidrsubnet(local.vpc_cidr, 8, k + 3)] database_subnets = [for k, v in local.azs : cidrsubnet(local.vpc_cidr, 8, k + 6)] create_database_subnet_group = true enable_nat_gateway = true single_nat_gateway = true } output \"alb\" { value = module.alb.dns_name } This module efficiently establishes a secure, highly available AWS VPC with structured network segmentation (public, private, database subnets) enhancing resilience across multiple zones. Public subnets connect directly to the internet via an Internet Gateway. Private and database subnets, routed for internal traffic, use a NAT Gateway, enabling internet access without external exposure.\nECS Cluster module \"ecs_cluster\" { source = \"terraform-aws-modules/ecs/aws//modules/cluster\" version = \"~\u003e 5.10\" cluster_name = local.name cloudwatch_log_group_retention_in_days = 1 # Capacity provider - autoscaling groups default_capacity_provider_use_fargate = false autoscaling_capacity_providers = { # On-demand instances ex_1 = { auto_scaling_group_arn = module.autoscaling[\"ex_1\"].autoscaling_group_arn managed_termination_protection = \"DISABLED\" managed_scaling = { # Enabling would allow for autoscaling instances maximum_scaling_step_size = 1 minimum_scaling_step_size = 1 status = \"DISABLED\" target_capacity = 100 } default_capacity_provider_strategy = { # This would be edited for multiple capacity providers weight = 60 base = 20 } } } } Since we are not yet using auto-scaling, this module only defines the cluster name and the capacity provider, that will be used later on by the service. (The provider strategy is a placeholder for later implementation)\nECS Service module \"ecs_service\" { source = \"terraform-aws-modules/ecs/aws//modules/service\" version = \"~\u003e 5.10\" # Service name = local.name cluster_arn = module.ecs_cluster.arn cpu = 1843 # CPU units for the task, reserving some for system overhead (t3.micro) memory = 724 # Memory for the task, reserving system overhead (t3.micro) # Task Definition (The Task IAM role is defined in the Autoscaling module) requires_compatibilities = [\"EC2\"] capacity_provider_strategy = { # On-demand instances ex_1 = { capacity_provider = module.ecs_cluster.autoscaling_capacity_providers[\"ex_1\"].name weight = 1 base = 1 } } # EFS volume volume = { wordpress_data = { efs_volume_configuration = { file_system_id = module.efs.id transit_encryption = \"ENABLED\" authorization_config = { access_point_id = module.efs.access_points[\"root\"][\"id\"] iam = \"ENABLED\" } } } } load_balancer = { service = { target_group_arn = module.alb.target_groups[\"ex_ecs\"].arn container_name = local.container_name container_port = local.container_port } } subnet_ids = module.vpc.private_subnets security_group_rules = { alb_http_ingress = { type = \"ingress\" from_port = local.container_port to_port = local.container_port protocol = \"tcp\" description = \"Service port\" source_security_group_id = module.alb.security_group_id }, \"allow-internet\" = { # to fetch docker image outside AWS (not in ECR) type = \"egress\" protocol = \"all\" cidr_blocks = [\"0.0.0.0/0\"] from_port = 0 to_port = 0 } } } Using a t3.micro instance for testing purposes, here we’re maxing out a single task (minus the aws agent overhead) to occupy the total available computing resources (CPU and memory). Additionally, we define a snippet of the container definition, where we configure the first stage for using an EFS volume for data storage. Furthermore, we connect the ecs task to the load balancer telling it will receive traffic on port 8080.\nThe volume definition allows the docker container to have WordPress data persistence outside the container itself.\nIf we were using a docker-compose.yml file this chunk,\nvolume = { wordpress_data = { efs_volume_configuration = { file_system_id = module.efs.id transit_encryption = \"ENABLED\" authorization_config = { access_point_id = module.efs.access_points[\"root\"][\"id\"] iam = \"ENABLED\" } } } } Would be the ECS equivalent of this,\nContainer Definitions # Container definition(s) container_definitions = { (local.container_name) = { image = \"docker.io/bitnami/wordpress:6\" user = \"root\" # Ideally run docker container as non-root user essential = true port_mappings = [ { name = local.container_name containerPort = local.container_port # Port 8080 is bitnami container default hostPort = local.container_port # ALB listens on port 80, forwards to target group on port 8080 } ] cpu = 1843 # Allocate nearly all CPU units to this container memory = 724 # Allocate majority of memory to this container environment = [ { name = \"WORDPRESS_DATABASE_HOST\" value = module.rds.db_instance_address }, { name = \"WORDPRESS_DATABASE_PORT_NUMBER\" value = 3306 }, { name = \"WORDPRESS_DATABASE_USER\" value = \"wordpress\" }, { name = \"WORDPRESS_DATABASE_NAME\" value = \"wordpressdb\" }, { name = \"WORDPRESS_USERNAME\" value = \"wordpress\" }, { name = \"WORDPRESS_ENABLE_HTTPS\" value = \"yes\" }, { name = \"WORDPRESS_VOLUME_DIR\" value = \"/mnt/efs/\" }, ] secrets = [ { name = \"WORDPRESS_DATABASE_PASSWORD\" valueFrom = module.secret_db_password.secret_arn }, { name = \"WORDPRESS_PASSWORD\" valueFrom = module.secret_user_password.secret_arn } ] mount_points = [ { sourceVolume = \"wordpress_data\", containerPath = \"/bitnami/wordpress\" # by default wp-config.php wp-content are persisted, env WORDPRESS_DATA_TO_PERSIST readOnly = false } ] readonly_root_filesystem = false enable_cloudwatch_logging = true create_cloudwatch_log_group = true cloudwatch_log_group_name = \"/aws/ecs/${local.name}/${local.container_name}\" cloudwatch_log_group_retention_in_days = 1 log_configuration = { logDriver = \"awslogs\" } } } The current Bitnami image used for deploying an ECS EC2 application offers a ready-to-use, standardized solution that reduces setup time and maintains consistency across different settings.\nConversely, an extensive CI/CD pipeline using Docker provides significantly more customization and control. In this framework, developers can tailor Docker images to specific requirements, update and manage versions through a Version Control System (VCS), and monitor modifications over time.\nFor our purposes, this image supports customization through environment variables specified in the container definitions.\nAdditionally, we set the parameters for cloudwatch to log the events related to our task.\nALB # Extract the last version of AWS Optimized AMI for ECS data \"aws_ssm_parameter\" \"ecs_optimized_ami\" { name = \"/aws/service/ecs/optimized-ami/amazon-linux-2/recommended\" } module \"alb\" { source = \"terraform-aws-modules/alb/aws\" version = \"~\u003e 9.0\" name = local.name load_balancer_type = \"application\" vpc_id = module.vpc.vpc_id subnets = module.vpc.public_subnets # For example only enable_deletion_protection = false # Security Group security_group_ingress_rules = { all_http = { from_port = 80 to_port = 80 ip_protocol = \"tcp\" description = \"HTTP web traffic\" cidr_ipv4 = \"0.0.0.0/0\" } all_https = { from_port = 443 to_port = 443 ip_protocol = \"tcp\" description = \"HTTPS web traffic\" cidr_ipv4 = \"0.0.0.0/0\" } } security_group_egress_rules = { all = { ip_protocol = \"-1\" cidr_ipv4 = module.vpc.vpc_cidr_block } } listeners = { ex-http-https-redirect = { port = 80 protocol = \"HTTP\" redirect = { port = \"443\" protocol = \"HTTPS\" status_code = \"HTTP_301\" } } ex-https = { port = 443 protocol = \"HTTPS\" ssl_policy = \"ELBSecurityPolicy-TLS13-1-2-Res-2021-06\" certificate_arn = module.acm.acm_certificate_arn forward = { target_group_key = \"ex_ecs\" } } } target_groups = { ex_ecs = { backend_protocol = \"HTTP\" backend_port = local.container_port target_type = \"ip\" deregistration_delay = 5 load_balancing_cross_zone_enabled = true health_check = { enabled = true healthy_threshold = 5 interval = 30 matcher = \"200\" path = \"/\" port = \"traffic-port\" protocol = \"HTTP\" timeout = 5 unhealthy_threshold = 2 } # Theres nothing to attach here in this definition. Instead, # ECS will attach the IPs of the tasks to this target group create_attachment = false } } tags = local.tags } This block sets up an AWS Application Load Balancer (ALB) redirecting all HTTP traffic to HTTPS, and then all that TLS traffic to our target group that listens on 8080 (forward to ex_ecs). It also sets up health monitoring.\nAutoscaling module \"autoscaling\" { source = \"terraform-aws-modules/autoscaling/aws\" version = \"~\u003e 6.5\" for_each = { # On-demand instances ex_1 = { instance_type = \"t3.micro\" use_mixed_instances_policy = false } } name = local.name image_id = jsondecode(data.aws_ssm_parameter.ecs_optimized_ami.value)[\"image_id\"] instance_type = \"t3.micro\" instance_market_options = { market_type = \"spot\" # Lower cost for testing purposes } security_groups = [aws_security_group.autoscaling_sg.id] user_data = base64encode(local.on_demand_user_data) ignore_desired_capacity_changes = true create_iam_instance_profile = true iam_role_name = local.name iam_role_description = \"ECS role for ${local.name}\" iam_role_policies = { AmazonEC2ContainerServiceforEC2Role = \"arn:aws:iam::aws:policy/service-role/AmazonEC2ContainerServiceforEC2Role\" AmazonSSMManagedInstanceCore = \"arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore\" EFSFullAccess = aws_iam_policy.efs_full_access.arn RDSFullAccess = aws_iam_policy.rds_full_access.arn ecs-secrets-manager-access = aws_iam_policy.secrets_manager_access.arn } vpc_zone_identifier = module.vpc.private_subnets health_check_type = \"EC2\" min_size = 2 # Make task Highly Available maintaining 2 ec2 instances across each AZ max_size = 4 # Allow for temporary creation of extra instances while reaching desired capacity desired_capacity = 2 # https://github.com/hashicorp/terraform-provider-aws/issues/12582 autoscaling_group_tags = { AmazonECSManaged = true } # Required for managed_termination_protection = \"ENABLED\" protect_from_scale_in = false } This further links ECS with the load balancer. It defines our Highly Available desired state, where to instances should be always available redundantly in two different AZs.\nIt sets the required policies to grant permissions to the EC2 instance itself for accessing the ECS container management, SSM for instance configuration (and console access), EFS for file storage access, RDS for database access, and access to the Secrets Manager.\nAdditionally, it defines that a payload should be run on the provisioned ec2 instances before the container service runs.\nBash Script on_demand_user_data = \u003c\u003c-EOT #!/bin/bash yum install -y amazon-efs-utils mkdir -p /mnt/efs mount -t efs -o tls,accesspoint=${module.efs.access_points[\"root\"][\"id\"]} ${module.efs.id}:/ /mnt/efs echo '${module.efs.id}:/ /mnt/efs efs tls,accesspoint=${module.efs.access_points[\"root\"][\"id\"]} 0 0' \u003e\u003e /etc/fstab cat \u003c\u003c'EOF' \u003e\u003e /etc/ecs/ecs.config ECS_CLUSTER=${local.name} ECS_LOGLEVEL=debug ECS_CONTAINER_INSTANCE_TAGS=${jsonencode(local.tags)} ECS_ENABLE_TASK_IAM_ROLE=true EOF EOT Since we’re not on fargate, our ec2 instance needs to know that it belongs to de cluster we defined earlier.\nIt also needs to install the efs-utils agent, and mount it to /mnt/efs before the container runs, so it can successfully mount the persistent volume defined earlier in the container definitions.\nWithout this crucial step or instance won’t be ready to connect to the container, and the volume will not mount correctly, and instead create internal volumes on the attached SSD very time it’s instantiated,\nSecurity Groups # Security Groups for EC2 instances resource \"aws_security_group\" \"autoscaling_sg\" { name = \"autoscaling_sg\" description = \"Autoscaling group security group\" vpc_id = module.vpc.vpc_id tags = local.tags } resource \"aws_security_group_rule\" \"ingress_http_from_alb\" { # HTTP type = \"ingress\" from_port = 80 to_port = 80 protocol = \"tcp\" security_group_id = aws_security_group.autoscaling_sg.id source_security_group_id = module.alb.security_group_id } resource \"aws_security_group_rule\" \"ingress_mysql_from_alb\" { # RDS type = \"ingress\" from_port = 3306 to_port = 3306 protocol = \"tcp\" security_group_id = aws_security_group.autoscaling_sg.id source_security_group_id = module.alb.security_group_id # Adjust this if the source is not the ALB } resource \"aws_security_group_rule\" \"ingress_nfs_from_alb\" { # EFS type = \"ingress\" from_port = 2049 to_port = 2049 protocol = \"tcp\" security_group_id = aws_security_group.autoscaling_sg.id source_security_group_id = module.alb.security_group_id # Adjust this if the source is not the ALB } resource \"aws_security_group_rule\" \"egress_all\" { type = \"egress\" from_port = 0 to_port = 0 protocol = \"-1\" # Represents all protocols security_group_id = aws_security_group.autoscaling_sg.id cidr_blocks = [\"0.0.0.0/0\"] # Allows all outbound traffic } # Role Policies to add to EC2 Role resource \"aws_iam_policy\" \"efs_full_access\" { name = \"EFSFullAccess\" description = \"Provides full access to EFS\" policy = jsonencode({ Version = \"2012-10-17\" Statement = [{ Action = \"elasticfilesystem:*\" Effect = \"Allow\" Resource = \"*\" }] }) } # elasticfilesystem:Describe* elasticfilesystem:ClientWrite elasticfilesystem:ClientMount # \"Resource\": \"${module.efs.arn}\" resource \"aws_iam_policy\" \"rds_full_access\" { name = \"RDSFullAccess\" description = \"Provides full access to RDS\" policy = jsonencode({ Version = \"2012-10-17\" Statement = [{ Action = \"rds:*\" Effect = \"Allow\" Resource = \"*\" }] }) } This is an example of the trade-off between modules and using direct resources. Since the modules don’t directly support connecting RDS and EFS, we can create the necessary security groups for added services to interact.\nRDS module \"rds\" { source = \"terraform-aws-modules/rds/aws\" version = \"~\u003e 6.5.2\" identifier = \"rds\" engine = \"mysql\" engine_version = \"8.0\" family = \"mysql8.0\" # DB parameter group major_engine_version = \"8.0\" # DB option group instance_class = \"db.t4g.micro\" storage_type = \"gp3\" allocated_storage = 20 max_allocated_storage = 100 availability_zone = module.vpc.azs[0] depends_on = [module.secret_db_password] username = \"wordpress\" password = data.aws_secretsmanager_secret_version.secret_db_password.secret_string # fetch actual password string from secrets manger db_name = \"wordpressdb\" port = 3306 manage_master_user_password = false iam_database_authentication_enabled = false skip_final_snapshot = true create_db_option_group = false db_subnet_group_name = module.vpc.database_subnet_group vpc_security_group_ids = [module.security_group.security_group_id] } module \"security_group\" { source = \"terraform-aws-modules/security-group/aws\" version = \"~\u003e 5.0\" name = local.name description = \"EC2 docker access to RDS\" vpc_id = module.vpc.vpc_id ingress_with_cidr_blocks = [ { # RDS Ingress from_port = 3306 to_port = 3306 protocol = \"tcp\" description = \"MySQL access from within VPC\" cidr_blocks = module.vpc.vpc_cidr_block }, ] tags = local.tags } Here we simply create the rds instance, and set the password to be retrieved from the secrets manager later on. The depends_on definition makes sure the module has generated the password before it’s executed. This usually isn’t required because TF can figure out execution order dependencies, but in this case it is warranted.\nEFS module \"efs\" { source = \"terraform-aws-modules/efs/aws\" version = \"~\u003e 1.6.1\" # File system name = local.name creation_token = local.name encrypted = false #kms_key_arn = module.kms.key_arn performance_mode = \"generalPurpose\" throughput_mode = \"bursting\" lifecycle_policy = { transition_to_ia = \"AFTER_30_DAYS\" transition_to_primary_storage_class = \"AFTER_1_ACCESS\" } # File system policy attach_policy = true bypass_policy_lockout_safety_check = false # for KMS key management deny_nonsecure_transport = false # Allow non encrypted traffic for testing policy_statements = [ { sid = \"Example\" actions = [\"elasticfilesystem:*\"] principals = [ { type = \"AWS\" identifiers = [\"*\"] } ] } ] # Replace \"*\" with [module.ecs_service.tasks_iam_role_arn] # Mount targets / security group mount_targets = { for k, v in zipmap(local.azs, module.vpc.private_subnets) : k =\u003e { subnet_id = v } } security_group_description = \"Example EFS security group\" security_group_vpc_id = module.vpc.vpc_id security_group_rules = { vpc = { # Relying on the defaults provided for EFS/NFS (2049/TCP + ingress) description = \"NFS ingress from VPC private subnets\" cidr_blocks = module.vpc.private_subnets_cidr_blocks } } # Access point(s) access_points = { posix = { # Used for strict security controls and user isolation name = \"posix-example\" posix_user = { gid = 1001 uid = 1001 secondary_gids = [1002] } tags = { Additional = \"Wordpress EFS\" } } root = { # Default root_directory = { path = \"/\" creation_info = { owner_gid = 0 # Non-root user is 1001. (as defined in dockerfile) root is 0 owner_uid = 0 # Non-root user is 1001. (as defined in dockerfile) root is 0 permissions = \"755\" } } } } } When our container can mount and read/write with our EFS filesystem, the volumes from its perspective looks like this. 8 exabytes, tells us about the potential scalability of this service (also warns us of reasons it could get out hand and need monitoring)\nACM # Obtain SSL certificate module \"acm\" { source = \"terraform-aws-modules/acm/aws\" version = \"~\u003e 5.0.1\" domain_name = \"wp.tbalza.net\" validation_method = \"DNS\" wait_for_validation = false create_route53_records = false tags = { Name = \"wp.tbalza.net\" } } Configuring TLS is deceptively simple in this setup. We don’t need Route53 at all, since our namecheap.com registrar points to Cloudflare NS records, which can be managed via API tokens that later define our CNAME records. We simply generate the certificate with AWS with DNS verification and pass that on to our next module.\nDNS # Validate ACM SSL certificate. Uses the output of acm module to to complete DNS validation in CloudFlare variable \"validation_record_keys\" { type = list(string) default = [\"record1\", \"record2\", \"record3\", \"record4\"] # Adjust based on the number of expected ACM validation records } locals { # The output is a map within a single list item, iterate through to define values acm_validation_records = { for idx, val in module.acm.acm_certificate_domain_validation_options : \"record${idx + 1}\" =\u003e { name = val.resource_record_name # Will appear as unresolved ref before apply value = val.resource_record_value # Will appear as unresolved ref before apply } } } resource \"cloudflare_record\" \"acm_validation\" { for_each = local.acm_validation_records zone_id = var.cloudflare_zone_id name = each.value.name # Will appear as unresolved ref before apply type = \"CNAME\" value = each.value.value # Will appear as unresolved ref before apply ttl = 1 proxied = false } # Create wp. subdomain for ALB. Update DNS (managed by CloudFlare) CNAME to point wp.tbalza.net to ALB provider \"cloudflare\" { api_token = var.cloudflare_api_token # Ensure you have this variable in your variables.tf or passed in via environment variables } resource \"cloudflare_record\" \"wp_cname\" { zone_id = var.cloudflare_zone_id # Ensure you have this variable in your variables.tf or passed in via environment variables name = \"wp\" value = module.alb.dns_name type = \"CNAME\" proxied = false } Our nanecheap.com domain tbalza.net (which is hosted by GitHub pages, as per the first blog post) was changed to Cloudflare DNS management, by pointed to their NS records.\nWith our Cloudflare API token, we can take the output of module.acm.acm_certificate_domain_validation_options that generates a map within a list and with TF convert this output, to call for the change of the CNAME wp. to be that which is dynamically generated by AWS.\nSecrets Manager data \"aws_caller_identity\" \"current\" {} # Allow ECS tasks to access secrets resource \"aws_iam_policy\" \"secrets_manager_access\" { name = \"ecs-secrets-manager-access\" description = \"Allows ECS tasks to access secrets in Secrets Manager\" policy = jsonencode({ Version = \"2012-10-17\", Statement = [ { Action = [ \"secretsmanager:GetSecretValue\", \"secretsmanager:DescribeSecret\" ], Effect = \"Allow\", Resource = \"*\" # It's better to specify exact ARNs of secrets } ] }) } # Generate wordpress db password data \"aws_secretsmanager_secret_version\" \"secret_db_password\" { # required to return the actual pw string for the RDS module secret_id = module.secret_db_password.secret_id depends_on = [module.secret_db_password] } module \"secret_db_password\" { source = \"terraform-aws-modules/secrets-manager/aws\" version = \"~\u003e 1.1.2\" name_prefix = \"wordpress-db-password-\" description = \"Secret for WordPress Database Password\" create_random_password = true random_password_length = 41 # RDS length limit random_password_override_special = \"_\" # list of permitted special characters } # Generate wordpress user password data \"aws_secretsmanager_secret_version\" \"secret_user_password\" { secret_id = module.secret_user_password.secret_id depends_on = [module.secret_user_password] } module \"secret_user_password\" { source = \"terraform-aws-modules/secrets-manager/aws\" version = \"~\u003e 1.1.2\" name_prefix = \"wordpress-user-password-\" description = \"Secret for WordPress User Password\" create_random_password = true random_password_length = 41 # RDS length limit random_password_override_special = \"_\" # list of permitted special characters } Conclusions We’ve successfully set up a high-availability environment ensuring our application layer is both scalable and resilient. Additionally, by separating storage with EFS and database operations via RDS, we’ve ensured stronger, more isolated backups and enabled smoother rolling updates. This design keeps the user experience uninterrupted, significantly reducing downtime during updates.\nAreas for Improvement Autoscaling: Refine autoscaling by adjusting the desired_count based on real-time needs. This ensures our setup can dynamically allocate resources and ECS Tasks according to our Target Tracking Policy without resetting our capacity planning with each deployment.\nPrinciple of Least Privilege: Tighten security by refining ARN/actions/resources to uphold the principle of least privilege, ensuring containers operate securely without root access.\nCloudFront: Optimize our setup further, reducing load on our compute resources by serving static files from closer to the user by adding a caching layer with CloudFront.\nCI/CD Integration: Integrate with CI/CD systems like Jenkins or CircleCI, using unique Git commit hashes to manage deployments. This ensures continuous integration and deployment for every change, maintaining a smooth and consistent update process.\nTagging Strategy: Ensure all resources are properly tagged to streamline billing and management.\nBackup Procedures: Automate backup processes for RDS and EFS will be a priority to safeguard our data effectively.\nMonitoring and Alerts: Implement monitoring solutions with tools like Grafana, coupled with SNS notifications, to stay ahead of scaling events and other significant system events.\nLooking Ahead In our next piece, we’ll dive into the implementation of CI/CD systems and explore real-world production scenarios, including Git operations and rolling updates, to further enhance our setup.\n","wordCount":"4448","inLanguage":"en","image":"https://tbalza.net/posts/docker_wordpress/cover.png","datePublished":"2024-03-20T00:00:00Z","dateModified":"2024-03-20T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://tbalza.net/container-orchestration-of-ha-application-with-ecs/"},"publisher":{"@type":"Organization","name":"Tomas Balza","logo":{"@type":"ImageObject","url":"https://tbalza.net/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://tbalza.net/ accesskey=h title="Tomas Balza (Alt + H)"><img src=https://tbalza.net/profile-photo-2.jpg alt aria-label=logo height=35>Tomas Balza<p id=subtitle>DevOps / Tech Articles</p></a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://github.com/tbalza title=GitHub><span>GitHub</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://www.linkedin.com/in/tomas-balza-b075141b3 title=LinkedIn><span>LinkedIn</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://www.youtube.com/@tbalza-tech title=YouTube><span>YouTube</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Container Orchestration of HA Application with ECS</h1><div class=post-meta><span title='2024-03-20 00:00:00 +0000 UTC'>March, 2024</span>&nbsp;&nbsp;&nbsp;<a href=/tags/docker> docker</a> <a href=/tags/terraform>terraform</a> <a href=/tags/ecs>ecs</a> <a href=/tags/ssl>ssl</a> <a href=/tags/bash>bash</a> <a href=/tags/dns>dns</a></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#wordpress aria-label=WordPress>WordPress</a></li><li><a href=#adopting-modern-development-practices aria-label="Adopting Modern Development Practices">Adopting Modern Development Practices</a></li><li><a href=#key-components-of-our-setup aria-label="Key Components of Our Setup">Key Components of Our Setup</a></li><li><a href=#permissions-requirements aria-label="Permissions Requirements">Permissions Requirements</a></li><li><a href=#terraform-registry-modules aria-label="Terraform Registry Modules">Terraform Registry Modules</a></li><li><a href=#vpc aria-label=VPC>VPC</a></li><li><a href=#ecs-cluster aria-label="ECS Cluster">ECS Cluster</a></li><li><a href=#ecs-service aria-label="ECS Service">ECS Service</a><ul><li><a href=#container-definitions aria-label="Container Definitions">Container Definitions</a></li></ul></li><li><a href=#alb aria-label=ALB>ALB</a></li><li><a href=#autoscaling aria-label=Autoscaling>Autoscaling</a><ul><li><a href=#bash-script aria-label="Bash Script">Bash Script</a></li><li><a href=#security-groups aria-label="Security Groups">Security Groups</a></li></ul></li><li><a href=#rds aria-label=RDS>RDS</a></li><li><a href=#efs aria-label=EFS>EFS</a></li><li><a href=#acm aria-label=ACM>ACM</a></li><li><a href=#dns aria-label=DNS>DNS</a></li><li><a href=#secrets-manager aria-label="Secrets Manager">Secrets Manager</a></li><li><a href=#conclusions aria-label=Conclusions>Conclusions</a><ul><li><a href=#areas-for-improvement aria-label="Areas for Improvement">Areas for Improvement</a></li><li><a href=#looking-ahead aria-label="Looking Ahead">Looking Ahead</a></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"),document.querySelectorAll(".inner ul li a").forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();const t=this.getAttribute("href").slice(1),n=document.getElementById(t);window.scrollTo({top:getOffsetTop(n)-75,behavior:"smooth"})})})},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset-60>0&&getOffsetTop(e)-window.pageYOffset-60<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.scrollY}</script><div class=post-content><p>This guide outlines the steps to launch a highly available WordPress application, structured as a four-tier architecture, using ECS for container orchestration.</p><p>Our final infrastructure will look like this,</p><p><img loading=lazy src=/posts/docker_wordpress/docker-wordpress-drawio.png alt=architecture></p><p>Find the complete setup on instructions in the <a href=https://github.com/tbalza/terraform-docker-wordpress>GitHub repository</a>.</p><h3 id=wordpress>WordPress<a hidden class=anchor aria-hidden=true href=#wordpress>#</a></h3><p>WordPress is a widely used CMS powering a significant portion of the internet&rsquo;s websites.</p><blockquote><p>WordPress rose to popularity quickly because of its up-to-date development framework, extensive feature set, flexibility, rapid and multilingual publishing ability, multi-author support, and thriving community. Thousands of free and commercial themes and plugins are available to extend and personalize WordPress for just about every situation. (From <a href=https://bitnami.com/stack/wordpress>bitnami.com</a>)</p></blockquote><p>Traditionally, WordPress operates as a monolithic application. However, by leveraging Docker, AWS RDS, and EFS, we can transform it into a stateless architecture. This decouples the computing layer from the rest of the infrastructure, enhancing flexibility. Specifically, it allows us to run multiple servers behind load balancers, thereby achieving high availability.</p><p>In this setup, Docker containers play a crucial role by encapsulating the WordPress application, making it portable and consistent across different computing environments. This ties into the broader architectural tiers by ensuring the application layer is both scalable and resilient.</p><p>Furthermore, the separation of storage (via EFS) and database services (using RDS) enables more robust and isolated backups, as well as seamless rolling updates. This approach ensures that ongoing user sessions remain unaffected, eliminating downtime during updates.</p><h3 id=adopting-modern-development-practices>Adopting Modern Development Practices<a hidden class=anchor aria-hidden=true href=#adopting-modern-development-practices>#</a></h3><p>In our projects, we prioritize technologies that embrace modern development methodologies, including Continuous Integration/Continuous Deployment (CI/CD) and Infrastructure as Code (IaC). We advocate for the following practices:</p><ul><li>Automated deployment and provisioning of all infrastructure components.</li><li>Seamless rolling updates for services, ensuring zero downtime.</li><li>Version-controlled infrastructure changes, treat your infrastructure setup as you would with application code.</li><li>Unified codebase catering to multiple environments like development and production.</li><li>Comprehensive monitoring capabilities for crucial components and resources, utilizing metrics for performance insights.</li></ul><p><strong>Automation Focus</strong></p><p>This guide primarily covers automation techniques for deployments, project structuring, while deferring in-depth development principles to another discussion.</p><p>Please note, while AWS resources may lead to costs, our Terraform-guided process simplifies the removal of all resources with the terraform destroy command to prevent unnecessary expenses.</p><p><strong>Container Orchestration with ECS on EC2</strong></p><p>ECS on EC2 provides a versatile environment for running Docker containerized services, supporting applications of any scale or type. Our setup involves managing EC2 instances, ensuring service internet accessibility and high availability by deploying across multiple Availability Zones with dynamic scaling through an Autoscaling Policy.</p><p><strong>ECS EC2 versus Fargate</strong></p><p>While Fargate offers a serverless alternative, eliminating infrastructure management, it may lead to higher costs with extensive memory usage. ECS on EC2, conversely, grants more flexibility in instance types and running specific tasks like daemon agents. The choice between ECS on EC2 and Fargate hinges on your team&rsquo;s expertise, infrastructure management capabilities, and specific needs such as running specialized software.</p><h3 id=key-components-of-our-setup>Key Components of Our Setup<a hidden class=anchor aria-hidden=true href=#key-components-of-our-setup>#</a></h3><ul><li><strong>WordPress:</strong> This is the CMS platform we&rsquo;ll be deploying in our environment.</li><li><strong>Elastic Container Service (ECS):</strong> Utilizes clusters, services, and tasks for service operation.</li><li><strong>Elastic File System (EFS):</strong> Ensures persistent application data.</li><li><strong>Relational Database Service (RDS):</strong> Manages database operations.</li><li><strong>Secrets Manager:</strong> Secures sensitive information like passwords.</li><li><strong>Certificate Manager:</strong> Manages SSL certificates, with domain DNS handled externally by CloudFlare.</li><li><strong>Application Load Balancer (ALB):</strong> Directs requests to various container instances.</li><li><strong>Autoscaling Group (ASG):</strong> Provides EC2 instance scaling and high availability.</li><li><strong>Security Groups:</strong> Implements firewall rules for EC2 instances and ALBs.</li><li><strong>Virtual Private Cloud (VPC):</strong> Encapsulates subnets and internet gateways, distinguishing between public subnets for the ALB and private subnets for ECS services.</li></ul><h3 id=permissions-requirements>Permissions Requirements<a hidden class=anchor aria-hidden=true href=#permissions-requirements>#</a></h3><p>In cloud environments like AWS, permissions and roles serve as foundational elements in securing and defining what resources and actions various entities (like services, users, or applications) are allowed or denied. Here&rsquo;s a high-level explanation in relation to the setup:</p><ul><li><em><strong>Security Groups:</strong></em> Act as virtual firewalls that control the traffic allowed to and from ECS containers, ensuring only authorized network requests (like those from an ALB) are permitted.</li><li><em><strong>ECS Task Role:</strong></em> Assigns specific permissions to ECS tasks, enabling them to interact with other AWS services like S3 for storage, CloudWatch for logging, or EFS for file systems without embedding sensitive credentials within the containers.</li><li><em><strong>Trust Relationship Policy:</strong></em> Establishes a trust where ECS tasks are permitted to assume a role, enabling actions like pulling images or managing resources based on the defined permissions (like AmazonECSTaskExecutionRolePolicy).</li><li><em><strong>EC2 Role:</strong></em> Similar to the ECS Task Role, it assigns permissions to the EC2 instances within the cluster to interact with AWS services necessary for their operation, like EFS or the EC2 Container Service itself.</li><li><em><strong>Listeners and Target Group:</strong></em> Direct traffic from the ALB to the appropriate backend services based on the request, enabling secure and efficient traffic management.</li></ul><p>A heads-up: Grasping the following details requires a thorough understanding of each AWS service and the complex ways in which different permission levels interweave. Below is a service-by-service breakdown, detailing the necessary configurations to facilitate communication between individual services.</p><p><strong>1. Amazon Elastic Container Service (ECS):</strong></p><ul><li><em>ECS Security Group (Inbound)</em>: Allow traffic from the Application Load Balancer (ALB).</li><li><em>ECS Security Group (Outbound)</em>: Allow traffic to Amazon RDS, ECS, and the internet.</li><li><em>ECS Task Role</em>: Allows ECS tasks to interact with specific AWS services.</li><li><code>AmazonECSTaskExecutionRolePolicy</code>: Allows ECS tasks to make API requests to ECS.</li><li><code>AmazonS3FullAccess</code>: Required if the setup needs S3 access for backups or media storage.</li><li><code>CloudWatchLogsFullAccess</code>: Allows tasks to send logs to Amazon CloudWatch.</li><li><code>AmazonElasticFileSystemClientFullAccess</code>: Grants access to EFS.</li><li><em>Trust Relationship Policy</em>: Principal: <code>ecs-tasks.amazonaws.com</code> Action: <code>sts:AssumeRole</code></li><li><em>ECS Task Execution Role</em>: Used by: ECS agent and Docker daemon to pull images and manage resources.</li><li><code>AmazonECSTaskExecutionRolePolicy</code></li><li><em>Trust Relationship Policy</em>: Principal: <code>ecs-tasks.amazonaws.com</code> Action: <code>sts:AssumeRole</code></li></ul><p><strong>2. Amazon EC2 Instance (from EC2 cluster):</strong></p><ul><li><em>EC2 Role (defined in ASG module)</em>:</li><li><code>AmazonEC2ContainerServiceforEC2Role</code></li><li><code>AmazonSSMManagedInstanceCore</code></li><li><code>AmazonElasticFileSystemClientFullAccess</code></li><li><em>EC2 Security Group (defined in ASG module)</em>: Inbound: Allow traffic on ports <code>80</code>, <code>3306</code>, and <code>2049</code> from VPC private subnets.</li></ul><p><strong>3. Amazon RDS:</strong></p><ul><li><em>Security Group</em>: Inbound: Allow traffic from the ECS Security Group on MySQL port <code>3306</code>.</li></ul><p><strong>4. Application Load Balancer (ALB):</strong></p><ul><li><em>Security Group</em>: Inbound: Allow traffic on ports <code>80</code> (HTTP) and <code>443</code> (HTTPS). Outbound: Allow rules to communicate with VPC CIDR block.</li><li><em>Listeners</em>: HTTP <code>80</code>: Redirect to HTTPS <code>443</code>. HTTPS <code>443</code>: Forward to the ECS target group.</li><li><em>Target Group</em>: Backend protocol: HTTP. Backend port: <code>8080</code></li></ul><p><strong>5. Auto Scaling Group (ASG):</strong></p><ul><li><em>Security Group</em>: Use the EC2 security group.</li><li><em>Policies Required for Associated Roles</em>: <code>AmazonEC2AutoScalingFullAccess</code></li></ul><p><strong>6. Amazon Elastic File System (EFS):</strong></p><ul><li><em>Security Groups</em>: Inbound: Allow traffic on port <code>2049</code> from VPC private subnets.</li><li><em>Mount Targets</em>: Create in each Availability Zone used by ECS instances or tasks.</li></ul><p>Overall, permissions and roles are essential in this setup for ensuring that each component operates securely, interacts properly with other services, and has access to only the resources necessary for its function, following the principle of least privilege.</p><h3 id=terraform-registry-modules>Terraform Registry Modules<a hidden class=anchor aria-hidden=true href=#terraform-registry-modules>#</a></h3><p>This configuration utilizes modules to enhance the efficiency and organization of infrastructure provisioning.</p><p>A module, a superior construct within Terraform, consolidates multiple resources into a single, reusable package. Available from sources such as the <a href=https://github.com/terraform-aws-modules/>Terraform Registry</a>, these modules embody best practices and facilitate consistent application across various projects. They are crafted from resources—the elemental components of Terraform like compute instances or databases—which are the foundational elements for sculpting the anticipated state of infrastructure.</p><p>Advantages of Utilizing Modules:</p><ul><li><strong>Simplification:</strong> Consolidates various resources and methodologies into a unified entity.</li><li><strong>Standardization:</strong> Ensures uniform creation of resources.</li><li><strong>Versioning:</strong> Facilitates seamless updates and straightforward rollbacks.</li><li><strong>Community-Tested:</strong> Guarantees dependability through extensive community review.</li><li><strong>Maintenance:</strong> Streamlines the update and maintenance processes.</li><li><strong>Documentation:</strong> Offers comprehensive instructions and examples.</li></ul><p>While modules cater to a broad range of needs, direct use of provider resources is warranted for highly customized scenarios or specific requirements not addressed by existing modules. Nonetheless, a hybrid approach, combining modules with direct resource utilization, can often provide the most comprehensive solution, filling in any gaps to achieve the desired infrastructure configuration.</p><p>In essence, modules render Terraform configurations more streamlined and standardized, striking an optimal balance between ease of use and the ability to tailor to specific needs.</p><h3 id=vpc>VPC<a hidden class=anchor aria-hidden=true href=#vpc>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>module</span> <span class=s2>&#34;vpc&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  source</span>  <span class=o>=</span> <span class=s2>&#34;terraform-aws-modules/vpc/aws&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  version</span> <span class=o>=</span> <span class=s2>&#34;~&gt; 5.0&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  name</span> <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>name</span>
</span></span><span class=line><span class=cl><span class=n>  cidr</span> <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>vpc_cidr</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  azs</span>              <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>azs</span>
</span></span><span class=line><span class=cl><span class=n>  public_subnets</span>   <span class=o>=</span> <span class=p>[</span><span class=k>for</span> <span class=k>k</span><span class=p>,</span> <span class=k>v</span> <span class=k>in</span> <span class=k>local</span><span class=p>.</span><span class=k>azs</span> <span class=err>:</span> <span class=k>cidrsubnet</span><span class=p>(</span><span class=k>local</span><span class=p>.</span><span class=k>vpc_cidr</span><span class=p>,</span> <span class=m>8</span><span class=p>,</span> <span class=k>k</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=n>  private_subnets</span>  <span class=o>=</span> <span class=p>[</span><span class=k>for</span> <span class=k>k</span><span class=p>,</span> <span class=k>v</span> <span class=k>in</span> <span class=k>local</span><span class=p>.</span><span class=k>azs</span> <span class=err>:</span> <span class=k>cidrsubnet</span><span class=p>(</span><span class=k>local</span><span class=p>.</span><span class=k>vpc_cidr</span><span class=p>,</span> <span class=m>8</span><span class=p>,</span> <span class=k>k</span> <span class=err>+</span> <span class=m>3</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=n>  database_subnets</span> <span class=o>=</span> <span class=p>[</span><span class=k>for</span> <span class=k>k</span><span class=p>,</span> <span class=k>v</span> <span class=k>in</span> <span class=k>local</span><span class=p>.</span><span class=k>azs</span> <span class=err>:</span> <span class=k>cidrsubnet</span><span class=p>(</span><span class=k>local</span><span class=p>.</span><span class=k>vpc_cidr</span><span class=p>,</span> <span class=m>8</span><span class=p>,</span> <span class=k>k</span> <span class=err>+</span> <span class=m>6</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  create_database_subnet_group</span> <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  enable_nat_gateway</span> <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl><span class=n>  single_nat_gateway</span> <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>output</span> <span class=s2>&#34;alb&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  value</span> <span class=o>=</span> <span class=k>module</span><span class=p>.</span><span class=k>alb</span><span class=p>.</span><span class=k>dns_name</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>This module efficiently establishes a secure, highly available AWS VPC with structured network segmentation (public, private, database subnets) enhancing resilience across multiple zones. Public subnets connect directly to the internet via an Internet Gateway. Private and database subnets, routed for internal traffic, use a NAT Gateway, enabling internet access without external exposure.</p><p><img loading=lazy src=/posts/docker_wordpress/vpn.png alt=vpn></p><h3 id=ecs-cluster>ECS Cluster<a hidden class=anchor aria-hidden=true href=#ecs-cluster>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>module</span> <span class=s2>&#34;ecs_cluster&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  source</span>  <span class=o>=</span> <span class=s2>&#34;terraform-aws-modules/ecs/aws//modules/cluster&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  version</span> <span class=o>=</span> <span class=s2>&#34;~&gt; 5.10&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  cluster_name</span> <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>name</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  cloudwatch_log_group_retention_in_days</span> <span class=o>=</span> <span class=m>1</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>  # Capacity provider - autoscaling groups
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  default_capacity_provider_use_fargate</span> <span class=o>=</span> <span class=kt>false</span>
</span></span><span class=line><span class=cl><span class=n>  autoscaling_capacity_providers</span> <span class=o>=</span> {<span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>    # On-demand instances
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>    ex_1</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>      auto_scaling_group_arn</span>         <span class=o>=</span> <span class=k>module</span><span class=p>.</span><span class=k>autoscaling</span><span class=p>[</span><span class=s2>&#34;ex_1&#34;</span><span class=p>].</span><span class=k>autoscaling_group_arn</span>
</span></span><span class=line><span class=cl><span class=n>      managed_termination_protection</span> <span class=o>=</span> <span class=s2>&#34;DISABLED&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>      managed_scaling</span> <span class=o>=</span> {<span class=c1> # Enabling would allow for autoscaling instances
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>        maximum_scaling_step_size</span> <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=n>        minimum_scaling_step_size</span> <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=n>        status</span>                    <span class=o>=</span> <span class=s2>&#34;DISABLED&#34;</span>
</span></span><span class=line><span class=cl><span class=n>        target_capacity</span>           <span class=o>=</span> <span class=m>100</span>
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>      default_capacity_provider_strategy</span> <span class=o>=</span> {<span class=c1> # This would be edited for multiple capacity providers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>        weight</span> <span class=o>=</span> <span class=m>60</span>
</span></span><span class=line><span class=cl><span class=n>        base</span>   <span class=o>=</span> <span class=m>20</span>
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>Since we are not yet using auto-scaling, this module only defines the cluster name and the capacity provider, that will be used later on by the service. (The provider strategy is a placeholder for later implementation)</p><h3 id=ecs-service>ECS Service<a hidden class=anchor aria-hidden=true href=#ecs-service>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>module</span> <span class=s2>&#34;ecs_service&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  source</span>  <span class=o>=</span> <span class=s2>&#34;terraform-aws-modules/ecs/aws//modules/service&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  version</span> <span class=o>=</span> <span class=s2>&#34;~&gt; 5.10&#34;</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>  # Service
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  name</span>        <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>name</span>
</span></span><span class=line><span class=cl><span class=n>  cluster_arn</span> <span class=o>=</span> <span class=k>module</span><span class=p>.</span><span class=k>ecs_cluster</span><span class=p>.</span><span class=k>arn</span>
</span></span><span class=line><span class=cl><span class=n>  cpu</span>         <span class=o>=</span> <span class=m>1843</span><span class=c1> # CPU units for the task, reserving some for system overhead (t3.micro)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  memory</span>      <span class=o>=</span> <span class=m>724</span><span class=c1>  # Memory for the task, reserving system overhead (t3.micro)
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>  # Task Definition (The Task IAM role is defined in the Autoscaling module)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  requires_compatibilities</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;EC2&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>  capacity_provider_strategy</span> <span class=o>=</span> {<span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>    # On-demand instances
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>    ex_1</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>      capacity_provider</span> <span class=o>=</span> <span class=k>module</span><span class=p>.</span><span class=k>ecs_cluster</span><span class=p>.</span><span class=k>autoscaling_capacity_providers</span><span class=p>[</span><span class=s2>&#34;ex_1&#34;</span><span class=p>].</span><span class=k>name</span>
</span></span><span class=line><span class=cl><span class=n>      weight</span>            <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=n>      base</span>              <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>  }<span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>  # EFS volume
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  volume</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>    wordpress_data</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>      efs_volume_configuration</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>        file_system_id</span>     <span class=o>=</span> <span class=k>module</span><span class=p>.</span><span class=k>efs</span><span class=p>.</span><span class=k>id</span>
</span></span><span class=line><span class=cl><span class=n>        transit_encryption</span> <span class=o>=</span> <span class=s2>&#34;ENABLED&#34;</span>
</span></span><span class=line><span class=cl><span class=n>        authorization_config</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>          access_point_id</span> <span class=o>=</span> <span class=k>module</span><span class=p>.</span><span class=k>efs</span><span class=p>.</span><span class=k>access_points</span><span class=p>[</span><span class=s2>&#34;root&#34;][&#34;id&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>          iam</span>             <span class=o>=</span> <span class=s2>&#34;ENABLED&#34;</span>
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  load_balancer</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>    service</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>      target_group_arn</span> <span class=o>=</span> <span class=k>module</span><span class=p>.</span><span class=k>alb</span><span class=p>.</span><span class=k>target_groups</span><span class=p>[</span><span class=s2>&#34;ex_ecs&#34;</span><span class=p>].</span><span class=k>arn</span>
</span></span><span class=line><span class=cl><span class=n>      container_name</span>   <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>container_name</span>
</span></span><span class=line><span class=cl><span class=n>      container_port</span>   <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>container_port</span>
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  subnet_ids</span> <span class=o>=</span> <span class=k>module</span><span class=p>.</span><span class=k>vpc</span><span class=p>.</span><span class=k>private_subnets</span>
</span></span><span class=line><span class=cl><span class=n>  security_group_rules</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>    alb_http_ingress</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>      type</span>                     <span class=o>=</span> <span class=s2>&#34;ingress&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      from_port</span>                <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>container_port</span>
</span></span><span class=line><span class=cl><span class=n>      to_port</span>                  <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>container_port</span>
</span></span><span class=line><span class=cl><span class=n>      protocol</span>                 <span class=o>=</span> <span class=s2>&#34;tcp&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      description</span>              <span class=o>=</span> <span class=s2>&#34;Service port&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      source_security_group_id</span> <span class=o>=</span> <span class=k>module</span><span class=p>.</span><span class=k>alb</span><span class=p>.</span><span class=k>security_group_id</span>
</span></span><span class=line><span class=cl>    }<span class=p>,</span>
</span></span><span class=line><span class=cl><span class=n>    &#34;allow-internet&#34;</span> <span class=o>=</span> {<span class=c1> # to fetch docker image outside AWS (not in ECR)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>      type</span>        <span class=o>=</span> <span class=s2>&#34;egress&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      protocol</span>    <span class=o>=</span> <span class=s2>&#34;all&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      cidr_blocks</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;0.0.0.0/0&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>      from_port</span>   <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=n>      to_port</span>     <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>Using a t3.micro instance for testing purposes, here we&rsquo;re maxing out a single task (minus the aws agent overhead) to occupy the total available computing resources (CPU and memory). Additionally, we define a snippet of the container definition, where we configure the first stage for using an EFS volume for data storage. Furthermore, we connect the ecs task to the load balancer telling it will receive traffic on port 8080.</p><p>The volume definition allows the docker container to have WordPress data persistence outside the container itself.</p><p><img loading=lazy src=/posts/docker_wordpress/volume.png alt=volume></p><p>If we were using a docker-compose.yml file this chunk,</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=n> volume</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>    wordpress_data</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>      efs_volume_configuration</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>        file_system_id</span>     <span class=o>=</span> <span class=k>module</span><span class=p>.</span><span class=k>efs</span><span class=p>.</span><span class=k>id</span>
</span></span><span class=line><span class=cl><span class=n>        transit_encryption</span> <span class=o>=</span> <span class=s2>&#34;ENABLED&#34;</span>
</span></span><span class=line><span class=cl><span class=n>        authorization_config</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>          access_point_id</span> <span class=o>=</span> <span class=k>module</span><span class=p>.</span><span class=k>efs</span><span class=p>.</span><span class=k>access_points</span><span class=p>[</span><span class=s2>&#34;root&#34;][&#34;id&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>          iam</span>             <span class=o>=</span> <span class=s2>&#34;ENABLED&#34;</span>
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>  }
</span></span></code></pre></div><p>Would be the ECS equivalent of this,</p><p><img loading=lazy src=/posts/docker_wordpress/persistence.png alt=persistence></p><h4 id=container-definitions>Container Definitions<a hidden class=anchor aria-hidden=true href=#container-definitions>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=c1>  # Container definition(s)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  container_definitions</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>    (local.container_name)</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>      image</span>     <span class=o>=</span> <span class=s2>&#34;docker.io/bitnami/wordpress:6&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      user</span>      <span class=o>=</span> <span class=s2>&#34;root&#34;</span><span class=c1> # Ideally run docker container as non-root user
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>      essential</span> <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl><span class=n>      port_mappings</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        {
</span></span><span class=line><span class=cl><span class=n>          name</span>          <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>container_name</span>
</span></span><span class=line><span class=cl><span class=n>          containerPort</span> <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>container_port</span><span class=c1> # Port 8080 is bitnami container default
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>          hostPort</span>      <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>container_port</span><span class=c1> # ALB listens on port 80, forwards to target group on port 8080
</span></span></span><span class=line><span class=cl><span class=c1></span>        }
</span></span><span class=line><span class=cl>      <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>      cpu</span>    <span class=o>=</span> <span class=m>1843</span><span class=c1> # Allocate nearly all CPU units to this container
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>      memory</span> <span class=o>=</span> <span class=m>724</span><span class=c1>  # Allocate majority of memory to this container
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=n>      environment</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        {
</span></span><span class=line><span class=cl><span class=n>          name</span>  <span class=o>=</span> <span class=s2>&#34;WORDPRESS_DATABASE_HOST&#34;</span>
</span></span><span class=line><span class=cl><span class=n>          value</span> <span class=o>=</span> <span class=k>module</span><span class=p>.</span><span class=k>rds</span><span class=p>.</span><span class=k>db_instance_address</span>
</span></span><span class=line><span class=cl>        }<span class=p>,</span>
</span></span><span class=line><span class=cl>        {
</span></span><span class=line><span class=cl><span class=n>          name</span>  <span class=o>=</span> <span class=s2>&#34;WORDPRESS_DATABASE_PORT_NUMBER&#34;</span>
</span></span><span class=line><span class=cl><span class=n>          value</span> <span class=o>=</span> <span class=m>3306</span>
</span></span><span class=line><span class=cl>        }<span class=p>,</span>
</span></span><span class=line><span class=cl>        {
</span></span><span class=line><span class=cl><span class=n>          name</span>  <span class=o>=</span> <span class=s2>&#34;WORDPRESS_DATABASE_USER&#34;</span>
</span></span><span class=line><span class=cl><span class=n>          value</span> <span class=o>=</span> <span class=s2>&#34;wordpress&#34;</span>
</span></span><span class=line><span class=cl>        }<span class=p>,</span>
</span></span><span class=line><span class=cl>        {
</span></span><span class=line><span class=cl><span class=n>          name</span>  <span class=o>=</span> <span class=s2>&#34;WORDPRESS_DATABASE_NAME&#34;</span>
</span></span><span class=line><span class=cl><span class=n>          value</span> <span class=o>=</span> <span class=s2>&#34;wordpressdb&#34;</span>
</span></span><span class=line><span class=cl>        }<span class=p>,</span>
</span></span><span class=line><span class=cl>        {
</span></span><span class=line><span class=cl><span class=n>          name</span>  <span class=o>=</span> <span class=s2>&#34;WORDPRESS_USERNAME&#34;</span>
</span></span><span class=line><span class=cl><span class=n>          value</span> <span class=o>=</span> <span class=s2>&#34;wordpress&#34;</span>
</span></span><span class=line><span class=cl>        }<span class=p>,</span>
</span></span><span class=line><span class=cl>        {
</span></span><span class=line><span class=cl><span class=n>          name</span>  <span class=o>=</span> <span class=s2>&#34;WORDPRESS_ENABLE_HTTPS&#34;</span>
</span></span><span class=line><span class=cl><span class=n>          value</span> <span class=o>=</span> <span class=s2>&#34;yes&#34;</span>
</span></span><span class=line><span class=cl>        }<span class=p>,</span>
</span></span><span class=line><span class=cl>        {
</span></span><span class=line><span class=cl><span class=n>          name</span>  <span class=o>=</span> <span class=s2>&#34;WORDPRESS_VOLUME_DIR&#34;</span>
</span></span><span class=line><span class=cl><span class=n>          value</span> <span class=o>=</span> <span class=s2>&#34;/mnt/efs/&#34;</span>
</span></span><span class=line><span class=cl>        }<span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>      secrets</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        {
</span></span><span class=line><span class=cl><span class=n>          name</span>      <span class=o>=</span> <span class=s2>&#34;WORDPRESS_DATABASE_PASSWORD&#34;</span>
</span></span><span class=line><span class=cl><span class=n>          valueFrom</span> <span class=o>=</span> <span class=k>module</span><span class=p>.</span><span class=k>secret_db_password</span><span class=p>.</span><span class=k>secret_arn</span>
</span></span><span class=line><span class=cl>        }<span class=p>,</span>
</span></span><span class=line><span class=cl>        {
</span></span><span class=line><span class=cl><span class=n>          name</span>      <span class=o>=</span> <span class=s2>&#34;WORDPRESS_PASSWORD&#34;</span>
</span></span><span class=line><span class=cl><span class=n>          valueFrom</span> <span class=o>=</span> <span class=k>module</span><span class=p>.</span><span class=k>secret_user_password</span><span class=p>.</span><span class=k>secret_arn</span>
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>      <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>      mount_points</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        {
</span></span><span class=line><span class=cl><span class=n>          sourceVolume</span>  <span class=o>=</span> <span class=s2>&#34;wordpress_data&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=n>          containerPath</span> <span class=o>=</span> <span class=s2>&#34;/bitnami/wordpress&#34;</span><span class=c1> # by default wp-config.php wp-content are persisted, env WORDPRESS_DATA_TO_PERSIST
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>          readOnly</span>      <span class=o>=</span> <span class=kt>false</span>
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>      <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>      readonly_root_filesystem</span> <span class=o>=</span> <span class=kt>false</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>      enable_cloudwatch_logging</span>              <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl><span class=n>      create_cloudwatch_log_group</span>            <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl><span class=n>      cloudwatch_log_group_name</span>              <span class=o>=</span> <span class=s2>&#34;/aws/ecs/${local.name}/${local.container_name}&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      cloudwatch_log_group_retention_in_days</span> <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>      log_configuration</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>        logDriver</span> <span class=o>=</span> <span class=s2>&#34;awslogs&#34;</span>
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>  }
</span></span></code></pre></div><p>The current <a href=https://github.com/bitnami/containers/tree/main/bitnami/wordpress>Bitnami image</a> used for deploying an ECS EC2 application offers a ready-to-use, standardized solution that reduces setup time and maintains consistency across different settings.</p><p>Conversely, an extensive CI/CD pipeline using Docker provides significantly more customization and control. In this framework, developers can tailor Docker images to specific requirements, update and manage versions through a Version Control System (VCS), and monitor modifications over time.</p><p>For our purposes, this image supports customization through environment variables specified in the container definitions.</p><p>Additionally, we set the parameters for cloudwatch to log the events related to our task.</p><h3 id=alb>ALB<a hidden class=anchor aria-hidden=true href=#alb>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=c1># Extract the last version of AWS Optimized AMI for ECS
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>data</span> <span class=s2>&#34;aws_ssm_parameter&#34; &#34;ecs_optimized_ami&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  name</span> <span class=o>=</span> <span class=s2>&#34;/aws/service/ecs/optimized-ami/amazon-linux-2/recommended&#34;</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>module</span> <span class=s2>&#34;alb&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  source</span>  <span class=o>=</span> <span class=s2>&#34;terraform-aws-modules/alb/aws&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  version</span> <span class=o>=</span> <span class=s2>&#34;~&gt; 9.0&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  name</span> <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>name</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  load_balancer_type</span> <span class=o>=</span> <span class=s2>&#34;application&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  vpc_id</span>  <span class=o>=</span> <span class=k>module</span><span class=p>.</span><span class=k>vpc</span><span class=p>.</span><span class=k>vpc_id</span>
</span></span><span class=line><span class=cl><span class=n>  subnets</span> <span class=o>=</span> <span class=k>module</span><span class=p>.</span><span class=k>vpc</span><span class=p>.</span><span class=k>public_subnets</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>  # For example only
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  enable_deletion_protection</span> <span class=o>=</span> <span class=kt>false</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>  # Security Group
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  security_group_ingress_rules</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>    all_http</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>      from_port</span>   <span class=o>=</span> <span class=m>80</span>
</span></span><span class=line><span class=cl><span class=n>      to_port</span>     <span class=o>=</span> <span class=m>80</span>
</span></span><span class=line><span class=cl><span class=n>      ip_protocol</span> <span class=o>=</span> <span class=s2>&#34;tcp&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      description</span> <span class=o>=</span> <span class=s2>&#34;HTTP web traffic&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      cidr_ipv4</span>   <span class=o>=</span> <span class=s2>&#34;0.0.0.0/0&#34;</span>
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl><span class=n>    all_https</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>      from_port</span>   <span class=o>=</span> <span class=m>443</span>
</span></span><span class=line><span class=cl><span class=n>      to_port</span>     <span class=o>=</span> <span class=m>443</span>
</span></span><span class=line><span class=cl><span class=n>      ip_protocol</span> <span class=o>=</span> <span class=s2>&#34;tcp&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      description</span> <span class=o>=</span> <span class=s2>&#34;HTTPS web traffic&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      cidr_ipv4</span>   <span class=o>=</span> <span class=s2>&#34;0.0.0.0/0&#34;</span>
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl><span class=n>  security_group_egress_rules</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>    all</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>      ip_protocol</span> <span class=o>=</span> <span class=s2>&#34;-1&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      cidr_ipv4</span>   <span class=o>=</span> <span class=k>module</span><span class=p>.</span><span class=k>vpc</span><span class=p>.</span><span class=k>vpc_cidr_block</span>
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  listeners</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>    ex-http-https-redirect</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>      port</span>     <span class=o>=</span> <span class=m>80</span>
</span></span><span class=line><span class=cl><span class=n>      protocol</span> <span class=o>=</span> <span class=s2>&#34;HTTP&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      redirect</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>        port</span>        <span class=o>=</span> <span class=s2>&#34;443&#34;</span>
</span></span><span class=line><span class=cl><span class=n>        protocol</span>    <span class=o>=</span> <span class=s2>&#34;HTTPS&#34;</span>
</span></span><span class=line><span class=cl><span class=n>        status_code</span> <span class=o>=</span> <span class=s2>&#34;HTTP_301&#34;</span>
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl><span class=n>    ex-https</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>      port</span>            <span class=o>=</span> <span class=m>443</span>
</span></span><span class=line><span class=cl><span class=n>      protocol</span>        <span class=o>=</span> <span class=s2>&#34;HTTPS&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      ssl_policy</span>      <span class=o>=</span> <span class=s2>&#34;ELBSecurityPolicy-TLS13-1-2-Res-2021-06&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      certificate_arn</span> <span class=o>=</span> <span class=k>module</span><span class=p>.</span><span class=k>acm</span><span class=p>.</span><span class=k>acm_certificate_arn</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>      forward</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>        target_group_key</span> <span class=o>=</span> <span class=s2>&#34;ex_ecs&#34;</span>
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  target_groups</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>    ex_ecs</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>      backend_protocol</span>                  <span class=o>=</span> <span class=s2>&#34;HTTP&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      backend_port</span>                      <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>container_port</span>
</span></span><span class=line><span class=cl><span class=n>      target_type</span>                       <span class=o>=</span> <span class=s2>&#34;ip&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      deregistration_delay</span>              <span class=o>=</span> <span class=m>5</span>
</span></span><span class=line><span class=cl><span class=n>      load_balancing_cross_zone_enabled</span> <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>      health_check</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>        enabled</span>             <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl><span class=n>        healthy_threshold</span>   <span class=o>=</span> <span class=m>5</span>
</span></span><span class=line><span class=cl><span class=n>        interval</span>            <span class=o>=</span> <span class=m>30</span>
</span></span><span class=line><span class=cl><span class=n>        matcher</span>             <span class=o>=</span> <span class=s2>&#34;200&#34;</span>
</span></span><span class=line><span class=cl><span class=n>        path</span>                <span class=o>=</span> <span class=s2>&#34;/&#34;</span>
</span></span><span class=line><span class=cl><span class=n>        port</span>                <span class=o>=</span> <span class=s2>&#34;traffic-port&#34;</span>
</span></span><span class=line><span class=cl><span class=n>        protocol</span>            <span class=o>=</span> <span class=s2>&#34;HTTP&#34;</span>
</span></span><span class=line><span class=cl><span class=n>        timeout</span>             <span class=o>=</span> <span class=m>5</span>
</span></span><span class=line><span class=cl><span class=n>        unhealthy_threshold</span> <span class=o>=</span> <span class=m>2</span>
</span></span><span class=line><span class=cl>      }<span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>      # Theres nothing to attach here in this definition. Instead,
</span></span></span><span class=line><span class=cl><span class=c1>      # ECS will attach the IPs of the tasks to this target group
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>      create_attachment</span> <span class=o>=</span> <span class=kt>false</span>
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  tags</span> <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>tags</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>This block sets up an AWS Application Load Balancer (ALB) redirecting all HTTP traffic to HTTPS, and then all that TLS traffic to our target group that listens on 8080 (forward to ex_ecs). It also sets up health monitoring.</p><p><img loading=lazy src=/posts/docker_wordpress/listener.png alt=listner></p><h3 id=autoscaling>Autoscaling<a hidden class=anchor aria-hidden=true href=#autoscaling>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>module</span> <span class=s2>&#34;autoscaling&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  source</span>  <span class=o>=</span> <span class=s2>&#34;terraform-aws-modules/autoscaling/aws&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  version</span> <span class=o>=</span> <span class=s2>&#34;~&gt; 6.5&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  for_each</span> <span class=o>=</span> {<span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>    # On-demand instances
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>    ex_1</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>      instance_type</span>              <span class=o>=</span> <span class=s2>&#34;t3.micro&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      use_mixed_instances_policy</span> <span class=o>=</span> <span class=kt>false</span>
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  name</span> <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>name</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  image_id</span>      <span class=o>=</span> <span class=k>jsondecode</span><span class=p>(</span><span class=k>data</span><span class=p>.</span><span class=k>aws_ssm_parameter</span><span class=p>.</span><span class=k>ecs_optimized_ami</span><span class=p>.</span><span class=k>value</span><span class=p>)[</span><span class=s2>&#34;image_id&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>  instance_type</span> <span class=o>=</span> <span class=s2>&#34;t3.micro&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  instance_market_options</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>    market_type</span> <span class=o>=</span> <span class=s2>&#34;spot&#34;</span><span class=c1> # Lower cost for testing purposes
</span></span></span><span class=line><span class=cl><span class=c1></span>  }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  security_groups</span>                 <span class=o>=</span> <span class=p>[</span><span class=k>aws_security_group</span><span class=p>.</span><span class=k>autoscaling_sg</span><span class=p>.</span><span class=k>id</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>  user_data</span>                       <span class=o>=</span> <span class=k>base64encode</span><span class=p>(</span><span class=k>local</span><span class=p>.</span><span class=k>on_demand_user_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>  ignore_desired_capacity_changes</span> <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  create_iam_instance_profile</span> <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl><span class=n>  iam_role_name</span>               <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>name</span>
</span></span><span class=line><span class=cl><span class=n>  iam_role_description</span>        <span class=o>=</span> <span class=s2>&#34;ECS role for ${local.name}&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  iam_role_policies</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>    AmazonEC2ContainerServiceforEC2Role</span> <span class=o>=</span> <span class=s2>&#34;arn:aws:iam::aws:policy/service-role/AmazonEC2ContainerServiceforEC2Role&#34;</span>
</span></span><span class=line><span class=cl><span class=n>    AmazonSSMManagedInstanceCore</span>        <span class=o>=</span> <span class=s2>&#34;arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore&#34;</span>
</span></span><span class=line><span class=cl><span class=n>    EFSFullAccess</span>                       <span class=o>=</span> <span class=k>aws_iam_policy</span><span class=p>.</span><span class=k>efs_full_access</span><span class=p>.</span><span class=k>arn</span>
</span></span><span class=line><span class=cl><span class=n>    RDSFullAccess</span>                       <span class=o>=</span> <span class=k>aws_iam_policy</span><span class=p>.</span><span class=k>rds_full_access</span><span class=p>.</span><span class=k>arn</span>
</span></span><span class=line><span class=cl><span class=n>    ecs-secrets-manager-access</span>          <span class=o>=</span> <span class=k>aws_iam_policy</span><span class=p>.</span><span class=k>secrets_manager_access</span><span class=p>.</span><span class=k>arn</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  vpc_zone_identifier</span> <span class=o>=</span> <span class=k>module</span><span class=p>.</span><span class=k>vpc</span><span class=p>.</span><span class=k>private_subnets</span>
</span></span><span class=line><span class=cl><span class=n>  health_check_type</span>   <span class=o>=</span> <span class=s2>&#34;EC2&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  min_size</span>            <span class=o>=</span> <span class=m>2</span><span class=c1> # Make task Highly Available maintaining 2 ec2 instances across each AZ
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  max_size</span>            <span class=o>=</span> <span class=m>4</span><span class=c1> # Allow for temporary creation of extra instances while reaching desired capacity
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  desired_capacity</span>    <span class=o>=</span> <span class=m>2</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>  # https://github.com/hashicorp/terraform-provider-aws/issues/12582
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  autoscaling_group_tags</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>    AmazonECSManaged</span> <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl>  }<span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>  # Required for  managed_termination_protection = &#34;ENABLED&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  protect_from_scale_in</span> <span class=o>=</span> <span class=kt>false</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>This further links ECS with the load balancer. It defines our Highly Available desired state, where to instances should be always available redundantly in two different AZs.</p><p>It sets the required policies to grant permissions to the EC2 instance itself for accessing the ECS container management, SSM for instance configuration (and console access), EFS for file storage access, RDS for database access, and access to the Secrets Manager.</p><p>Additionally, it defines that a payload should be run on the provisioned ec2 instances before the container service runs.</p><h4 id=bash-script>Bash Script<a hidden class=anchor aria-hidden=true href=#bash-script>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=n>  on_demand_user_data</span> <span class=o>=</span> <span class=err>&lt;&lt;-</span><span class=k>EOT</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>    #!/bin/bash
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=k>yum</span> <span class=k>install</span> <span class=err>-</span><span class=k>y</span> <span class=k>amazon</span><span class=err>-</span><span class=k>efs</span><span class=err>-</span><span class=k>utils</span>
</span></span><span class=line><span class=cl>    <span class=k>mkdir</span> <span class=err>-</span><span class=k>p</span> <span class=err>/</span><span class=k>mnt</span><span class=err>/</span><span class=k>efs</span>
</span></span><span class=line><span class=cl><span class=n>    mount -t efs -o tls,accesspoint</span><span class=o>=</span><span class=si>${</span><span class=err>module</span><span class=p>.</span><span class=err>efs</span><span class=p>.</span><span class=err>access_points</span><span class=p>[</span><span class=s2>&#34;root&#34;][&#34;id&#34;</span><span class=p>]</span><span class=si>}</span> <span class=si>${</span><span class=err>module</span><span class=p>.</span><span class=err>efs</span><span class=p>.</span><span class=err>id</span><span class=si>}</span><span class=err>:/</span> <span class=err>/</span><span class=k>mnt</span><span class=err>/</span><span class=k>efs</span>
</span></span><span class=line><span class=cl><span class=n>    echo &#39;${module.efs.id}:/ /mnt/efs efs tls,accesspoint</span><span class=o>=</span><span class=si>${</span><span class=err>module</span><span class=p>.</span><span class=err>efs</span><span class=p>.</span><span class=err>access_points</span><span class=p>[</span><span class=s2>&#34;root&#34;][&#34;id&#34;</span><span class=p>]</span><span class=si>}</span> <span class=m>0</span> <span class=m>0</span><span class=err>&#39;</span> <span class=err>&gt;&gt;</span> <span class=err>/</span><span class=k>etc</span><span class=err>/</span><span class=k>fstab</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>cat</span> <span class=err>&lt;&lt;&#39;</span><span class=k>EOF</span><span class=err>&#39;</span> <span class=err>&gt;&gt;</span> <span class=err>/</span><span class=k>etc</span><span class=err>/</span><span class=k>ecs</span><span class=err>/</span><span class=k>ecs</span><span class=p>.</span><span class=k>config</span>
</span></span><span class=line><span class=cl><span class=n>    ECS_CLUSTER</span><span class=o>=</span><span class=si>${</span><span class=err>local</span><span class=p>.</span><span class=err>name</span><span class=si>}</span>
</span></span><span class=line><span class=cl><span class=n>    ECS_LOGLEVEL</span><span class=o>=</span><span class=k>debug</span>
</span></span><span class=line><span class=cl><span class=n>    ECS_CONTAINER_INSTANCE_TAGS</span><span class=o>=</span><span class=si>${</span><span class=err>jsonencode</span><span class=p>(</span><span class=err>local</span><span class=p>.</span><span class=err>tags</span><span class=p>)</span><span class=si>}</span>
</span></span><span class=line><span class=cl><span class=n>    ECS_ENABLE_TASK_IAM_ROLE</span><span class=o>=</span><span class=kt>true</span>
</span></span><span class=line><span class=cl>    <span class=k>EOF</span>
</span></span><span class=line><span class=cl>  <span class=k>EOT</span>
</span></span></code></pre></div><p>Since we&rsquo;re not on fargate, our ec2 instance needs to know that it belongs to de cluster we defined earlier.</p><p>It also needs to install the efs-utils agent, and mount it to <code>/mnt/efs</code> before the container runs, so it can successfully mount the persistent volume defined earlier in the container definitions.</p><p>Without this crucial step or instance won&rsquo;t be ready to connect to the container, and the volume will not mount correctly, and instead create internal volumes on the attached SSD very time it&rsquo;s instantiated,</p><p><img loading=lazy src=/posts/docker_wordpress/efs-error.png alt=efs-error></p><h4 id=security-groups>Security Groups<a hidden class=anchor aria-hidden=true href=#security-groups>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=c1># Security Groups for EC2 instances
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>resource</span> <span class=s2>&#34;aws_security_group&#34; &#34;autoscaling_sg&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  name</span>        <span class=o>=</span> <span class=s2>&#34;autoscaling_sg&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  description</span> <span class=o>=</span> <span class=s2>&#34;Autoscaling group security group&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  vpc_id</span>      <span class=o>=</span> <span class=k>module</span><span class=p>.</span><span class=k>vpc</span><span class=p>.</span><span class=k>vpc_id</span>
</span></span><span class=line><span class=cl><span class=n>  tags</span>        <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>tags</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;aws_security_group_rule&#34; &#34;ingress_http_from_alb&#34;</span> {<span class=c1> # HTTP
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  type</span>                     <span class=o>=</span> <span class=s2>&#34;ingress&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  from_port</span>                <span class=o>=</span> <span class=m>80</span>
</span></span><span class=line><span class=cl><span class=n>  to_port</span>                  <span class=o>=</span> <span class=m>80</span>
</span></span><span class=line><span class=cl><span class=n>  protocol</span>                 <span class=o>=</span> <span class=s2>&#34;tcp&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  security_group_id</span>        <span class=o>=</span> <span class=k>aws_security_group</span><span class=p>.</span><span class=k>autoscaling_sg</span><span class=p>.</span><span class=k>id</span>
</span></span><span class=line><span class=cl><span class=n>  source_security_group_id</span> <span class=o>=</span> <span class=k>module</span><span class=p>.</span><span class=k>alb</span><span class=p>.</span><span class=k>security_group_id</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;aws_security_group_rule&#34; &#34;ingress_mysql_from_alb&#34;</span> {<span class=c1> # RDS
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  type</span>                     <span class=o>=</span> <span class=s2>&#34;ingress&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  from_port</span>                <span class=o>=</span> <span class=m>3306</span>
</span></span><span class=line><span class=cl><span class=n>  to_port</span>                  <span class=o>=</span> <span class=m>3306</span>
</span></span><span class=line><span class=cl><span class=n>  protocol</span>                 <span class=o>=</span> <span class=s2>&#34;tcp&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  security_group_id</span>        <span class=o>=</span> <span class=k>aws_security_group</span><span class=p>.</span><span class=k>autoscaling_sg</span><span class=p>.</span><span class=k>id</span>
</span></span><span class=line><span class=cl><span class=n>  source_security_group_id</span> <span class=o>=</span> <span class=k>module</span><span class=p>.</span><span class=k>alb</span><span class=p>.</span><span class=k>security_group_id</span><span class=c1> # Adjust this if the source is not the ALB
</span></span></span><span class=line><span class=cl><span class=c1></span>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;aws_security_group_rule&#34; &#34;ingress_nfs_from_alb&#34;</span> {<span class=c1> # EFS
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  type</span>                     <span class=o>=</span> <span class=s2>&#34;ingress&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  from_port</span>                <span class=o>=</span> <span class=m>2049</span>
</span></span><span class=line><span class=cl><span class=n>  to_port</span>                  <span class=o>=</span> <span class=m>2049</span>
</span></span><span class=line><span class=cl><span class=n>  protocol</span>                 <span class=o>=</span> <span class=s2>&#34;tcp&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  security_group_id</span>        <span class=o>=</span> <span class=k>aws_security_group</span><span class=p>.</span><span class=k>autoscaling_sg</span><span class=p>.</span><span class=k>id</span>
</span></span><span class=line><span class=cl><span class=n>  source_security_group_id</span> <span class=o>=</span> <span class=k>module</span><span class=p>.</span><span class=k>alb</span><span class=p>.</span><span class=k>security_group_id</span><span class=c1> # Adjust this if the source is not the ALB
</span></span></span><span class=line><span class=cl><span class=c1></span>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;aws_security_group_rule&#34; &#34;egress_all&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  type</span>              <span class=o>=</span> <span class=s2>&#34;egress&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  from_port</span>         <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=n>  to_port</span>           <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=n>  protocol</span>          <span class=o>=</span> <span class=s2>&#34;-1&#34;</span><span class=c1> # Represents all protocols
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  security_group_id</span> <span class=o>=</span> <span class=k>aws_security_group</span><span class=p>.</span><span class=k>autoscaling_sg</span><span class=p>.</span><span class=k>id</span>
</span></span><span class=line><span class=cl><span class=n>  cidr_blocks</span>       <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;0.0.0.0/0&#34;</span><span class=p>]</span><span class=c1> # Allows all outbound traffic
</span></span></span><span class=line><span class=cl><span class=c1></span>}<span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># Role Policies to add to EC2 Role
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>resource</span> <span class=s2>&#34;aws_iam_policy&#34; &#34;efs_full_access&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  name</span>        <span class=o>=</span> <span class=s2>&#34;EFSFullAccess&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  description</span> <span class=o>=</span> <span class=s2>&#34;Provides full access to EFS&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  policy</span> <span class=o>=</span> <span class=k>jsonencode</span><span class=p>(</span>{
</span></span><span class=line><span class=cl><span class=n>    Version</span> <span class=o>=</span> <span class=s2>&#34;2012-10-17&#34;</span>
</span></span><span class=line><span class=cl><span class=n>    Statement</span> <span class=o>=</span> <span class=p>[</span>{
</span></span><span class=line><span class=cl><span class=n>      Action</span>   <span class=o>=</span> <span class=s2>&#34;elasticfilesystem:*&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      Effect</span>   <span class=o>=</span> <span class=s2>&#34;Allow&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      Resource</span> <span class=o>=</span> <span class=s2>&#34;*&#34;</span>
</span></span><span class=line><span class=cl>    }<span class=p>]</span>
</span></span><span class=line><span class=cl>  }<span class=p>)</span>
</span></span><span class=line><span class=cl>}<span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># elasticfilesystem:Describe* elasticfilesystem:ClientWrite elasticfilesystem:ClientMount
</span></span></span><span class=line><span class=cl><span class=c1># &#34;Resource&#34;: &#34;${module.efs.arn}&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;aws_iam_policy&#34; &#34;rds_full_access&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  name</span>        <span class=o>=</span> <span class=s2>&#34;RDSFullAccess&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  description</span> <span class=o>=</span> <span class=s2>&#34;Provides full access to RDS&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  policy</span> <span class=o>=</span> <span class=k>jsonencode</span><span class=p>(</span>{
</span></span><span class=line><span class=cl><span class=n>    Version</span> <span class=o>=</span> <span class=s2>&#34;2012-10-17&#34;</span>
</span></span><span class=line><span class=cl><span class=n>    Statement</span> <span class=o>=</span> <span class=p>[</span>{
</span></span><span class=line><span class=cl><span class=n>      Action</span>   <span class=o>=</span> <span class=s2>&#34;rds:*&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      Effect</span>   <span class=o>=</span> <span class=s2>&#34;Allow&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      Resource</span> <span class=o>=</span> <span class=s2>&#34;*&#34;</span>
</span></span><span class=line><span class=cl>    }<span class=p>]</span>
</span></span><span class=line><span class=cl>  }<span class=p>)</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>This is an example of the trade-off between modules and using direct resources. Since the modules don&rsquo;t directly support connecting RDS and EFS, we can create the necessary security groups for added services to interact.</p><h3 id=rds>RDS<a hidden class=anchor aria-hidden=true href=#rds>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>module</span> <span class=s2>&#34;rds&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  source</span>  <span class=o>=</span> <span class=s2>&#34;terraform-aws-modules/rds/aws&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  version</span> <span class=o>=</span> <span class=s2>&#34;~&gt; 6.5.2&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  identifier</span> <span class=o>=</span> <span class=s2>&#34;rds&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  engine</span>                <span class=o>=</span> <span class=s2>&#34;mysql&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  engine_version</span>        <span class=o>=</span> <span class=s2>&#34;8.0&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  family</span>                <span class=o>=</span> <span class=s2>&#34;mysql8.0&#34;</span><span class=c1> # DB parameter group
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  major_engine_version</span>  <span class=o>=</span> <span class=s2>&#34;8.0&#34;</span><span class=c1>      # DB option group
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  instance_class</span>        <span class=o>=</span> <span class=s2>&#34;db.t4g.micro&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  storage_type</span>          <span class=o>=</span> <span class=s2>&#34;gp3&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  allocated_storage</span>     <span class=o>=</span> <span class=m>20</span>
</span></span><span class=line><span class=cl><span class=n>  max_allocated_storage</span> <span class=o>=</span> <span class=m>100</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  availability_zone</span> <span class=o>=</span> <span class=k>module</span><span class=p>.</span><span class=k>vpc</span><span class=p>.</span><span class=k>azs</span><span class=p>[</span><span class=m>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  depends_on</span> <span class=o>=</span> <span class=p>[</span><span class=k>module</span><span class=p>.</span><span class=k>secret_db_password</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  username</span>                            <span class=o>=</span> <span class=s2>&#34;wordpress&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  password</span>                            <span class=o>=</span> <span class=k>data</span><span class=p>.</span><span class=k>aws_secretsmanager_secret_version</span><span class=p>.</span><span class=k>secret_db_password</span><span class=p>.</span><span class=k>secret_string</span><span class=c1> # fetch actual password string from secrets manger
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  db_name</span>                             <span class=o>=</span> <span class=s2>&#34;wordpressdb&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  port</span>                                <span class=o>=</span> <span class=m>3306</span>
</span></span><span class=line><span class=cl><span class=n>  manage_master_user_password</span>         <span class=o>=</span> <span class=kt>false</span>
</span></span><span class=line><span class=cl><span class=n>  iam_database_authentication_enabled</span> <span class=o>=</span> <span class=kt>false</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  skip_final_snapshot</span>    <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl><span class=n>  create_db_option_group</span> <span class=o>=</span> <span class=kt>false</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  db_subnet_group_name</span>   <span class=o>=</span> <span class=k>module</span><span class=p>.</span><span class=k>vpc</span><span class=p>.</span><span class=k>database_subnet_group</span>
</span></span><span class=line><span class=cl><span class=n>  vpc_security_group_ids</span> <span class=o>=</span> <span class=p>[</span><span class=k>module</span><span class=p>.</span><span class=k>security_group</span><span class=p>.</span><span class=k>security_group_id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>module</span> <span class=s2>&#34;security_group&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  source</span>  <span class=o>=</span> <span class=s2>&#34;terraform-aws-modules/security-group/aws&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  version</span> <span class=o>=</span> <span class=s2>&#34;~&gt; 5.0&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  name</span>        <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>name</span>
</span></span><span class=line><span class=cl><span class=n>  description</span> <span class=o>=</span> <span class=s2>&#34;EC2 docker access to RDS&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  vpc_id</span>      <span class=o>=</span> <span class=k>module</span><span class=p>.</span><span class=k>vpc</span><span class=p>.</span><span class=k>vpc_id</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  ingress_with_cidr_blocks</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    {<span class=c1> # RDS Ingress
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>      from_port</span>   <span class=o>=</span> <span class=m>3306</span>
</span></span><span class=line><span class=cl><span class=n>      to_port</span>     <span class=o>=</span> <span class=m>3306</span>
</span></span><span class=line><span class=cl><span class=n>      protocol</span>    <span class=o>=</span> <span class=s2>&#34;tcp&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      description</span> <span class=o>=</span> <span class=s2>&#34;MySQL access from within VPC&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      cidr_blocks</span> <span class=o>=</span> <span class=k>module</span><span class=p>.</span><span class=k>vpc</span><span class=p>.</span><span class=k>vpc_cidr_block</span>
</span></span><span class=line><span class=cl>    }<span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  tags</span> <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>tags</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>Here we simply create the rds instance, and set the password to be retrieved from the secrets manager later on. The depends_on definition makes sure the module has generated the password before it&rsquo;s executed. This usually isn&rsquo;t required because TF can figure out execution order dependencies, but in this case it is warranted.</p><h3 id=efs>EFS<a hidden class=anchor aria-hidden=true href=#efs>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>module</span> <span class=s2>&#34;efs&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  source</span>  <span class=o>=</span> <span class=s2>&#34;terraform-aws-modules/efs/aws&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  version</span> <span class=o>=</span> <span class=s2>&#34;~&gt; 1.6.1&#34;</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>  # File system
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  name</span>           <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>name</span>
</span></span><span class=line><span class=cl><span class=n>  creation_token</span> <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>name</span>
</span></span><span class=line><span class=cl><span class=n>  encrypted</span>      <span class=o>=</span> <span class=kt>false</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>  #kms_key_arn    = module.kms.key_arn
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=n>  performance_mode</span> <span class=o>=</span> <span class=s2>&#34;generalPurpose&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  throughput_mode</span>  <span class=o>=</span> <span class=s2>&#34;bursting&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  lifecycle_policy</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>    transition_to_ia</span>                    <span class=o>=</span> <span class=s2>&#34;AFTER_30_DAYS&#34;</span>
</span></span><span class=line><span class=cl><span class=n>    transition_to_primary_storage_class</span> <span class=o>=</span> <span class=s2>&#34;AFTER_1_ACCESS&#34;</span>
</span></span><span class=line><span class=cl>  }<span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>  # File system policy
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  attach_policy</span>                      <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl><span class=n>  bypass_policy_lockout_safety_check</span> <span class=o>=</span> <span class=kt>false</span><span class=c1> # for KMS key management
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=n>  deny_nonsecure_transport</span> <span class=o>=</span> <span class=kt>false</span><span class=c1> # Allow non encrypted traffic for testing
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=n>  policy_statements</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    {
</span></span><span class=line><span class=cl><span class=n>      sid</span>     <span class=o>=</span> <span class=s2>&#34;Example&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      actions</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;elasticfilesystem:*&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>      principals</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        {
</span></span><span class=line><span class=cl><span class=n>          type</span>        <span class=o>=</span> <span class=s2>&#34;AWS&#34;</span>
</span></span><span class=line><span class=cl><span class=n>          identifiers</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;*&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>      <span class=p>]</span>
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>  <span class=p>]</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>  # Replace &#34;*&#34; with [module.ecs_service.tasks_iam_role_arn]
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>  # Mount targets / security group
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  mount_targets</span>              <span class=o>=</span><span class=n> { for k, v in zipmap(local.azs, module.vpc.private_subnets) : k</span> <span class=o>=</span><span class=n>&gt; { subnet_id</span> <span class=o>=</span> <span class=k>v</span> } }
</span></span><span class=line><span class=cl><span class=n>  security_group_description</span> <span class=o>=</span> <span class=s2>&#34;Example EFS security group&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  security_group_vpc_id</span>      <span class=o>=</span> <span class=k>module</span><span class=p>.</span><span class=k>vpc</span><span class=p>.</span><span class=k>vpc_id</span>
</span></span><span class=line><span class=cl><span class=n>  security_group_rules</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>    vpc</span> <span class=o>=</span> {<span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>      # Relying on the defaults provided for EFS/NFS (2049/TCP + ingress)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>      description</span> <span class=o>=</span> <span class=s2>&#34;NFS ingress from VPC private subnets&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      cidr_blocks</span> <span class=o>=</span> <span class=k>module</span><span class=p>.</span><span class=k>vpc</span><span class=p>.</span><span class=k>private_subnets_cidr_blocks</span>
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>  }<span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>  # Access point(s)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  access_points</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>    posix</span> <span class=o>=</span> {<span class=c1> # Used for strict security controls and user isolation
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>      name</span> <span class=o>=</span> <span class=s2>&#34;posix-example&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      posix_user</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>        gid</span>            <span class=o>=</span> <span class=m>1001</span>
</span></span><span class=line><span class=cl><span class=n>        uid</span>            <span class=o>=</span> <span class=m>1001</span>
</span></span><span class=line><span class=cl><span class=n>        secondary_gids</span> <span class=o>=</span> <span class=p>[</span><span class=m>1002</span><span class=p>]</span>
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>      tags</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>        Additional</span> <span class=o>=</span> <span class=s2>&#34;Wordpress EFS&#34;</span>
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl><span class=n>    root</span> <span class=o>=</span> {<span class=c1> # Default
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>      root_directory</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>        path</span> <span class=o>=</span> <span class=s2>&#34;/&#34;</span>
</span></span><span class=line><span class=cl><span class=n>        creation_info</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>          owner_gid</span>   <span class=o>=</span> <span class=m>0</span><span class=c1> # Non-root user is 1001. (as defined in dockerfile) root is 0
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>          owner_uid</span>   <span class=o>=</span> <span class=m>0</span><span class=c1> # Non-root user is 1001. (as defined in dockerfile) root is 0
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>          permissions</span> <span class=o>=</span> <span class=s2>&#34;755&#34;</span>
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>When our container can mount and read/write with our EFS filesystem, the volumes from its perspective looks like this. 8 exabytes, tells us about the potential scalability of this service (also warns us of reasons it could get out hand and need monitoring)</p><p><img loading=lazy src=/posts/docker_wordpress/efs.png alt=efs></p><h3 id=acm>ACM<a hidden class=anchor aria-hidden=true href=#acm>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=c1># Obtain SSL certificate
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>module</span> <span class=s2>&#34;acm&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  source</span>  <span class=o>=</span> <span class=s2>&#34;terraform-aws-modules/acm/aws&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  version</span> <span class=o>=</span> <span class=s2>&#34;~&gt; 5.0.1&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  domain_name</span>            <span class=o>=</span> <span class=s2>&#34;wp.tbalza.net&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  validation_method</span>      <span class=o>=</span> <span class=s2>&#34;DNS&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  wait_for_validation</span>    <span class=o>=</span> <span class=kt>false</span>
</span></span><span class=line><span class=cl><span class=n>  create_route53_records</span> <span class=o>=</span> <span class=kt>false</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  tags</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>    Name</span> <span class=o>=</span> <span class=s2>&#34;wp.tbalza.net&#34;</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>Configuring TLS is deceptively simple in this setup. We don&rsquo;t need Route53 at all, since our namecheap.com registrar points to Cloudflare NS records, which can be managed via API tokens that later define our CNAME records. We simply generate the certificate with AWS with DNS verification and pass that on to our next module.</p><h3 id=dns>DNS<a hidden class=anchor aria-hidden=true href=#dns>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=c1># Validate ACM SSL certificate. Uses the output of acm module to to complete DNS validation in CloudFlare
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>variable</span> <span class=s2>&#34;validation_record_keys&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  type</span>    <span class=o>=</span> <span class=k>list</span><span class=p>(</span><span class=k>string</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>  default</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;record1&#34;, &#34;record2&#34;, &#34;record3&#34;, &#34;record4&#34;</span><span class=p>]</span><span class=c1> # Adjust based on the number of expected ACM validation records
</span></span></span><span class=line><span class=cl><span class=c1></span>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>locals</span> {<span class=c1> # The output is a map within a single list item, iterate through to define values
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  acm_validation_records</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=k>idx</span><span class=p>,</span> <span class=k>val</span> <span class=k>in</span> <span class=k>module</span><span class=p>.</span><span class=k>acm</span><span class=p>.</span><span class=k>acm_certificate_domain_validation_options</span> <span class=err>:</span>
</span></span><span class=line><span class=cl><span class=n>    &#34;record${idx + 1}&#34;</span> <span class=o>=</span><span class=err>&gt;</span> {
</span></span><span class=line><span class=cl><span class=n>      name</span>  <span class=o>=</span> <span class=k>val</span><span class=p>.</span><span class=k>resource_record_name</span><span class=c1>  # Will appear as unresolved ref before apply
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>      value</span> <span class=o>=</span> <span class=k>val</span><span class=p>.</span><span class=k>resource_record_value</span><span class=c1> # Will appear as unresolved ref before apply
</span></span></span><span class=line><span class=cl><span class=c1></span>    }
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;cloudflare_record&#34; &#34;acm_validation&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  for_each</span> <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>acm_validation_records</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  zone_id</span> <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>cloudflare_zone_id</span>
</span></span><span class=line><span class=cl><span class=n>  name</span>    <span class=o>=</span> <span class=k>each</span><span class=p>.</span><span class=k>value</span><span class=p>.</span><span class=k>name</span><span class=c1> # Will appear as unresolved ref before apply
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  type</span>    <span class=o>=</span> <span class=s2>&#34;CNAME&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  value</span>   <span class=o>=</span> <span class=k>each</span><span class=p>.</span><span class=k>value</span><span class=p>.</span><span class=k>value</span><span class=c1> # Will appear as unresolved ref before apply
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  ttl</span>     <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=n>  proxied</span> <span class=o>=</span> <span class=kt>false</span>
</span></span><span class=line><span class=cl>}<span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># Create wp. subdomain for ALB. Update DNS (managed by CloudFlare) CNAME to point wp.tbalza.net to ALB
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>provider</span> <span class=s2>&#34;cloudflare&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  api_token</span> <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>cloudflare_api_token</span><span class=c1> # Ensure you have this variable in your variables.tf or passed in via environment variables
</span></span></span><span class=line><span class=cl><span class=c1></span>}
</span></span><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;cloudflare_record&#34; &#34;wp_cname&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  zone_id</span> <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>cloudflare_zone_id</span><span class=c1> # Ensure you have this variable in your variables.tf or passed in via environment variables
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  name</span>    <span class=o>=</span> <span class=s2>&#34;wp&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  value</span>   <span class=o>=</span> <span class=k>module</span><span class=p>.</span><span class=k>alb</span><span class=p>.</span><span class=k>dns_name</span>
</span></span><span class=line><span class=cl><span class=n>  type</span>    <span class=o>=</span> <span class=s2>&#34;CNAME&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  proxied</span> <span class=o>=</span> <span class=kt>false</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>Our nanecheap.com domain tbalza.net (which is hosted by GitHub pages, as per the first blog post) was changed to Cloudflare DNS management, by pointed to their NS records.</p><p><img loading=lazy src=/posts/docker_wordpress/dns.png alt=dns></p><p>With our Cloudflare API token, we can take the output of <code>module.acm.acm_certificate_domain_validation_options</code> that generates a map within a list and with TF convert this output, to call for the change of the CNAME wp. to be that which is dynamically generated by AWS.</p><h3 id=secrets-manager>Secrets Manager<a hidden class=anchor aria-hidden=true href=#secrets-manager>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>data</span> <span class=s2>&#34;aws_caller_identity&#34; &#34;current&#34;</span> {}<span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># Allow ECS tasks to access secrets
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>resource</span> <span class=s2>&#34;aws_iam_policy&#34; &#34;secrets_manager_access&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  name</span>        <span class=o>=</span> <span class=s2>&#34;ecs-secrets-manager-access&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  description</span> <span class=o>=</span> <span class=s2>&#34;Allows ECS tasks to access secrets in Secrets Manager&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  policy</span> <span class=o>=</span> <span class=k>jsonencode</span><span class=p>(</span>{
</span></span><span class=line><span class=cl><span class=n>    Version</span> <span class=o>=</span> <span class=s2>&#34;2012-10-17&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=n>    Statement</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      {
</span></span><span class=line><span class=cl><span class=n>        Action</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;secretsmanager:GetSecretValue&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;secretsmanager:DescribeSecret&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>],</span>
</span></span><span class=line><span class=cl><span class=n>        Effect</span>   <span class=o>=</span> <span class=s2>&#34;Allow&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=n>        Resource</span> <span class=o>=</span> <span class=s2>&#34;*&#34;</span><span class=c1> # It&#39;s better to specify exact ARNs of secrets
</span></span></span><span class=line><span class=cl><span class=c1></span>      }
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>  }<span class=p>)</span>
</span></span><span class=line><span class=cl>}<span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># Generate wordpress db password
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>data</span> <span class=s2>&#34;aws_secretsmanager_secret_version&#34; &#34;secret_db_password&#34;</span> {<span class=c1> # required to return the actual pw string for the RDS module
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  secret_id</span>  <span class=o>=</span> <span class=k>module</span><span class=p>.</span><span class=k>secret_db_password</span><span class=p>.</span><span class=k>secret_id</span>
</span></span><span class=line><span class=cl><span class=n>  depends_on</span> <span class=o>=</span> <span class=p>[</span><span class=k>module</span><span class=p>.</span><span class=k>secret_db_password</span><span class=p>]</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>module</span> <span class=s2>&#34;secret_db_password&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  source</span>  <span class=o>=</span> <span class=s2>&#34;terraform-aws-modules/secrets-manager/aws&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  version</span> <span class=o>=</span> <span class=s2>&#34;~&gt; 1.1.2&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  name_prefix</span> <span class=o>=</span> <span class=s2>&#34;wordpress-db-password-&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  description</span> <span class=o>=</span> <span class=s2>&#34;Secret for WordPress Database Password&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  create_random_password</span>           <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl><span class=n>  random_password_length</span>           <span class=o>=</span> <span class=m>41</span><span class=c1>  # RDS length limit
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  random_password_override_special</span> <span class=o>=</span> <span class=s2>&#34;_&#34;</span><span class=c1> # list of permitted special characters
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>}<span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># Generate wordpress user password
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>data</span> <span class=s2>&#34;aws_secretsmanager_secret_version&#34; &#34;secret_user_password&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  secret_id</span>  <span class=o>=</span> <span class=k>module</span><span class=p>.</span><span class=k>secret_user_password</span><span class=p>.</span><span class=k>secret_id</span>
</span></span><span class=line><span class=cl><span class=n>  depends_on</span> <span class=o>=</span> <span class=p>[</span><span class=k>module</span><span class=p>.</span><span class=k>secret_user_password</span><span class=p>]</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>module</span> <span class=s2>&#34;secret_user_password&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  source</span>  <span class=o>=</span> <span class=s2>&#34;terraform-aws-modules/secrets-manager/aws&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  version</span> <span class=o>=</span> <span class=s2>&#34;~&gt; 1.1.2&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  name_prefix</span> <span class=o>=</span> <span class=s2>&#34;wordpress-user-password-&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  description</span> <span class=o>=</span> <span class=s2>&#34;Secret for WordPress User Password&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  create_random_password</span>           <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl><span class=n>  random_password_length</span>           <span class=o>=</span> <span class=m>41</span><span class=c1>  # RDS length limit
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  random_password_override_special</span> <span class=o>=</span> <span class=s2>&#34;_&#34;</span><span class=c1> # list of permitted special characters
</span></span></span><span class=line><span class=cl><span class=c1></span>}
</span></span></code></pre></div><h3 id=conclusions>Conclusions<a hidden class=anchor aria-hidden=true href=#conclusions>#</a></h3><p>We&rsquo;ve successfully set up a high-availability environment ensuring our application layer is both scalable and resilient. Additionally, by separating storage with EFS and database operations via RDS, we&rsquo;ve ensured stronger, more isolated backups and enabled smoother rolling updates. This design keeps the user experience uninterrupted, significantly reducing downtime during updates.</p><h4 id=areas-for-improvement>Areas for Improvement<a hidden class=anchor aria-hidden=true href=#areas-for-improvement>#</a></h4><p><strong>Autoscaling:</strong> Refine autoscaling by adjusting the desired_count based on real-time needs. This ensures our setup can dynamically allocate resources and ECS Tasks according to our Target Tracking Policy without resetting our capacity planning with each deployment.</p><p><strong>Principle of Least Privilege:</strong> Tighten security by refining ARN/actions/resources to uphold the principle of least privilege, ensuring containers operate securely without root access.</p><p><strong>CloudFront:</strong> Optimize our setup further, reducing load on our compute resources by serving static files from closer to the user by adding a caching layer with CloudFront.</p><p><strong>CI/CD Integration:</strong> Integrate with CI/CD systems like Jenkins or CircleCI, using unique Git commit hashes to manage deployments. This ensures continuous integration and deployment for every change, maintaining a smooth and consistent update process.</p><p><strong>Tagging Strategy:</strong> Ensure all resources are properly tagged to streamline billing and management.</p><p><strong>Backup Procedures:</strong> Automate backup processes for RDS and EFS will be a priority to safeguard our data effectively.</p><p><strong>Monitoring and Alerts:</strong> Implement monitoring solutions with tools like Grafana, coupled with SNS notifications, to stay ahead of scaling events and other significant system events.</p><h4 id=looking-ahead>Looking Ahead<a hidden class=anchor aria-hidden=true href=#looking-ahead>#</a></h4><p>In our next piece, we&rsquo;ll dive into the implementation of CI/CD systems and explore real-world production scenarios, including Git operations and rolling updates, to further enhance our setup.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://tbalza.net/tags/docker/>Docker</a></li><li><a href=https://tbalza.net/tags/terraform/>Terraform</a></li><li><a href=https://tbalza.net/tags/ecs/>Ecs</a></li><li><a href=https://tbalza.net/tags/ssl/>Ssl</a></li><li><a href=https://tbalza.net/tags/bash/>Bash</a></li><li><a href=https://tbalza.net/tags/dns/>Dns</a></li></ul><nav class=paginav><a class=next href=https://tbalza.net/using-terraform-for-amazon-api-gateway-deployment/><span class=title>Next »</span><br><span>Using Terraform for Amazon API Gateway Deployment</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://tbalza.net/>Tomas Balza</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>