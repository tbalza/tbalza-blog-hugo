<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Zero-Touch Provisioning & Deployment of Kubernetes CI/CD Pipeline | Tomas Balza</title>
<meta name=keywords content="kubernetes,argocd,jenkins,elk,prometheus,django,sonarqube,terraform,fluentbit,gitops,eks,helm,kustomize"><meta name=description content="This article explores a Proof of Concept for zero-touch provisioning and deployment, highlighting efficient operational workflows."><meta name=author content><link rel=canonical href=https://tbalza.net/zero-touch-provisioning-deployment-of-kubernetes-ci/cd-pipeline/><link crossorigin=anonymous href=/assets/css/stylesheet.befb480beb9ffd243cbfb441ccad97d0a74979a7331cdc9d7df0be5b7059d9c2.css integrity="sha256-vvtIC+uf/SQ8v7RBzK2X0KdJeaczHNydffC+W3BZ2cI=" rel="preload stylesheet" as=style><link rel=icon href=https://tbalza.net/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://tbalza.net/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://tbalza.net/favicon-32x32.png><link rel=apple-touch-icon href=https://tbalza.net/apple-touch-icon.png><link rel=mask-icon href=https://tbalza.net/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://tbalza.net/zero-touch-provisioning-deployment-of-kubernetes-ci/cd-pipeline/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Zero-Touch Provisioning & Deployment of Kubernetes CI/CD Pipeline"><meta property="og:description" content="This article explores a Proof of Concept for zero-touch provisioning and deployment, highlighting efficient operational workflows."><meta property="og:type" content="article"><meta property="og:url" content="https://tbalza.net/zero-touch-provisioning-deployment-of-kubernetes-ci/cd-pipeline/"><meta property="og:image" content="https://tbalza.net/posts/kubernetes_cicd/cover3.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-09-01T00:00:00+00:00"><meta property="article:modified_time" content="2024-09-01T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://tbalza.net/posts/kubernetes_cicd/cover3.png"><meta name=twitter:title content="Zero-Touch Provisioning & Deployment of Kubernetes CI/CD Pipeline"><meta name=twitter:description content="This article explores a Proof of Concept for zero-touch provisioning and deployment, highlighting efficient operational workflows."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://tbalza.net/posts/"},{"@type":"ListItem","position":2,"name":"Zero-Touch Provisioning \u0026 Deployment of Kubernetes CI/CD Pipeline","item":"https://tbalza.net/zero-touch-provisioning-deployment-of-kubernetes-ci/cd-pipeline/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Zero-Touch Provisioning \u0026 Deployment of Kubernetes CI/CD Pipeline","name":"Zero-Touch Provisioning \u0026 Deployment of Kubernetes CI\/CD Pipeline","description":"This article explores a Proof of Concept for zero-touch provisioning and deployment, highlighting efficient operational workflows.","keywords":["kubernetes","argocd","jenkins","elk","prometheus","django","sonarqube","terraform","fluentbit","gitops","eks","helm","kustomize"],"articleBody":"This article showcases a Proof of Concept (PoC) where the end result is a fully operational Kubernetes cluster hosting a sample full-stack Django application, along with tools to manage its CI/CD and observability tasks.\nIn this project, all applications will launch and operate seamlessly after executing this command from the project home path:\nterraform -chdir=\"terraform/01-eks-cluster/\" apply -auto-approve \u0026\u0026 \\ terraform -chdir=\"terraform/02-argocd/\" apply -auto-approve Each component with a web UI will automatically receive its own dynamic CNAME:\ndjango.yourdomain.com argocd.yourdomain.com sonarqube.yourdomain.com jenkins.yourdomain.com kibana.yourdomain.com grafana.yourdomain.com and will be served behind an Application Load Balancer with a configured TLS certificate.\nCredentials are dynamically generated and accessible through SSM Parameter Store.\nOnce operational, any approved modifications to the Django app will automatically trigger the CI/CD pipeline (pictured in the diagram above), and new updates will be readily accessible via the generated subdomain.\nYou can find the complete setup on instructions in the GitHub repository.\nTooling Overview EKS: (Kubernetes Service) Amazon’s managed container service to run and scale Kubernetes applications in the cloud without having to manage the underlying control plane.\nTerraform: (IaC) A declarative infrastructure as code tool that allows you to efficiently build, change, and version infrastructure.\nECR: (Artifact Repo) Amazon’s Docker container registry that integrates with EKS allows you to store, manage, and deploy container images in this scenario.\nJenkins: (CI) A modular automation server that, in this case, builds, tests, and pushes container images to ECR.\nArgoCD: (CD) A declarative, GitOps continuous delivery tool that automates the deployment of desired application states in the Kubernetes clusters.\nElasticsearch: (Observability-Logs) A search engine used to index and analyze logs generated by applications and infrastructure. The installed stack has Kibana which provides the UI, and FluentBit which collects and transforms logs from the cluster resources.\nPrometheus: (Observability-Metrics) A comprehensive toolkit that is well-suited for monitoring Kubernetes environments. The installed stack includes Grafana which allows for interactive visualization of the metrics.\nSonarqube: (DevSecOps-Static Code Analysis) An automated code review tool to detect bugs and vulnerabilities in your code. It integrates with existing Jenkins at build time to provide insights into code quality and security risks.\nDjango: (Main App) A high-level Python Web framework that encourages rapid development and clean, pragmatic design. It’s the main or customer-facing demo application running in the Kubernetes cluster.\nProof of Concept DevOps integrates development and operations to enhance efficiency and reliability using IaC and GitOps practices. At the same it time promotes a space where developers can stay flexible exploring new ideas, while staying aligned with budgets and business strategies.\nAdapting to this balanced environment requires fostering collaboration from key stakeholders, including management and developers.\nThis collaboration effort is often aided by demonstrating the practical benefits of DevOps through Proofs of Concept that align with business goals, and improve software quality without slowing things down.\nZero-Touch Setup A Zero-Touch approach seeks to automate infrastructure provisioning and code deployment, all without requiring any manual interaction among the intermediate steps.\nFundamentally this approach is the opposite of ‘ClickOps’, where configurations are manually executed by navigating, copy/pasting and clicking through consoles and user interfaces.\nIn this project, data that can’t be directly baked into files (such as database endpoints generated by terraform during the provisioning process, and API keys generated during the deployment process) still exist in the code, but as abstractions that make use of tools such as External Secrets Operator to be correctly interpreted by the whole system.\nThis bridges the information flow gap between IaC and Gitops tasks, allowing absolutely all configuration elements to exist in the codebase. This is one of the patterns used in this PoC that eliminates the need for manual intervention while spinning up the cluster and its resources.\nGetting started To test this out on your own, follow the step-by-step instructions in the GitHub repository which cover everything that’s necessary to get started, like installing CLI tools and configuring the required credentials required for the project tools to interact with AWS, GitHub, and Cloudflare.\nProvisioning Stage Spinning up the Initial Infrastructure with Terraform ┌── argo-apps # Deployment Stage Addons/Apps │ ├── argocd │ ├── argocd-image-updater │ ├── django │ ├── eck-stack │ ├── fluent │ ├── jenkins │ ├── prometheus │ └── sonarqube ├── django-todo # Main App Developement └── terraform ├── 01-eks-cluster # Terraform Infra Provisioning Stage └── 02-argocd # Terraform ArgoCD Boostrap Stage The highlighted lines in the project’s directory structure above show what will run first to initiate the first stage towards spinning up a full Kubernetes cluster with its CI/CD pipeline.\nThis project uses third-party Terraform modules like the AWS EKS module to streamline infrastructure provisioning. These modules come with robust documentation and supported community-tested practices that in many cases can simplify management.\nExecuting terraform apply -auto-approve from within the /terraform/01-eks-cluster/ directory, will provision the EKS cluster with Node Groups, Access Entries, and resources like IAM Policies/Roles/Security Groups, ACM, VPC, RDS, SSM, Application Load Balancer, and ECR.\nDeploying Core Addons resource \"helm_release\" \"aws_load_balancer_controller\" { name = \"aws-load-balancer-controller\" repository = \"https://aws.github.io/eks-charts\" chart = \"aws-load-balancer-controller\" namespace = \"kube-system\" version = \"1.8.1\" # (Chart 1.8.1, LBC 2.8.1) set { name = \"serviceAccount.annotations.eks\\\\.amazonaws\\\\.com/role-arn\" # value = module.aws_load_balancer_controller_irsa_role.iam_role_arn } values = [ \u003c\u003c-EOF nodeSelector: role: \"ci-cd\" EOF ] } Using the AWS EKS module and the helm provider, Terraform will also deploy the cluster’s core addons (CoreDNS, Kube-Proxy, VPC-CNI, EBS CSI Driver, AWS Load Balancer Controller, ExternalDNS, External Secrets Operator).\nThese are addons that don’t change that often (compared to the lifecycle of the main app and CI/CD tools), and that need to be in place before ArgoCD is deployed. While managing deployment via Terraform can be cumbersome down the line, setting these core addons at this stage strikes an acceptable balance with practicality and operability.\nPopulating SSM Parameter Store ############################################################################### # RDS - sonarqube ############################################################################### resource \"random_password\" \"sonarqube_database_password\" { length = 28 special = true override_special = \"!#$%\u0026'()+,-.=?^_~\" # special character whitelist } At this stage data that needs to be accessed by ArgoCD such as RDS endpoints and passwords will be generated.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 locals { parameters = { \"sonar_rds_user\" = { value = local.sonar_rds_user } \"sonar_rds_dbname\" = { value = local.sonar_rds_dbname } \"sonar_rds_port\" = { value = local.sonar_rds_port } \"sonar_rds_password\" = { value = random_password.sonarqube_database_password.result } \"sonar_rds_endpoint\" = { value = \"jdbc:postgresql://${module.db_sonarqube.db_instance_endpoint}/${local.sonar_rds_dbname}\" # `SONARQUBE_JDBC_URL` requires baked in interpolation # jdbc:postgresql://[host]:[port]/[database] } module \"ssm-parameter\" { source = \"terraform-aws-modules/ssm-parameter/aws\" version = \"1.1.1\" for_each = local.parameters name = try(each.value.name, each.key) } And populated to the SSM Parameter Store, that will be used by External Secrets Operator later on.\nACM and Cloudflare Since ALB cannot readily interface with cert-manager (at the time of writing) and this blog’s TLD is already running GitHub pages, I decided to go with ACM and Cloudflare.\nmodule \"acm\" { source = \"terraform-aws-modules/acm/aws\" version = \"5.0.1\" # ACM cert for subdomains only domain_name = \"*.${local.domain}\" # only for subdomains of *.tbalza.net, TLD is not included by default zone_id = var.CFL_ZONE_ID validation_method = \"DNS\" validation_record_fqdns = cloudflare_record.validation[*].hostname wait_for_validation = true create_route53_records = false } The ACM module creates a wildcard certificate, that will be used when ExternalDNS dynamically creates the subdomains for the CI/CD addons and the main app.\nprovider \"cloudflare\" { api_token = var.CFL_API_TOKEN } # Validate generated ACM cert by creating validation domain record resource \"cloudflare_record\" \"validation\" { count = length(module.acm.distinct_domain_names) zone_id = var.CFL_ZONE_ID name = element(module.acm.validation_domains, count.index)[\"resource_record_name\"] type = element(module.acm.validation_domains, count.index)[\"resource_record_type\"] value = trimsuffix(element(module.acm.validation_domains, count.index)[\"resource_record_value\"], \".\") # ensure no trailing periods that could disrupt DNS record creation ttl = 60 proxied = false allow_overwrite = true } Using Cloudflare’s provider, Terraform is able to generate the CNAME record that ACM requires in order to validate the certificate.\nCFL_API_TOKEN = \"your-cloudflare-token\" CFL_ZONE_ID = \"your-cloudflare-zoneid\" ARGOCD_GITHUB_TOKEN = \"your-github-token\" ARGOCD_GITHUB_USER = \"your-github-user\" The GitHub repo readme includes instructions and how to generate the necessary API keys, and have Terraform use them via terraform.tfvars without committing secrets to the repo with .gitignore\nThis whole initial provisioning cycle takes about ~25 minutes to complete.\nBootstrapping Stage Separating Infra and App State Files └── terraform ├── 01-eks-cluster # Terraform Infra Provisioning Stage │ └── terraform.tfstate └── 02-argocd # Terraform ArgoCD Boostrap Stage └── deploy_argocd.tf While installing core addons with Terraform can be an acceptable compromise, main application deployment should definitely be separated from infrastructure.\nApplications like ArgoCD or Karpenter will create AWS resources outside of Terraform’s purview. Separating the bootstrapping stage into its own state file prevents many issues down the line. One example is that it allows for resources on the cluster to be destroyed before destroying the cluster itself.\ndata \"terraform_remote_state\" \"eks\" { backend = \"local\" # Pending remote set up to enable collaboration, state locking etc. config = { path = \"${path.module}/../01-eks-cluster/terraform.tfstate\" } } provider \"helm\" { kubernetes { host = data.terraform_remote_state.eks.outputs.cluster_endpoint cluster_ca_certificate = base64decode(data.terraform_remote_state.eks.outputs.cluster_certificate_authority_data) exec { api_version = \"client.authentication.k8s.io/v1beta1\" # /v1alpha1\" args = [\"eks\", \"get-token\", \"--cluster-name\", data.terraform_remote_state.eks.outputs.cluster_name] command = \"aws\" } } } Using the terraform_remote_state Data Source you can dynamically reference the infra state file outputs (in /01-eks-cluster/terraform.tfstate) to keep crucial information in sync and avoid manual data entry.\nBootstrapping ArgoCD ┌── argo-apps │ ├── argocd │ │ ├── kustomization.yaml │ │ └── values.yaml │ ├── argocd-image-updater │ ├── django │ ├── eck-stack │ ├── fluent │ ├── jenkins │ ├── prometheus │ └── sonarqube ├── django-todo └── terraform ├── 01-eks-cluster └── 02-argocd └── deploy_argocd.tf apiVersion: kustomize.config.k8s.io/v1beta1 kind: Kustomization helmCharts: - name: argo-cd repo: https://argoproj.github.io/argo-helm version: 7.3.4 releaseName: argo-cd namespace: argocd valuesFile: values.yaml locals { argocd_config = yamldecode(file(\"${path.module}/../../argo-apps/argocd/kustomization.yaml\")) argocd_helm_chart = local.argocd_config.helmCharts[0] # Access the first (or only) element in the list } resource \"helm_release\" \"argo_cd\" { name = local.argocd_helm_chart.name repository = local.argocd_helm_chart.repo chart = local.argocd_helm_chart.releaseName version = local.argocd_helm_chart.version namespace = local.argocd_helm_chart.namespace create_namespace = true values = [file(\"${path.module}/../../argo-apps/argocd/values.yaml\")] } Additionally files outside Terraform’s directory can also be referenced, so that the helm resource’s values such as chart version and additional values.yaml overrides always point to the latest version, and the bootstrapping module does not have to be edited.\nApplicationSet resource \"kubectl_manifest\" \"example_applicationset\" { yaml_body = file(\"${path.module}/../../argo-apps/argocd/applicationset.yaml\") } Applying the ApplicationSet is the last step Terraform will perform. This will make ArgoCD deploy the main app and the CI/CD addons.\nDeployment Stage ApplicationSet II ┌── argo-apps │ ├── argocd │ │ ├── applicationset.yaml │ │ ├── kustomization.yaml │ ├── argocd-image-updater │ │ ├── kustomization.yaml │ ├── django │ │ ├── kustomization.yaml │ ├── eck-stack │ │ ├── elastic │ │ │ ├── kustomization.yaml │ │ ├── kustomization.yaml │ ├── fluent │ │ ├── kustomization.yaml │ ├── jenkins │ │ ├── kustomization.yaml │ ├── prometheus │ │ ├── kustomization.yaml │ └── sonarqube │ ├── kustomization.yaml ├── django-todo └── terraform After the first stage succeeds, ArgoCD will “take over” and deploy and manage a fully configured CI/CD pipeline with Sonarqube, Jenkins, ArgoCD Image Updater, Django, ElasticSearch, Fluentbit, Kibana, Prometheus and Grafana.\nTo create each application resource dynamically, ArgoCD uses applicationtset.yaml\napiVersion: argoproj.io/v1alpha1 kind: ApplicationSet metadata: name: cluster-addons namespace: argocd spec: goTemplate: true goTemplateOptions: [\"missingkey=error\"] generators: - git: repoURL: https://github.com/tbalza/kubernetes-cicd-zt.git revision: HEAD directories: - path: argo-apps/* template: metadata: name: '{{.path.basename}}' spec: project: \"default\" source: repoURL: https://github.com/tbalza/kubernetes-cicd-zt.git targetRevision: HEAD path: '{{.path.path}}' destination: server: https://kubernetes.default.svc namespace: '{{.path.basename}}' The ApplicationSet Git generator creates applications based on files or directory structure of a Git repository. Here, it scans all subdirectories inside argo-apps/* that contain a kustomization.yaml to create an application and assign the corresponding name and namespace using Go templating.\nKustomize and Helm ┌── argo-apps │ ├── argocd │ │ ├── kustomization.yaml │ │ └── values.yaml apiVersion: kustomize.config.k8s.io/v1beta1 kind: Kustomization namespace: argocd # required helmCharts: - name: argo-cd repo: https://argoproj.github.io/argo-helm version: 7.3.4 releaseName: argo-cd namespace: argocd valuesFile: values.yaml When the ApplicationSet loads, each kustomization.yaml from each of the app subdirectories, it will use Kustomize’s HelmChartInflationGenerator (helmCharts:) to install upstream charts with helm, using local values.yaml as overrides.\nThis approach has several advantages for installing well established open source tools. It simplifies management because manifests don’t need to be copied over and maintained. Pinning a version number ensures consistency in ephemeral deployments, and local values.yaml overrides provide flexibility in describing the particular configuration that suits our setup.\nAdditional Resources ┌── argo-apps │ ├── argocd │ │ ├── applicationset.yaml │ │ ├── ingress.yaml │ │ ├── init-container.yaml │ │ ├── job.yaml │ │ ├── kustomization.yaml │ │ ├── rbac.yaml │ │ ├── secrets2.yaml │ │ └── values.yaml apiVersion: kustomize.config.k8s.io/v1beta1 kind: Kustomization resources: - job.yaml - secrets2.yaml - ingress.yaml - rbac.yaml apiVersion: external-secrets.io/v1beta1 kind: ExternalSecret metadata: name: argocd-secrets-global namespace: argocd spec: refreshInterval: \"0\" secretStoreRef: name: argocd-secrets-global kind: SecretStore target: name: argocd-secrets-global creationPolicy: Owner immutable: true data: - secretKey: ARGOCD_AWS_ACCOUNT remoteRef: key: argo_cd_aws_account_number conversionStrategy: Default decodingStrategy: None metadataPolicy: None On top of that, we can also apply custom manifests, that will merge seamlessly before generating the app that started from an upstream helm chart.\nConfigurations that are not natively supported by the upstream chart can be amended using resources or even patches get around chart definitions clashing.\n│ ├── jenkins │ │ ├── kustomization.yaml │ │ ├── pipeline1.groovy │ │ └── values.yaml apiVersion: kustomize.config.k8s.io/v1beta1 kind: Kustomization configMapGenerator: - name: jenkins-scripts files: - pipeline1.groovy JCasC: configScripts: job-dsl: | jobs: - script: \u003e pipelineJob('build-django') { definition { cps { script(new File('/var/jenkins_home/groovy_scripts/pipeline1.groovy').text) sandbox(true) } } } persistence: volumes: - name: jenkins-groovy-scripts configMap: name: jenkins-scripts mounts: - mountPath: /var/jenkins_home/groovy_scripts name: jenkins-groovy-scripts readOnly: true Finally, we can also manage Kubernetes objects declaratively using configMapGenerator: which allows us, in this case, to abstract the Jenkins pipeline pipeline1.groovy from values.yaml. This keeps the main configuration lean, and allows us to version control and manage multiple complex pipelines with ease.\nThe end result is a streamlined way of representing the entirety of the apps configuration elements in the code base.\nCMP ┌── argo-apps │ ├── argocd │ │ └── values.yaml configs: cmp: create: true plugins: substitution: generate: command: [\"/bin/sh\", \"-c\"] args: - | AVAILABLE_VARS=$(env | cut -d \"=\" -f 1 | awk '{print \"$\"$1}' | tr \"\\n\" \" \") kustomize build --load-restrictor LoadRestrictionsNone --enable-helm | envsubst \"$AVAILABLE_VARS\" apiVersion: v1 kind: ServiceAccount metadata: annotations: eks.amazonaws.com/role-arn: 'arn:aws:iam::${ARGOCD_AWS_ACCOUNT}:role/ImageUpdaterRole' name: argocd-image-updater namespace: argocd With a Config Management Plugin, we can enhance Argo CD’s default capabilities to include envsubst during app builds. While Kustomize allows for the inclusion of environment variables in the pods resulting from an installation, it cannot reference external variables that aren’t hardcoded in its own configuration.\nTo address this, we first use AVAILABLE_VARS=$(env | cut -d \"=\" -f 1 | awk '{print \"$\"$1}' | tr \"\\n\" \" \") to preload all defined ENV vars necessary for Kustomization, ensuring that other scripts’ variables are not replaced with blanks unintentionally.\nRight after, the command kustomize build | envsubst \"$AVAILABLE_VARS\" executes for each app, dynamically substituting all pre-defined variables, such as the AWS Account Number ${ARGOCD_AWS_ACCOUNT} which would typically be static.\nAlthough this approach might be seen as a GitOps anti-pattern, it is a practical solution in scenarios managing numerous AWS accounts, offering a balanced approach to automation.\nExternalDNS ┌── argo-apps │ ├── argocd │ │ └── ingress.yaml apiVersion: networking.k8s.io/v1 kind: Ingress metadata: name: argo-cd-argocd-server namespace: argocd annotations: external-dns.alpha.kubernetes.io/hostname: argocd.${ARGOCD_APP_DOMAIN} spec: ingressClassName: alb rules: - host: argocd.${ARGOCD_APP_DOMAIN} http: paths: - path: / pathType: Prefix backend: service: name: argo-cd-argocd-server-grpc port: number: 80 - path: / pathType: Prefix backend: service: name: argo-cd-argocd-server port: number: 80 Each of the apps with an ingress resource has a external-dns.alpha.kubernetes.io/hostname annotation, which triggers ExternalDNS (installed in the provisioning stage), to automatically create the CNAME record corresponding to the app.\nThis could be templated further with Kustomize patches: for example, with a DEV environment where developers would have permissions to freely create any subdomain under *.development.${ARGOCD_APP_DOMAIN} for their testing purposes–potentially speeding up deliveries.\nresource \"kubectl_manifest\" \"cloudflare_api_key\" { yaml_body = \u003c\u003c-YAML apiVersion: v1 kind: Secret metadata: name: cloudflare-api-token namespace: kube-system type: Opaque data: apiToken: ${base64encode(var.CFL_API_TOKEN)} YAML } ExternalDNS uses the API Token defined earlier in /terraform/01-eks-cluster/setup_up_eks_cluster.tf with terraform.tfvars to interface with the Cloudflare API and create the CNAME records.\nRollingSync ┌── argo-apps │ ├── argocd │ │ └── applicationset.yaml │ ├── argocd-image-updater │ ├── django │ ├── eck-stack │ ├── fluent │ ├── jenkins │ ├── prometheus │ └── sonarqube ├── django-todo apiVersion: argoproj.io/v1alpha1 kind: ApplicationSet metadata: name: cluster-addons namespace: argocd spec: strategy: type: RollingSync rollingSync: steps: - matchExpressions: - key: syncorder # Label defined in appset template:,metadata:,labels: operator: In values: - argocd - matchExpressions: - key: syncorder operator: In values: - argocd-image-updater - sonarqube - matchExpressions: - key: syncorder operator: In values: - django - jenkins - matchExpressions: - key: syncorder operator: In values: - eck-stack - prometheus - matchExpressions: - key: syncorder operator: In values: - fluent template: metadata: name: '{{.path.basename}}' labels: syncorder: '{{.path.basename}}' # Label for rollingSync matchExpressions ArgoCD’s RollingSync allows us to sequentially deploy applications without requiring user input:\nArgoCD: is deployed first by itself, as it needs to restart with job.yaml in order to correctly load ENV vars for CMP value substitutions in other apps. It’s able to use dynamic values initially with Terraform’s bootstrap stage. Image Updater, SonarQube: SonarQube needs to be ready by the time the Jenkins pipeline is executed. Django, Jenkins: Jenkins then goes and starts to build the first image from /django-todo, and triggers a SonarQube analysis. Django is deployed, but ArgoCD detects it doesn’t have a valid image, so it is left in a “Progressing” state, until Image Updater detects the ECR build, and modifies the new image tag in /argo-apps/django/kustomization.yaml–finally prompting ArgoCD to auto-sync Django. Elasticsearch/Kibana, Prometheus/Grafana: Observability tools are then deployed. FluentBit: FluentBit needs to run after ES, in order for it to seamlessly create the index without having to restart the Elasticsearch pod. Conclusions We’ve covered different automation techniques using well-established open-source tools to successfully provision and deploy a complete CI/CD pipeline in a Kubernetes cluster.\nThese patterns align with the DevOps principles of efficiency and reliability, and also establish a single source of truth. By defining configurations in a declarative fashion and maintaining a fully automated pipeline, we can improve the speed of deliveries across environments and reduce the potential for human error.\nAreas for improvement\nGitHub Actions: Automate initial project setup (not just Provisioning and Deployment) Security: Scope Access Entries, IAM Policies/Roles/Security Groups, SSM, to follow the principle of least privilege. Non-root Django container CI: Code linting. CI tests. ECR Docker Caching Multi Environment Setup: Implement TF workspaces with .tfvars to enable Dev, Staging, QA, Prod, environments. Implement remote state management SSO: Configure Single Sign On for user management, and integrate with IAM permissions Software Development Life Cycle: Implement examples with trunk-based development and tags Repo Structure: Fix long .tf files, create directories for customer facing apps along with corresponding ApplicationSets Crucial Addons: Install backup/DR solutions, autoscaling, cost tracking, mono repo management Looking Ahead\nFor our next post, we’ll explore how implementing aspects of multi-environment setups and the software development lifecycle can make this PoC move closer to real-world production scenarios.\n","wordCount":"3125","inLanguage":"en","image":"https://tbalza.net/posts/kubernetes_cicd/cover3.png","datePublished":"2024-09-01T00:00:00Z","dateModified":"2024-09-01T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://tbalza.net/zero-touch-provisioning-deployment-of-kubernetes-ci/cd-pipeline/"},"publisher":{"@type":"Organization","name":"Tomas Balza","logo":{"@type":"ImageObject","url":"https://tbalza.net/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://tbalza.net/ accesskey=h title="Tomas Balza (Alt + H)"><img src=https://tbalza.net/profile-photo-2.jpg alt aria-label=logo height=35>Tomas Balza<p id=subtitle>DevOps / Tech Articles</p></a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://github.com/tbalza title=GitHub><span>GitHub</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://www.linkedin.com/in/tomas-balza-b075141b3 title=LinkedIn><span>LinkedIn</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://www.youtube.com/@tbalza-tech title=YouTube><span>YouTube</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Zero-Touch Provisioning & Deployment of Kubernetes CI/CD Pipeline</h1><div class=post-meta><span title='2024-09-01 00:00:00 +0000 UTC'>September, 2024</span>&nbsp;&nbsp;&nbsp;<a href=/tags/kubernetes> kubernetes</a> <a href=/tags/argocd>argocd</a> <a href=/tags/jenkins>jenkins</a> <a href=/tags/elk>elk</a> <a href=/tags/prometheus>prometheus</a> <a href=/tags/django>django</a> <a href=/tags/sonarqube>sonarqube</a> <a href=/tags/terraform>terraform</a> <a href=/tags/fluentbit>fluentbit</a> <a href=/tags/gitops>gitops</a> <a href=/tags/eks>eks</a> <a href=/tags/helm>helm</a> <a href=/tags/kustomize>kustomize</a></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#tooling-overview aria-label="Tooling Overview">Tooling Overview</a></li><li><a href=#proof-of-concept aria-label="Proof of Concept">Proof of Concept</a></li><li><a href=#zero-touch-setup aria-label="Zero-Touch Setup">Zero-Touch Setup</a></li><li><a href=#getting-started aria-label="Getting started">Getting started</a></li><li><a href=#provisioning-stage aria-label="Provisioning Stage">Provisioning Stage</a><ul><li><a href=#spinning-up-the-initial-infrastructure-with-terraform aria-label="Spinning up the Initial Infrastructure with Terraform">Spinning up the Initial Infrastructure with Terraform</a></li><li><a href=#deploying-core-addons aria-label="Deploying Core Addons">Deploying Core Addons</a></li><li><a href=#populating-ssm-parameter-store aria-label="Populating SSM Parameter Store">Populating SSM Parameter Store</a></li><li><a href=#acm-and-cloudflare aria-label="ACM and Cloudflare">ACM and Cloudflare</a></li></ul></li><li><a href=#bootstrapping-stage aria-label="Bootstrapping Stage">Bootstrapping Stage</a><ul><li><a href=#separating-infra-and-app-state-files aria-label="Separating Infra and App State Files">Separating Infra and App State Files</a></li><li><a href=#bootstrapping-argocd aria-label="Bootstrapping ArgoCD">Bootstrapping ArgoCD</a></li><li><a href=#applicationset aria-label=ApplicationSet>ApplicationSet</a></li></ul></li><li><a href=#deployment-stage aria-label="Deployment Stage">Deployment Stage</a><ul><li><a href=#applicationset-ii aria-label="ApplicationSet II">ApplicationSet II</a></li><li><a href=#kustomize-and-helm aria-label="Kustomize and Helm">Kustomize and Helm</a></li><li><a href=#additional-resources aria-label="Additional Resources">Additional Resources</a></li><li><a href=#cmp aria-label=CMP>CMP</a></li><li><a href=#externaldns aria-label=ExternalDNS>ExternalDNS</a></li><li><a href=#rollingsync aria-label=RollingSync>RollingSync</a></li></ul></li><li><a href=#conclusions aria-label=Conclusions>Conclusions</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"),document.querySelectorAll(".inner ul li a").forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();const t=this.getAttribute("href").slice(1),n=document.getElementById(t);window.scrollTo({top:getOffsetTop(n)-75,behavior:"smooth"})})})},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset-60>0&&getOffsetTop(e)-window.pageYOffset-60<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.scrollY}</script><div class=post-content><p>This article showcases a Proof of Concept (PoC) where the end result is a fully operational Kubernetes cluster hosting a sample full-stack Django application, along with tools to manage its CI/CD and observability tasks.</p><p><img loading=lazy src=/posts/kubernetes_cicd/diagram.drawio.png alt=diagram></p><p>In this project, all applications will launch and operate seamlessly after executing this command from the project home path:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>terraform -chdir<span class=o>=</span><span class=s2>&#34;terraform/01-eks-cluster/&#34;</span> apply -auto-approve <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>terraform -chdir<span class=o>=</span><span class=s2>&#34;terraform/02-argocd/&#34;</span> apply -auto-approve
</span></span></code></pre></div><p>Each component with a web UI will automatically receive its own dynamic CNAME:</p><ul><li>django.yourdomain.com</li><li>argocd.yourdomain.com</li><li>sonarqube.yourdomain.com</li><li>jenkins.yourdomain.com</li><li>kibana.yourdomain.com</li><li>grafana.yourdomain.com</li></ul><p>and will be served behind an Application Load Balancer with a configured TLS certificate.</p><p><img loading=lazy src=/posts/kubernetes_cicd/apps-r.jpg alt=app-screenshots></p><p>Credentials are dynamically generated and accessible through SSM Parameter Store.</p><p><img loading=lazy src=/posts/kubernetes_cicd/ssm.png alt=ssm></p><p>Once operational, any approved modifications to the Django app will automatically trigger the CI/CD pipeline (pictured in the diagram above), and new updates will be readily accessible via the generated subdomain.</p><p>You can find the complete setup on instructions in the <a href=https://github.com/tbalza/kubernetes-cicd-zt>GitHub repository</a>.</p><h3 id=tooling-overview>Tooling Overview<a hidden class=anchor aria-hidden=true href=#tooling-overview>#</a></h3><ul><li><p><strong>EKS:</strong> (Kubernetes Service) Amazon&rsquo;s managed container service to run and scale Kubernetes applications in the cloud without having to manage the underlying control plane.</p></li><li><p><strong>Terraform:</strong> (IaC) A declarative infrastructure as code tool that allows you to efficiently build, change, and version infrastructure.</p></li><li><p><strong>ECR:</strong> (Artifact Repo) Amazon&rsquo;s Docker container registry that integrates with EKS allows you to store, manage, and deploy container images in this scenario.</p></li><li><p><strong>Jenkins:</strong> (CI) A modular automation server that, in this case, builds, tests, and pushes container images to ECR.</p></li><li><p><strong>ArgoCD:</strong> (CD) A declarative, GitOps continuous delivery tool that automates the deployment of desired application states in the Kubernetes clusters.</p></li><li><p><strong>Elasticsearch:</strong> (Observability-Logs) A search engine used to index and analyze logs generated by applications and infrastructure. The installed stack has Kibana which provides the UI, and FluentBit which collects and transforms logs from the cluster resources.</p></li><li><p><strong>Prometheus:</strong> (Observability-Metrics) A comprehensive toolkit that is well-suited for monitoring Kubernetes environments. The installed stack includes Grafana which allows for interactive visualization of the metrics.</p></li><li><p><strong>Sonarqube:</strong> (DevSecOps-Static Code Analysis) An automated code review tool to detect bugs and vulnerabilities in your code. It integrates with existing Jenkins at build time to provide insights into code quality and security risks.</p></li><li><p><strong>Django:</strong> (Main App) A high-level Python Web framework that encourages rapid development and clean, pragmatic design. It&rsquo;s the main or <em>customer-facing</em> demo application running in the Kubernetes cluster.</p></li></ul><h3 id=proof-of-concept>Proof of Concept<a hidden class=anchor aria-hidden=true href=#proof-of-concept>#</a></h3><p>DevOps integrates development and operations to enhance efficiency and reliability using IaC and GitOps practices. At the same it time promotes a space where developers can stay flexible exploring new ideas, while staying aligned with budgets and business strategies.</p><p>Adapting to this balanced environment requires fostering collaboration from key stakeholders, including management and developers.</p><p>This collaboration effort is often aided by demonstrating the practical benefits of DevOps through <em>Proofs of Concept</em> that align with business goals, and improve software quality without slowing things down.</p><h3 id=zero-touch-setup>Zero-Touch Setup<a hidden class=anchor aria-hidden=true href=#zero-touch-setup>#</a></h3><p>A Zero-Touch approach seeks to automate infrastructure provisioning and code deployment, all without requiring any manual interaction among the intermediate steps.</p><p>Fundamentally this approach is the opposite of &lsquo;ClickOps&rsquo;, where configurations are manually executed by navigating, copy/pasting and clicking through consoles and user interfaces.</p><p>In this project, data that can&rsquo;t be directly baked into files (such as database endpoints generated by terraform during the provisioning process, and API keys generated during the deployment process) still exist in the code, but as abstractions that make use of tools such as External Secrets Operator to be correctly interpreted by the whole system.</p><p>This bridges the information flow gap between IaC and Gitops tasks, allowing absolutely <em><strong>all</strong></em> configuration elements to exist in the codebase. This is one of the patterns used in this PoC that eliminates the need for manual intervention while spinning up the cluster and its resources.</p><h3 id=getting-started>Getting started<a hidden class=anchor aria-hidden=true href=#getting-started>#</a></h3><p>To test this out on your own, follow the step-by-step instructions in the <a href=https://github.com/tbalza/kubernetes-cicd-zt>GitHub repository</a> which cover everything that&rsquo;s necessary to get started, like installing CLI tools and configuring the required credentials required for the project tools to interact with AWS, GitHub, and Cloudflare.</p><h3 id=provisioning-stage>Provisioning Stage<a hidden class=anchor aria-hidden=true href=#provisioning-stage>#</a></h3><p><img loading=lazy src=/posts/kubernetes_cicd/provisioning-stage.png alt=provisioning-stage></p><h4 id=spinning-up-the-initial-infrastructure-with-terraform>Spinning up the Initial Infrastructure with Terraform<a hidden class=anchor aria-hidden=true href=#spinning-up-the-initial-infrastructure-with-terraform>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=err>┌──</span> <span class=k>argo</span><span class=err>-</span><span class=k>apps</span><span class=c1>                       # Deployment Stage Addons/Apps
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>│</span>   <span class=err>├──</span> <span class=k>argocd</span> 
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>├──</span> <span class=k>argocd</span><span class=err>-</span><span class=k>image</span><span class=err>-</span><span class=k>updater</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>├──</span> <span class=k>django</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>├──</span> <span class=k>eck</span><span class=err>-</span><span class=k>stack</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>├──</span> <span class=k>fluent</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>├──</span> <span class=k>jenkins</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>├──</span> <span class=k>prometheus</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>└──</span> <span class=k>sonarqube</span>
</span></span><span class=line><span class=cl><span class=err>├──</span> <span class=k>django</span><span class=err>-</span><span class=k>todo</span><span class=c1>                     # Main App Developement
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=err>└──</span> <span class=k>terraform</span>
</span></span><span class="line hl"><span class=cl>    <span class=err>├──</span> <span class=m>01</span><span class=err>-</span><span class=k>eks</span><span class=err>-</span><span class=k>cluster</span><span class=c1>              # Terraform Infra Provisioning Stage
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=err>└──</span> <span class=m>02</span><span class=err>-</span><span class=k>argocd</span><span class=c1>                   # Terraform ArgoCD Boostrap Stage
</span></span></span></code></pre></div><p>The highlighted lines in the project&rsquo;s directory structure above show what will run first to initiate the first stage towards spinning up a full Kubernetes cluster with its CI/CD pipeline.</p><p>This project uses third-party Terraform modules like the <a href=https://github.com/terraform-aws-modules/terraform-aws-eks>AWS EKS module</a> to streamline infrastructure provisioning. These modules come with robust documentation and supported community-tested practices that in many cases can simplify management.</p><p>Executing <code>terraform apply -auto-approve</code> from within the <code>/terraform/01-eks-cluster/</code> directory, will provision the EKS cluster with Node Groups, Access Entries, and resources like IAM Policies/Roles/Security Groups, ACM, VPC, RDS, SSM, Application Load Balancer, and ECR.</p><h4 id=deploying-core-addons>Deploying Core Addons<a hidden class=anchor aria-hidden=true href=#deploying-core-addons>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;helm_release&#34; &#34;aws_load_balancer_controller&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  name</span>       <span class=o>=</span> <span class=s2>&#34;aws-load-balancer-controller&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  repository</span> <span class=o>=</span> <span class=s2>&#34;https://aws.github.io/eks-charts&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  chart</span>      <span class=o>=</span> <span class=s2>&#34;aws-load-balancer-controller&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  namespace</span>  <span class=o>=</span> <span class=s2>&#34;kube-system&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  version</span>    <span class=o>=</span> <span class=s2>&#34;1.8.1&#34;</span><span class=c1> # (Chart 1.8.1, LBC 2.8.1)
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=k>set</span> {
</span></span><span class=line><span class=cl><span class=n>    name</span>  <span class=o>=</span> <span class=s2>&#34;serviceAccount.annotations.eks\\.amazonaws\\.com/role-arn&#34;</span><span class=c1> # 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>    value</span> <span class=o>=</span> <span class=k>module</span><span class=p>.</span><span class=k>aws_load_balancer_controller_irsa_role</span><span class=p>.</span><span class=k>iam_role_arn</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  values</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=err>&lt;&lt;-</span><span class=k>EOF</span>
</span></span><span class=line><span class=cl>    <span class=k>nodeSelector</span><span class=err>:</span>
</span></span><span class=line><span class=cl>      <span class=k>role</span><span class=err>:</span> <span class=s2>&#34;ci-cd&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>EOF</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>Using the AWS EKS module and the helm provider, Terraform will also deploy the cluster&rsquo;s core addons (CoreDNS, Kube-Proxy, VPC-CNI, EBS CSI Driver, AWS Load Balancer Controller, ExternalDNS, External Secrets Operator).</p><p>These are addons that don&rsquo;t change that often (compared to the lifecycle of the main app and CI/CD tools), and that need to be in place before ArgoCD is deployed. While managing deployment via Terraform can be cumbersome down the line, setting these core addons at this stage strikes an acceptable balance with practicality and operability.</p><h4 id=populating-ssm-parameter-store>Populating SSM Parameter Store<a hidden class=anchor aria-hidden=true href=#populating-ssm-parameter-store>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=c1>###############################################################################
</span></span></span><span class=line><span class=cl><span class=c1># RDS - sonarqube
</span></span></span><span class=line><span class=cl><span class=c1>###############################################################################
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>resource</span> <span class=s2>&#34;random_password&#34; &#34;sonarqube_database_password&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  length</span>           <span class=o>=</span> <span class=m>28</span>
</span></span><span class=line><span class=cl><span class=n>  special</span>          <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl><span class=n>  override_special</span> <span class=o>=</span><span class=n> &#34;!#$%&amp;&#39;()+,-.</span><span class=o>=</span><span class=err>?^</span><span class=k>_</span><span class=err>~&#34;</span><span class=c1> # special character whitelist
</span></span></span><span class=line><span class=cl><span class=c1></span>}
</span></span></code></pre></div><p>At this stage data that needs to be accessed by ArgoCD such as RDS endpoints and passwords will be generated.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=hl><span class=lnt>13
</span></span><span class=lnt>14
</span><span class=lnt>15
</span><span class=hl><span class=lnt>16
</span></span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>locals</span> {
</span></span><span class=line><span class=cl><span class=n>  parameters</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>    &#34;sonar_rds_user&#34;</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>      value</span> <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>sonar_rds_user</span>
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl><span class=n>    &#34;sonar_rds_dbname&#34;</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>      value</span> <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>sonar_rds_dbname</span>
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl><span class=n>    &#34;sonar_rds_port&#34;</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>      value</span> <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>sonar_rds_port</span>
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl><span class=n>    &#34;sonar_rds_password&#34;</span> <span class=o>=</span> {
</span></span><span class="line hl"><span class=cl><span class=n>      value</span> <span class=o>=</span> <span class=k>random_password</span><span class=p>.</span><span class=k>sonarqube_database_password</span><span class=p>.</span><span class=k>result</span>
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl><span class=n>    &#34;sonar_rds_endpoint&#34;</span> <span class=o>=</span> {
</span></span><span class="line hl"><span class=cl><span class=n>      value</span> <span class=o>=</span> <span class=s2>&#34;jdbc:postgresql://${module.db_sonarqube.db_instance_endpoint}/${local.sonar_rds_dbname}&#34;</span><span class=c1> # `SONARQUBE_JDBC_URL` requires baked in interpolation # jdbc:postgresql://[host]:[port]/[database]
</span></span></span><span class=line><span class=cl><span class=c1></span>    }
</span></span></code></pre></td></tr></table></div></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>module</span> <span class=s2>&#34;ssm-parameter&#34;</span> {
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=n>source</span>   <span class=o>=</span> <span class=s2>&#34;terraform-aws-modules/ssm-parameter/aws&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  version</span>  <span class=o>=</span> <span class=s2>&#34;1.1.1&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=n>  for_each</span> <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>parameters</span>
</span></span><span class=line><span class=cl><span class=n>  name</span>     <span class=o>=</span> <span class=k>try</span><span class=p>(</span><span class=k>each</span><span class=p>.</span><span class=k>value</span><span class=p>.</span><span class=k>name</span><span class=p>,</span> <span class=k>each</span><span class=p>.</span><span class=k>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>And populated to the SSM Parameter Store, that will be used by External Secrets Operator later on.</p><h4 id=acm-and-cloudflare>ACM and Cloudflare<a hidden class=anchor aria-hidden=true href=#acm-and-cloudflare>#</a></h4><p>Since ALB cannot readily interface with cert-manager (at the time of writing) and this blog&rsquo;s TLD is already running GitHub pages, I decided to go with ACM and Cloudflare.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>module</span> <span class=s2>&#34;acm&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  source</span>  <span class=o>=</span> <span class=s2>&#34;terraform-aws-modules/acm/aws&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  version</span> <span class=o>=</span> <span class=s2>&#34;5.0.1&#34;</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>  # ACM cert for subdomains only
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  domain_name</span> <span class=o>=</span> <span class=s2>&#34;*.${local.domain}&#34;</span><span class=c1> # only for subdomains of *.tbalza.net, TLD is not included by default
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=n>  zone_id</span>     <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>CFL_ZONE_ID</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  validation_method</span> <span class=o>=</span> <span class=s2>&#34;DNS&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  validation_record_fqdns</span> <span class=o>=</span> <span class=k>cloudflare_record</span><span class=p>.</span><span class=k>validation</span><span class=p>[</span><span class=err>*</span><span class=p>].</span><span class=k>hostname</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  wait_for_validation</span>    <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl><span class=n>  create_route53_records</span> <span class=o>=</span> <span class=kt>false</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>The ACM module creates a wildcard certificate, that will be used when ExternalDNS dynamically creates the subdomains for the CI/CD addons and the main app.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>provider</span> <span class=s2>&#34;cloudflare&#34;</span> {
</span></span><span class="line hl"><span class=cl><span class=n>  api_token</span> <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>CFL_API_TOKEN</span>
</span></span><span class=line><span class=cl>}<span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># Validate generated ACM cert by creating validation domain record
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>resource</span> <span class=s2>&#34;cloudflare_record&#34; &#34;validation&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  count</span> <span class=o>=</span> <span class=k>length</span><span class=p>(</span><span class=k>module</span><span class=p>.</span><span class=k>acm</span><span class=p>.</span><span class=k>distinct_domain_names</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=n>  zone_id</span> <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>CFL_ZONE_ID</span>
</span></span><span class=line><span class=cl><span class=n>  name</span>    <span class=o>=</span> <span class=k>element</span><span class=p>(</span><span class=k>module</span><span class=p>.</span><span class=k>acm</span><span class=p>.</span><span class=k>validation_domains</span><span class=p>,</span> <span class=k>count</span><span class=p>.</span><span class=k>index</span><span class=p>)[</span><span class=s2>&#34;resource_record_name&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>  type</span>    <span class=o>=</span> <span class=k>element</span><span class=p>(</span><span class=k>module</span><span class=p>.</span><span class=k>acm</span><span class=p>.</span><span class=k>validation_domains</span><span class=p>,</span> <span class=k>count</span><span class=p>.</span><span class=k>index</span><span class=p>)[</span><span class=s2>&#34;resource_record_type&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>  value</span>   <span class=o>=</span> <span class=k>trimsuffix</span><span class=p>(</span><span class=k>element</span><span class=p>(</span><span class=k>module</span><span class=p>.</span><span class=k>acm</span><span class=p>.</span><span class=k>validation_domains</span><span class=p>,</span> <span class=k>count</span><span class=p>.</span><span class=k>index</span><span class=p>)[</span><span class=s2>&#34;resource_record_value&#34;], &#34;.&#34;</span><span class=p>)</span><span class=c1> # ensure no trailing periods that could disrupt DNS record creation
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  ttl</span>     <span class=o>=</span> <span class=m>60</span>
</span></span><span class=line><span class=cl><span class=n>  proxied</span> <span class=o>=</span> <span class=kt>false</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  allow_overwrite</span> <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>Using Cloudflare&rsquo;s provider, Terraform is able to generate the CNAME record that ACM requires in order to validate the certificate.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class="line hl"><span class=cl><span class=n>CFL_API_TOKEN</span>       <span class=o>=</span> <span class=s2>&#34;your-cloudflare-token&#34;</span>
</span></span><span class="line hl"><span class=cl><span class=n>CFL_ZONE_ID</span>         <span class=o>=</span> <span class=s2>&#34;your-cloudflare-zoneid&#34;</span>
</span></span><span class=line><span class=cl><span class=n>ARGOCD_GITHUB_TOKEN</span> <span class=o>=</span> <span class=s2>&#34;your-github-token&#34;</span>
</span></span><span class=line><span class=cl><span class=n>ARGOCD_GITHUB_USER</span>  <span class=o>=</span> <span class=s2>&#34;your-github-user&#34;</span>
</span></span></code></pre></div><p>The GitHub repo readme includes instructions and how to generate the necessary API keys, and have Terraform use them via <code>terraform.tfvars</code> without committing secrets to the repo with <code>.gitignore</code></p><blockquote><p>This whole initial provisioning cycle takes about ~25 minutes to complete.</p></blockquote><h3 id=bootstrapping-stage>Bootstrapping Stage<a hidden class=anchor aria-hidden=true href=#bootstrapping-stage>#</a></h3><p><img loading=lazy src=/posts/kubernetes_cicd/bootstrapping-stage.png alt=bootstrapping-stage></p><h4 id=separating-infra-and-app-state-files>Separating Infra and App State Files<a hidden class=anchor aria-hidden=true href=#separating-infra-and-app-state-files>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=err>└──</span> <span class=k>terraform</span>
</span></span><span class=line><span class=cl>    <span class=err>├──</span> <span class=m>01</span><span class=err>-</span><span class=k>eks</span><span class=err>-</span><span class=k>cluster</span><span class=c1>              # Terraform Infra Provisioning Stage
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>    <span class=err>│</span>   <span class=err>└──</span> <span class=k>terraform</span><span class=p>.</span><span class=k>tfstate</span>        
</span></span><span class=line><span class=cl>    <span class=err>└──</span> <span class=m>02</span><span class=err>-</span><span class=k>argocd</span><span class=c1>                   # Terraform ArgoCD Boostrap Stage
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>        <span class=err>└──</span> <span class=k>deploy_argocd</span><span class=p>.</span><span class=k>tf</span>
</span></span></code></pre></div><p>While installing core addons with Terraform can be an acceptable compromise, main application deployment should definitely be separated from infrastructure.</p><p>Applications like ArgoCD or Karpenter will create AWS resources outside of Terraform&rsquo;s purview. Separating the bootstrapping stage into its own state file prevents many issues down the line. One example is that it allows for resources on the cluster to be destroyed before destroying the cluster itself.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>data</span> <span class=s2>&#34;terraform_remote_state&#34; &#34;eks&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  backend</span> <span class=o>=</span> <span class=s2>&#34;local&#34;</span><span class=c1> # Pending remote set up to enable collaboration, state locking etc.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  config</span> <span class=o>=</span> {
</span></span><span class="line hl"><span class=cl><span class=n>    path</span> <span class=o>=</span> <span class=s2>&#34;${path.module}/../01-eks-cluster/terraform.tfstate&#34;</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>provider</span> <span class=s2>&#34;helm&#34;</span> {
</span></span><span class=line><span class=cl>  <span class=k>kubernetes</span> {
</span></span><span class="line hl"><span class=cl><span class=n>    host</span>                   <span class=o>=</span> <span class=k>data</span><span class=p>.</span><span class=k>terraform_remote_state</span><span class=p>.</span><span class=k>eks</span><span class=p>.</span><span class=k>outputs</span><span class=p>.</span><span class=k>cluster_endpoint</span>
</span></span><span class="line hl"><span class=cl><span class=n>    cluster_ca_certificate</span> <span class=o>=</span> <span class=k>base64decode</span><span class=p>(</span><span class=k>data</span><span class=p>.</span><span class=k>terraform_remote_state</span><span class=p>.</span><span class=k>eks</span><span class=p>.</span><span class=k>outputs</span><span class=p>.</span><span class=k>cluster_certificate_authority_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>exec</span> {
</span></span><span class=line><span class=cl><span class=n>      api_version</span> <span class=o>=</span> <span class=s2>&#34;client.authentication.k8s.io/v1beta1&#34; # /v1alpha1&#34;</span>
</span></span><span class="line hl"><span class=cl><span class=n>      args</span>        <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;eks&#34;, &#34;get-token&#34;, &#34;--cluster-name&#34;</span><span class=p>,</span> <span class=k>data</span><span class=p>.</span><span class=k>terraform_remote_state</span><span class=p>.</span><span class=k>eks</span><span class=p>.</span><span class=k>outputs</span><span class=p>.</span><span class=k>cluster_name</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>      command</span>     <span class=o>=</span> <span class=s2>&#34;aws&#34;</span>
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>Using the <code>terraform_remote_state</code> Data Source you can dynamically reference the infra state file outputs (in <code>/01-eks-cluster/terraform.tfstate</code>) to keep crucial information in sync and avoid manual data entry.</p><h4 id=bootstrapping-argocd>Bootstrapping ArgoCD<a hidden class=anchor aria-hidden=true href=#bootstrapping-argocd>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=err>┌──</span> <span class=k>argo</span><span class=err>-</span><span class=k>apps</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>├──</span> <span class=k>argocd</span>
</span></span><span class="line hl"><span class=cl><span class=err>│</span>   <span class=err>│</span>   <span class=err>├──</span> <span class=k>kustomization</span><span class=p>.</span><span class=k>yaml</span>
</span></span><span class="line hl"><span class=cl><span class=err>│</span>   <span class=err>│</span>   <span class=err>└──</span> <span class=k>values</span><span class=p>.</span><span class=k>yaml</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>├──</span> <span class=k>argocd</span><span class=err>-</span><span class=k>image</span><span class=err>-</span><span class=k>updater</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>├──</span> <span class=k>django</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>├──</span> <span class=k>eck</span><span class=err>-</span><span class=k>stack</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>├──</span> <span class=k>fluent</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>├──</span> <span class=k>jenkins</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>├──</span> <span class=k>prometheus</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>└──</span> <span class=k>sonarqube</span>
</span></span><span class=line><span class=cl><span class=err>├──</span> <span class=k>django</span><span class=err>-</span><span class=k>todo</span>
</span></span><span class=line><span class=cl><span class=err>└──</span> <span class=k>terraform</span>
</span></span><span class=line><span class=cl>    <span class=err>├──</span> <span class=m>01</span><span class=err>-</span><span class=k>eks</span><span class=err>-</span><span class=k>cluster</span>
</span></span><span class=line><span class=cl>    <span class=err>└──</span> <span class=m>02</span><span class=err>-</span><span class=k>argocd</span>
</span></span><span class="line hl"><span class=cl>        <span class=err>└──</span> <span class=k>deploy_argocd</span><span class=p>.</span><span class=k>tf</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>kustomize.config.k8s.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Kustomization</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>helmCharts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>argo-cd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>repo</span><span class=p>:</span><span class=w> </span><span class=l>https://argoproj.github.io/argo-helm</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>    </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>7.3.4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>releaseName</span><span class=p>:</span><span class=w> </span><span class=l>argo-cd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>argocd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>valuesFile</span><span class=p>:</span><span class=w> </span><span class=l>values.yaml</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>locals</span> {
</span></span><span class="line hl"><span class=cl><span class=n>  argocd_config</span> <span class=o>=</span> <span class=k>yamldecode</span><span class=p>(</span><span class=k>file</span><span class=p>(</span><span class=s2>&#34;${path.module}/../../argo-apps/argocd/kustomization.yaml&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>  argocd_helm_chart</span> <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>argocd_config</span><span class=p>.</span><span class=k>helmCharts</span><span class=p>[</span><span class=m>0</span><span class=p>]</span><span class=c1> # Access the first (or only) element in the list
</span></span></span><span class=line><span class=cl><span class=c1></span>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;helm_release&#34; &#34;argo_cd&#34;</span> {
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=n>name</span>       <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>argocd_helm_chart</span><span class=p>.</span><span class=k>name</span>
</span></span><span class=line><span class=cl><span class=n>  repository</span> <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>argocd_helm_chart</span><span class=p>.</span><span class=k>repo</span>
</span></span><span class=line><span class=cl><span class=n>  chart</span>      <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>argocd_helm_chart</span><span class=p>.</span><span class=k>releaseName</span>
</span></span><span class="line hl"><span class=cl><span class=n>  version</span>    <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>argocd_helm_chart</span><span class=p>.</span><span class=k>version</span>
</span></span><span class=line><span class=cl><span class=n>  namespace</span>  <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>argocd_helm_chart</span><span class=p>.</span><span class=k>namespace</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  create_namespace</span> <span class=o>=</span> <span class=kt>true</span>
</span></span><span class="line hl"><span class=cl><span class=n>  values</span> <span class=o>=</span> <span class=p>[</span><span class=k>file</span><span class=p>(</span><span class=s2>&#34;${path.module}/../../argo-apps/argocd/values.yaml&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>Additionally files outside Terraform&rsquo;s directory can also be referenced, so that the helm resource&rsquo;s values such as chart version and additional <code>values.yaml</code> overrides always point to the latest version, and the bootstrapping module does not have to be edited.</p><h4 id=applicationset>ApplicationSet<a hidden class=anchor aria-hidden=true href=#applicationset>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;kubectl_manifest&#34; &#34;example_applicationset&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  yaml_body</span> <span class=o>=</span> <span class=k>file</span><span class=p>(</span><span class=s2>&#34;${path.module}/../../argo-apps/argocd/applicationset.yaml&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>Applying the ApplicationSet is the last step Terraform will perform. This will make ArgoCD deploy the main app and the CI/CD addons.</p><h3 id=deployment-stage>Deployment Stage<a hidden class=anchor aria-hidden=true href=#deployment-stage>#</a></h3><p><img loading=lazy src=/posts/kubernetes_cicd/deployment-stage.png alt=deployment-stage></p><h4 id=applicationset-ii>ApplicationSet II<a hidden class=anchor aria-hidden=true href=#applicationset-ii>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=err>┌──</span> <span class=k>argo</span><span class=err>-</span><span class=k>apps</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>├──</span> <span class=k>argocd</span>
</span></span><span class="line hl"><span class=cl><span class=err>│</span>   <span class=err>│</span>   <span class=err>├──</span> <span class=k>applicationset</span><span class=p>.</span><span class=k>yaml</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>│</span>   <span class=err>├──</span> <span class=k>kustomization</span><span class=p>.</span><span class=k>yaml</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>├──</span> <span class=k>argocd</span><span class=err>-</span><span class=k>image</span><span class=err>-</span><span class=k>updater</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>│</span>   <span class=err>├──</span> <span class=k>kustomization</span><span class=p>.</span><span class=k>yaml</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>├──</span> <span class=k>django</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>│</span>   <span class=err>├──</span> <span class=k>kustomization</span><span class=p>.</span><span class=k>yaml</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>├──</span> <span class=k>eck</span><span class=err>-</span><span class=k>stack</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>│</span>   <span class=err>├──</span> <span class=k>elastic</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>│</span>   <span class=err>│</span>   <span class=err>├──</span> <span class=k>kustomization</span><span class=p>.</span><span class=k>yaml</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>│</span>   <span class=err>├──</span> <span class=k>kustomization</span><span class=p>.</span><span class=k>yaml</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>├──</span> <span class=k>fluent</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>│</span>   <span class=err>├──</span> <span class=k>kustomization</span><span class=p>.</span><span class=k>yaml</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>├──</span> <span class=k>jenkins</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>│</span>   <span class=err>├──</span> <span class=k>kustomization</span><span class=p>.</span><span class=k>yaml</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>├──</span> <span class=k>prometheus</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>│</span>   <span class=err>├──</span> <span class=k>kustomization</span><span class=p>.</span><span class=k>yaml</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>└──</span> <span class=k>sonarqube</span>
</span></span><span class=line><span class=cl><span class=err>│</span>       <span class=err>├──</span> <span class=k>kustomization</span><span class=p>.</span><span class=k>yaml</span>
</span></span><span class=line><span class=cl><span class=err>├──</span> <span class=k>django</span><span class=err>-</span><span class=k>todo</span>
</span></span><span class=line><span class=cl><span class=err>└──</span> <span class=k>terraform</span>
</span></span></code></pre></div><p>After the first stage succeeds, ArgoCD will &ldquo;take over&rdquo; and deploy and manage a fully configured CI/CD pipeline with Sonarqube, Jenkins, ArgoCD Image Updater, Django, ElasticSearch, Fluentbit, Kibana, Prometheus and Grafana.</p><p>To create each application resource dynamically, ArgoCD uses <code>applicationtset.yaml</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>argoproj.io/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ApplicationSet</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cluster-addons</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>argocd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>goTemplate</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>goTemplateOptions</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;missingkey=error&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>generators</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>git</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>        </span><span class=nt>repoURL</span><span class=p>:</span><span class=w> </span><span class=l>https://github.com/tbalza/kubernetes-cicd-zt.git</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>revision</span><span class=p>:</span><span class=w> </span><span class=l>HEAD</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>directories</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>          </span>- <span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>argo-apps/*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;{{.path.basename}}&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>project</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;default&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>source</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>        </span><span class=nt>repoURL</span><span class=p>:</span><span class=w> </span><span class=l>https://github.com/tbalza/kubernetes-cicd-zt.git</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>targetRevision</span><span class=p>:</span><span class=w> </span><span class=l>HEAD</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;{{.path.path}}&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>destination</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=l>https://kubernetes.default.svc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;{{.path.basename}}&#39;</span><span class=w>
</span></span></span></code></pre></div><p>The ApplicationSet Git generator creates applications based on files or directory structure of a Git repository. Here, it scans all subdirectories inside <code>argo-apps/*</code> that contain a <code>kustomization.yaml</code> to create an application and assign the corresponding name and namespace using Go templating.</p><h4 id=kustomize-and-helm>Kustomize and Helm<a hidden class=anchor aria-hidden=true href=#kustomize-and-helm>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=err>┌──</span> <span class=k>argo</span><span class=err>-</span><span class=k>apps</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>├──</span> <span class=k>argocd</span>
</span></span><span class="line hl"><span class=cl><span class=err>│</span>   <span class=err>│</span>   <span class=err>├──</span> <span class=k>kustomization</span><span class=p>.</span><span class=k>yaml</span>
</span></span><span class="line hl"><span class=cl><span class=err>│</span>   <span class=err>│</span>   <span class=err>└──</span> <span class=k>values</span><span class=p>.</span><span class=k>yaml</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>kustomize.config.k8s.io/v1beta1</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Kustomization</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>argocd</span><span class=w> </span><span class=c># required</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>helmCharts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>argo-cd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>repo</span><span class=p>:</span><span class=w> </span><span class=l>https://argoproj.github.io/argo-helm</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>7.3.4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>releaseName</span><span class=p>:</span><span class=w> </span><span class=l>argo-cd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>argocd</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>    </span><span class=nt>valuesFile</span><span class=p>:</span><span class=w> </span><span class=l>values.yaml</span><span class=w>
</span></span></span></code></pre></div><p>When the ApplicationSet loads, each <code>kustomization.yaml</code> from each of the app subdirectories, it will use Kustomize&rsquo;s <em>HelmChartInflationGenerator</em> (<code>helmCharts:</code>) to install upstream charts with helm, using local <code>values.yaml</code> as overrides.</p><p>This approach has several advantages for installing well established open source tools. It simplifies management because manifests don&rsquo;t need to be copied over and maintained. Pinning a version number ensures consistency in ephemeral deployments, and local <code>values.yaml</code> overrides provide flexibility in describing the particular configuration that suits our setup.</p><h4 id=additional-resources>Additional Resources<a hidden class=anchor aria-hidden=true href=#additional-resources>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=err>┌──</span> <span class=k>argo</span><span class=err>-</span><span class=k>apps</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>├──</span> <span class=k>argocd</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>│</span>   <span class=err>├──</span> <span class=k>applicationset</span><span class=p>.</span><span class=k>yaml</span>
</span></span><span class="line hl"><span class=cl><span class=err>│</span>   <span class=err>│</span>   <span class=err>├──</span> <span class=k>ingress</span><span class=p>.</span><span class=k>yaml</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>│</span>   <span class=err>├──</span> <span class=k>init</span><span class=err>-</span><span class=k>container</span><span class=p>.</span><span class=k>yaml</span>
</span></span><span class="line hl"><span class=cl><span class=err>│</span>   <span class=err>│</span>   <span class=err>├──</span> <span class=k>job</span><span class=p>.</span><span class=k>yaml</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>│</span>   <span class=err>├──</span> <span class=k>kustomization</span><span class=p>.</span><span class=k>yaml</span>
</span></span><span class="line hl"><span class=cl><span class=err>│</span>   <span class=err>│</span>   <span class=err>├──</span> <span class=k>rbac</span><span class=p>.</span><span class=k>yaml</span>
</span></span><span class="line hl"><span class=cl><span class=err>│</span>   <span class=err>│</span>   <span class=err>├──</span> <span class=k>secrets2</span><span class=p>.</span><span class=k>yaml</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>│</span>   <span class=err>└──</span> <span class=k>values</span><span class=p>.</span><span class=k>yaml</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>kustomize.config.k8s.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Kustomization</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>  </span>- <span class=l>job.yaml</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>  </span>- <span class=l>secrets2.yaml</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>  </span>- <span class=l>ingress.yaml</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>  </span>- <span class=l>rbac.yaml</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>external-secrets.io/v1beta1</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ExternalSecret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>argocd-secrets-global</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>argocd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>refreshInterval</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;0&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>secretStoreRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>argocd-secrets-global</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>SecretStore</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>target</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>argocd-secrets-global</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>creationPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Owner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>immutable</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>secretKey</span><span class=p>:</span><span class=w> </span><span class=l>ARGOCD_AWS_ACCOUNT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>remoteRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>argo_cd_aws_account_number</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>conversionStrategy</span><span class=p>:</span><span class=w> </span><span class=l>Default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>decodingStrategy</span><span class=p>:</span><span class=w> </span><span class=l>None</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>metadataPolicy</span><span class=p>:</span><span class=w> </span><span class=l>None</span><span class=w>
</span></span></span></code></pre></div><p>On top of that, we can also apply custom manifests, that will merge seamlessly before generating the app that started from an upstream helm chart.</p><p>Configurations that are not natively supported by the upstream chart can be amended using resources or even patches get around chart definitions clashing.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=err>│</span>   <span class=err>├──</span> <span class=k>jenkins</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>│</span>   <span class=err>├──</span> <span class=k>kustomization</span><span class=p>.</span><span class=k>yaml</span>
</span></span><span class="line hl"><span class=cl><span class=err>│</span>   <span class=err>│</span>   <span class=err>├──</span> <span class=k>pipeline1</span><span class=p>.</span><span class=k>groovy</span>
</span></span><span class="line hl"><span class=cl><span class=err>│</span>   <span class=err>│</span>   <span class=err>└──</span> <span class=k>values</span><span class=p>.</span><span class=k>yaml</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>kustomize.config.k8s.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Kustomization</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>configMapGenerator</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>jenkins-scripts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>files</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>    </span>- <span class=l>pipeline1.groovy</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span><span class=nt>JCasC</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>configScripts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>job-dsl</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>        jobs:
</span></span></span><span class=line><span class=cl><span class=sd>          - script: &gt;
</span></span></span><span class=line><span class=cl><span class=sd>              pipelineJob(&#39;build-django&#39;) {
</span></span></span><span class=line><span class=cl><span class=sd>                definition {
</span></span></span><span class=line><span class=cl><span class=sd>                  cps {
</span></span></span><span class="line hl"><span class=cl><span class=sd>                    script(new File(&#39;/var/jenkins_home/groovy_scripts/pipeline1.groovy&#39;).text)
</span></span></span><span class=line><span class=cl><span class=sd>                    sandbox(true)
</span></span></span><span class=line><span class=cl><span class=sd>                  }
</span></span></span><span class=line><span class=cl><span class=sd>                }
</span></span></span><span class=line><span class=cl><span class=sd>              }</span><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>persistence</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>jenkins-groovy-scripts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>configMap</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>jenkins-scripts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>mounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/var/jenkins_home/groovy_scripts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>jenkins-groovy-scripts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>readOnly</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span></code></pre></div><p>Finally, we can also manage Kubernetes objects declaratively using <code>configMapGenerator:</code> which allows us, in this case, to abstract the Jenkins pipeline <code>pipeline1.groovy</code> from <code>values.yaml</code>. This keeps the main configuration lean, and allows us to version control and manage multiple complex pipelines with ease.</p><p>The end result is a streamlined way of representing the entirety of the apps configuration elements in the code base.</p><h4 id=cmp>CMP<a hidden class=anchor aria-hidden=true href=#cmp>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=err>┌──</span> <span class=k>argo</span><span class=err>-</span><span class=k>apps</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>├──</span> <span class=k>argocd</span>
</span></span><span class="line hl"><span class=cl><span class=err>│</span>   <span class=err>│</span>   <span class=err>└──</span> <span class=k>values</span><span class=p>.</span><span class=k>yaml</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>cmp</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>create</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>plugins</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>substitution</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>generate</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;/bin/sh&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;-c&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=p>|</span><span class=sd>
</span></span></span><span class="line hl"><span class=cl><span class=sd>              AVAILABLE_VARS=$(env | cut -d &#34;=&#34; -f 1 | awk &#39;{print &#34;$&#34;$1}&#39; | tr &#34;\n&#34; &#34; &#34;)
</span></span></span><span class="line hl"><span class=cl><span class=sd>              kustomize build --load-restrictor LoadRestrictionsNone --enable-helm | envsubst &#34;$AVAILABLE_VARS&#34;</span><span class=w>              
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>    </span><span class=nt>eks.amazonaws.com/role-arn</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;arn:aws:iam::${ARGOCD_AWS_ACCOUNT}:role/ImageUpdaterRole&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>argocd-image-updater</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>argocd</span><span class=w>
</span></span></span></code></pre></div><p>With a Config Management Plugin, we can enhance Argo CD&rsquo;s default capabilities to include <code>envsubst</code> during app builds. While Kustomize allows for the inclusion of environment variables in the pods resulting from an installation, it cannot reference <em>external</em> variables that aren&rsquo;t hardcoded in its own configuration.</p><p>To address this, we first use <code>AVAILABLE_VARS=$(env | cut -d "=" -f 1 | awk '{print "$"$1}' | tr "\n" " ")</code> to preload all defined ENV vars necessary for Kustomization, ensuring that other scripts&rsquo; variables are not replaced with blanks unintentionally.</p><p>Right after, the command <code>kustomize build | envsubst "$AVAILABLE_VARS"</code> executes for each app, dynamically substituting all pre-defined variables, such as the AWS Account Number <code>${ARGOCD_AWS_ACCOUNT}</code> which would typically be static.</p><p>Although this approach might be seen as a GitOps anti-pattern, it is a practical solution in scenarios managing numerous AWS accounts, offering a balanced approach to automation.</p><h4 id=externaldns>ExternalDNS<a hidden class=anchor aria-hidden=true href=#externaldns>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=err>┌──</span> <span class=k>argo</span><span class=err>-</span><span class=k>apps</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>├──</span> <span class=k>argocd</span>
</span></span><span class="line hl"><span class=cl><span class=err>│</span>   <span class=err>│</span>   <span class=err>└──</span> <span class=k>ingress</span><span class=p>.</span><span class=k>yaml</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Ingress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>argo-cd-argocd-server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>argocd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>    </span><span class=nt>external-dns.alpha.kubernetes.io/hostname</span><span class=p>:</span><span class=w> </span><span class=l>argocd.${ARGOCD_APP_DOMAIN}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ingressClassName</span><span class=p>:</span><span class=w> </span><span class=l>alb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>  </span>- <span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>argocd.${ARGOCD_APP_DOMAIN}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>pathType</span><span class=p>:</span><span class=w> </span><span class=l>Prefix</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>backend</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>argo-cd-argocd-server-grpc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>port</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>pathType</span><span class=p>:</span><span class=w> </span><span class=l>Prefix</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>backend</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>argo-cd-argocd-server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>port</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span></code></pre></div><p>Each of the apps with an ingress resource has a <code>external-dns.alpha.kubernetes.io/hostname</code> annotation, which triggers ExternalDNS (installed in the provisioning stage), to automatically create the CNAME record corresponding to the app.</p><p>This could be templated further with Kustomize <code>patches:</code> for example, with a DEV environment where developers would have permissions to freely create any subdomain under <code>*.development.${ARGOCD_APP_DOMAIN}</code> for their testing purposes&ndash;potentially speeding up deliveries.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;kubectl_manifest&#34; &#34;cloudflare_api_key&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  yaml_body</span> <span class=o>=</span> <span class=err>&lt;&lt;-</span><span class=k>YAML</span>
</span></span><span class=line><span class=cl><span class=k>apiVersion</span><span class=err>:</span> <span class=k>v1</span>
</span></span><span class=line><span class=cl><span class=k>kind</span><span class=err>:</span> <span class=k>Secret</span>
</span></span><span class=line><span class=cl><span class=k>metadata</span><span class=err>:</span>
</span></span><span class=line><span class=cl>  <span class=k>name</span><span class=err>:</span> <span class=k>cloudflare</span><span class=err>-</span><span class=k>api</span><span class=err>-</span><span class=k>token</span>
</span></span><span class=line><span class=cl>  <span class=k>namespace</span><span class=err>:</span> <span class=k>kube</span><span class=err>-</span><span class=k>system</span>
</span></span><span class=line><span class=cl><span class=k>type</span><span class=err>:</span> <span class=k>Opaque</span>
</span></span><span class=line><span class=cl><span class=k>data</span><span class=err>:</span>
</span></span><span class="line hl"><span class=cl>  <span class=k>apiToken</span><span class=err>:</span> <span class=si>${</span><span class=err>base64encode</span><span class=p>(</span><span class=err>var</span><span class=p>.</span><span class=err>CFL_API_TOKEN</span><span class=p>)</span><span class=si>}</span>
</span></span><span class=line><span class=cl>  <span class=k>YAML</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>ExternalDNS uses the API Token defined earlier in <code>/terraform/01-eks-cluster/setup_up_eks_cluster.tf</code> with <code>terraform.tfvars</code> to interface with the Cloudflare API and create the CNAME records.</p><h4 id=rollingsync>RollingSync<a hidden class=anchor aria-hidden=true href=#rollingsync>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=err>┌──</span> <span class=k>argo</span><span class=err>-</span><span class=k>apps</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>├──</span> <span class=k>argocd</span>
</span></span><span class="line hl"><span class=cl><span class=err>│</span>   <span class=err>│</span>   <span class=err>└──</span> <span class=k>applicationset</span><span class=p>.</span><span class=k>yaml</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>├──</span> <span class=k>argocd</span><span class=err>-</span><span class=k>image</span><span class=err>-</span><span class=k>updater</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>├──</span> <span class=k>django</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>├──</span> <span class=k>eck</span><span class=err>-</span><span class=k>stack</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>├──</span> <span class=k>fluent</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>├──</span> <span class=k>jenkins</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>├──</span> <span class=k>prometheus</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>└──</span> <span class=k>sonarqube</span>
</span></span><span class=line><span class=cl><span class=err>├──</span> <span class=k>django</span><span class=err>-</span><span class=k>todo</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>argoproj.io/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ApplicationSet</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cluster-addons</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>argocd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>strategy</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>RollingSync</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>rollingSync</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>steps</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>            </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=nt>syncorder # Label defined in appset template:,metadata:,labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>- <span class=l>argocd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>syncorder</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>- <span class=l>argocd-image-updater</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>- <span class=l>sonarqube</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>syncorder</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>- <span class=l>django</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>- <span class=l>jenkins</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>syncorder</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>- <span class=l>eck-stack</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>- <span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>syncorder</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>- <span class=l>fluent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;{{.path.basename}}&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>        </span><span class=nt>syncorder</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;{{.path.basename}}&#39;</span><span class=w> </span><span class=c># Label for rollingSync matchExpressions</span><span class=w>
</span></span></span></code></pre></div><p>ArgoCD&rsquo;s RollingSync allows us to sequentially deploy applications without requiring user input:</p><ol><li><strong>ArgoCD:</strong> is deployed first by itself, as it needs to restart with <code>job.yaml</code> in order to correctly load ENV vars for CMP value substitutions in other apps. It&rsquo;s able to use dynamic values initially with Terraform&rsquo;s bootstrap stage.</li><li><strong>Image Updater, SonarQube:</strong> SonarQube needs to be ready by the time the Jenkins pipeline is executed.</li><li><strong>Django, Jenkins:</strong> Jenkins then goes and starts to build the first image from <code>/django-todo</code>, and triggers a SonarQube analysis. Django is deployed, but ArgoCD detects it doesn&rsquo;t have a valid image, so it is left in a &ldquo;Progressing&rdquo; state, until Image Updater detects the ECR build, and modifies the new image tag in <code>/argo-apps/django/kustomization.yaml</code>&ndash;finally prompting ArgoCD to auto-sync Django.</li><li><strong>Elasticsearch/Kibana, Prometheus/Grafana:</strong> Observability tools are then deployed.</li><li><strong>FluentBit:</strong> FluentBit needs to run after ES, in order for it to seamlessly create the index without having to restart the Elasticsearch pod.</li></ol><h3 id=conclusions>Conclusions<a hidden class=anchor aria-hidden=true href=#conclusions>#</a></h3><p>We&rsquo;ve covered different automation techniques using well-established open-source tools to successfully provision and deploy a complete CI/CD pipeline in a Kubernetes cluster.</p><p>These patterns align with the DevOps principles of efficiency and reliability, and also establish a single source of truth. By defining configurations in a declarative fashion and maintaining a fully automated pipeline, we can improve the speed of deliveries across environments and reduce the potential for human error.</p><p><strong>Areas for improvement</strong></p><ul><li><strong>GitHub Actions</strong>: Automate initial project setup (not just Provisioning and Deployment)</li><li><strong>Security:</strong> Scope Access Entries, IAM Policies/Roles/Security Groups, SSM, to follow the principle of least privilege. Non-root Django container</li><li><strong>CI:</strong> Code linting. CI tests. ECR Docker Caching</li><li><strong>Multi Environment Setup:</strong> Implement TF workspaces with .tfvars to enable Dev, Staging, QA, Prod, environments. Implement remote state management</li><li><strong>SSO:</strong> Configure Single Sign On for user management, and integrate with IAM permissions</li><li><strong>Software Development Life Cycle:</strong> Implement examples with trunk-based development and tags</li><li><strong>Repo Structure:</strong> Fix long .tf files, create directories for customer facing apps along with corresponding ApplicationSets</li><li><strong>Crucial Addons:</strong> Install backup/DR solutions, autoscaling, cost tracking, mono repo management</li></ul><p><strong>Looking Ahead</strong></p><p>For our next post, we&rsquo;ll explore how implementing aspects of multi-environment setups and the software development lifecycle can make this PoC move closer to real-world production scenarios.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://tbalza.net/tags/kubernetes/>Kubernetes</a></li><li><a href=https://tbalza.net/tags/argocd/>Argocd</a></li><li><a href=https://tbalza.net/tags/jenkins/>Jenkins</a></li><li><a href=https://tbalza.net/tags/elk/>Elk</a></li><li><a href=https://tbalza.net/tags/prometheus/>Prometheus</a></li><li><a href=https://tbalza.net/tags/django/>Django</a></li><li><a href=https://tbalza.net/tags/sonarqube/>Sonarqube</a></li><li><a href=https://tbalza.net/tags/terraform/>Terraform</a></li><li><a href=https://tbalza.net/tags/fluentbit/>Fluentbit</a></li><li><a href=https://tbalza.net/tags/gitops/>Gitops</a></li><li><a href=https://tbalza.net/tags/eks/>Eks</a></li><li><a href=https://tbalza.net/tags/helm/>Helm</a></li><li><a href=https://tbalza.net/tags/kustomize/>Kustomize</a></li></ul><nav class=paginav><a class=next href=https://tbalza.net/leveraging-docker-and-selenium-for-efficient-appointment-checking/><span class=title>Next »</span><br><span>Leveraging Docker and Selenium for Efficient Appointment Checking</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://tbalza.net/>Tomas Balza</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>